This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
package.json
public/app/index.html
public/ghid.html
public/login.html
public/resources/css/ghid.css
public/resources/css/styles.css
public/resources/files/anexe.docx
public/resources/img/logo.png
public/resources/js/api.js
public/resources/js/shell.js
public/resources/photos/7/7777777777777/1.webp
public/resources/photos/7/7777777777777/2.webp
public/resources/photos/7/7777777777777/3.webp
public/resources/photos/7/7777777777777/4.webp
public/resources/temp_uploads/628cba650d9c65d5556e9a05aed6376a
public/resources/temp_uploads/7f370633a44c9292dca613cbfe1bf479
public/resources/temp_uploads/974021203f853f3ab6d59ffea54687b5
src/config.js
src/db.js
src/modules/admin/client.js
src/modules/admin/router.js
src/modules/auth/client.js
src/modules/auth/router.js
src/modules/detinut-add/client.js
src/modules/detinut-add/router.js
src/modules/health/router.js
src/modules/inmate/complici/client.js
src/modules/inmate/complici/router.js
src/modules/inmate/education/client.js
src/modules/inmate/education/router.js
src/modules/inmate/garantii/client.js
src/modules/inmate/garantii/router.js
src/modules/inmate/hotariri/client.js
src/modules/inmate/hotariri/router.js
src/modules/inmate/medical/client.js
src/modules/inmate/medical/router.js
src/modules/inmate/profile/client.js
src/modules/inmate/profile/router.js
src/modules/inmate/profile/shell.js
src/modules/inmate/rude/client.js
src/modules/inmate/rude/router.js
src/modules/reports/client.js
src/modules/reports/router.js
src/modules/search/client.js
src/modules/search/router.js
src/modules/user/client.js
src/modules/user/nav.router.js
src/modules/user/profile.router.js
src/modulesConfig.js
src/server.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
node_modules
build
npm-debug.log
.env
.DS_Store
</file>

<file path="package.json">
{
  "name": "prison-app-login",
  "version": "1.0.0",
  "main": "src/server.js",
  "scripts": {
    "start": "node src/server.js"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "express": "^4.21.2",
    "multer": "^2.0.2",
    "oracledb": "^6.5.0",
    "sharp": "^0.34.5"
  }
}
</file>

<file path="public/app/index.html">
<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplica»õie ‚Äì Panou principal</title>
  <link rel="stylesheet" href="../resources/css/styles.css" />
</head>
<body>
  <header class="topbar">
  <div class="topbar-left">
    <span class="app-logo">SISTEM AUTOMATIZAT "RPRAC"</span>
  </div>
  <nav class="topbar-nav" id="navLinks">
    </nav>
  <div class="topbar-right">
    <span id="userInfo" class="user-info"></span>
    <button id="logoutBtn" class="btn-ghost">Deconectare</button>
  </div>
</header>

  <main class="app-main">
    <section class="app-content" id="appContent">
      <h1 class="app-title">Bine ai venit</h1>
      <p class="app-subtitle">
        SelecteazƒÉ un modul din meniul de sus.
      </p>
    </section>
  </main>

  <script src="/resources/js/api.js" defer></script>
  <script src="/modules/search/client.js" defer></script>
  <script src="/modules/reports/client.js" defer></script>
  <script src="/modules/user/client.js" defer></script>
  <script src="/modules/admin/client.js" defer></script>
  <script src="/modules/detinut-add/client.js" defer></script> 
  <script src="/modules/inmate/profile/shell.js" defer></script> 
  <script src="/resources/js/shell.js" defer></script>
</body>
</html>
</file>

<file path="public/ghid.html">
<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <title>Ghid de √Ænregistrare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="resources/css/ghid.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Hero -->
      <header class="hero">
        <span class="kicker">Ghid rapid</span>
        <h1>√énregistrare pe platformƒÉ</h1>
        <p class="lead">
          Parcurge cei patru pa»ôi de mai jos. Ghid conform
          <strong>Dispozi»õiei 11D / 2025</strong>.
        </p>

        <div class="progress" aria-hidden="true">
          <div class="dot"><span class="dot__c"><span>1</span></span> DescƒÉrcare</div>
          <div class="dot"><span class="dot__c"><span>2</span></span> Completare</div>
          <div class="dot"><span class="dot__c"><span>3</span></span> Semnare</div>
          <div class="dot"><span class="dot__c"><span>4</span></span> Expediere</div>
        </div>
      </header>

      <!-- Steps -->
      <section class="steps">
        <div class="grid">
          <!-- Pasul 1 -->
          <article class="step" id="pas1">
            <h3><span class="badge">1</span> DescarcƒÉ anexa</h3>
            <p>Fi»ôierul standard pentru ini»õierea accesului la baza de date.</p>
            <div class="actions center">
              <a class="btn btn-primary" href="/resources/files/anexe.docx" download>
                ‚¨áÔ∏è DescarcƒÉ anexa (.docx)
              </a>
            </div>
            <div class="hint">DacƒÉ nu se descarcƒÉ, click dreapta ‚Üí ‚ÄûSave link as‚Ä¶‚Äù.</div>
          </article>

          <!-- Pasul 2 -->
          <article class="step" id="pas2">
            <h3><span class="badge">2</span> CompleteazƒÉ corect</h3>
            <p>CompleteazƒÉ c√¢mpurile obligatorii: institu»õie, nume, IDNP, rol.</p>
            <div class="callout">
              <strong>Tips:</strong> folose»ôte diacritice »ôi formatul de datƒÉ
              <span class="mono">zz.ll.aaaa</span>.
            </div>
          </article>

          <!-- Pasul 3 -->
          <article class="step" id="pas3">
            <h3><span class="badge">3</span> SemneazƒÉ electronic</h3>
            <p>
              AplicƒÉ semnƒÉturƒÉ electronicƒÉ calificatƒÉ. SalveazƒÉ ca
              <span class="mono">.pdf</span> sau <span class="mono">.p7m</span>.
            </p>
            <div class="callout">
              <strong>Nume fi»ôier:</strong>
              <span class="mono">Anexa1_Nume_Prenume_Data.pdf</span>
            </div>
          </article>

          <!-- Pasul 4 -->
          <article class="step" id="pas4">
            <h3><span class="badge">4</span> ExpediazƒÉ documentul</h3>
            <p>
              Trimite la
              <span class="mono" id="email">anp.siarprac@anp.gov.md</span>
              »ôi include nume, institu»õie, telefon.
            </p>
            <div class="actions center">
              <button class="btn btn-ghost" id="copyMail" type="button">
                üìã CopiazƒÉ adresa
              </button>
            </div>
            <div class="hint">Ata»ôeazƒÉ documentul semnat (recomandat &lt; 10 MB).</div>
          </article>
        </div>
      </section>

      <!-- Footer minimalist -->
      <div class="foot" id="confirm">
        <small>√éntrebƒÉri? Scrie-ne »ôi √Æ»õi rƒÉspundem rapid.</small>
        <div class="actions center">
          <a class="btn btn-ghost" href="/">‚üµ Pagina principalƒÉ</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Adresa a fost copiatƒÉ √Æn clipboard.</div>

  <script>
    (function(){
      var btn   = document.getElementById('copyMail');
      var toast = document.getElementById('toast');
      var emailNode = document.getElementById('email');

      function showToast(){
        toast.className = 'toast show';
        setTimeout(function(){ toast.className = 'toast'; }, 1800);
      }
      function fallbackCopy(text){
        var ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch(e){}
        document.body.removeChild(ta);
        showToast();
      }

      if(btn && emailNode){
        btn.addEventListener('click', function(){
          var email = emailNode.innerText || emailNode.textContent;
          if (navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(email).then(showToast, function(){ fallbackCopy(email); });
          } else {
            fallbackCopy(email);
          }
        });
      }
    })();
  </script>
</body>
</html>
</file>

<file path="public/login.html">
<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../resources/css/styles.css" />
  <title>Autentificare - Prison App</title>
</head>
<body>

  <div class="auth-page">
    <!-- Wrapper to vertically stack Announcement + Login Card -->
    <div class="auth-container">
      
      <!-- System Announcement (Centered above card) -->
      <div id="systemAnnouncement" class="announcement-card" style="display: none;">
        <div class="ann-icon-wrapper">
          <span class="ann-icon">üì¢</span>
        </div>
        <div class="ann-content">
          <h4 class="ann-title">Anun»õ Important</h4>
          <p id="sysAnnText" class="ann-text"></p>
        </div>
      </div>

      <div class="auth-card">
        <!-- LOGO -->
        <div class="auth-logo">
          <img src="/resources/img/logo.png" alt="Sigla ANP" />
        </div>

        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label for="username">Utilizator</label>
            <input
              id="username"
              name="username"
              type="text"
              autocomplete="off"
              required
            />
          </div>
          <div class="form-group">
            <label for="password">ParolƒÉ</label>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="off"
              required
            />
          </div>
          <div class="form-group">
            <label for="motivation">Motiv acces</label>
            <select id="motivation" name="motivation" required>
              <option value="">-- Selecta»õi motivul --</option>
            </select>
          </div>

          <div class="form-footer">
            <button type="submit" id="loginBtn" class="btn-primary">
              Autentificare
            </button>
          </div>
          
          <div class="auth-extra">
            <button type="button" id="guideBtn" class="btn-ghost full-width">
              Ghid de √Ænregistrare utilizatori
            </button>
          </div>
        
          <p id="loginMessage" class="form-message"></p>
        </form>
      </div>
    </div>
  </div>
  <script src="/resources/js/api.js" defer></script>
  <script src="/modules/auth/client.js" defer></script>
</body>
</html>
</file>

<file path="public/resources/css/ghid.css">
*,
*::before,
*::after {
  box-sizing: border-box;
}

html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top left, #e0e7ff 0, #f5f7fb 45%);
  color: #111827;
}

.wrap {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.card {
  background-color: #ffffff;
  border-radius: 16px;
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
  border: 1px solid rgba(148, 163, 184, 0.4);
  max-width: 960px;
  width: 100%;
  padding: 20px 18px 18px;
}

.hero .kicker {
  display: inline-block;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #6b7280;
  margin-bottom: 4px;
}

.hero h1 {
  margin: 0 0 4px;
  font-size: 1.6rem;
}

.hero .lead {
  margin: 0 0 14px;
  font-size: 0.95rem;
  color: #4b5563;
}

.progress {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 0.8rem;
  color: #4b5563;
}

.dot {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.dot__c {
  width: 20px;
  height: 20px;
  border-radius: 999px;
  background-color: #2563eb;
  color: #fff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
}

.steps {
  margin-top: 18px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 14px 16px;
}

.step {
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  padding: 10px 12px 12px;
  background-color: #f9fafb;
  font-size: 0.92rem;
}

.step h3 {
  margin: 0 0 6px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 999px;
  background-color: #111827;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
}

.callout {
  margin-top: 6px;
  padding: 6px 8px;
  border-radius: 8px;
  background-color: #eff6ff;
  color: #1d4ed8;
  font-size: 0.85rem;
}

.mono {
  font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.actions {
  margin-top: 8px;
}

.actions.center {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.btn {
  border-radius: 999px;
  border: 1px solid transparent;
  padding: 6px 14px;
  font-size: 0.9rem;
  font-weight: 500;
  text-decoration: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-primary {
  background: linear-gradient(to right, #2563eb, #1d4ed8);
  color: #fff;
  box-shadow: 0 12px 25px rgba(37, 99, 235, 0.4);
}

.btn-ghost {
  background-color: #fff;
  border-color: #d1d5db;
  color: #374151;
}

.btn-ghost:hover {
  background-color: #f3f4f6;
}

.hint {
  margin-top: 6px;
  font-size: 0.8rem;
  color: #6b7280;
}

.foot {
  margin-top: 16px;
  border-top: 1px solid #e5e7eb;
  padding-top: 8px;
  text-align: center;
  font-size: 0.85rem;
  color: #6b7280;
}

/* Toast */

.toast {
  position: fixed;
  left: 50%;
  bottom: 16px;
  transform: translateX(-50%);
  background-color: #111827;
  color: #f9fafb;
  padding: 8px 14px;
  border-radius: 999px;
  font-size: 0.85rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 180ms ease-out, transform 180ms ease-out;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(-4px);
}

@media (max-width: 800px) {
  .card {
    padding: 18px 14px 14px;
  }
  .grid {
    grid-template-columns: minmax(0, 1fr);
  }
}
</file>

<file path="public/resources/css/styles.css">
:root {
  --bg-page: #f5f7fb;
  --bg-card: #ffffff;
  --border-color: #d6d9e2;
  --text-main: #1e2230;
  --text-muted: #6b7280;
  --primary: #1d4ed8;
  --primary-hover: #1e40af;
  --danger: #b91c1c;
  --success: #15803d;
  --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
  --radius-card: 14px;
  --radius-input: 8px;
  --transition-fast: 150ms ease-out;
  --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html,
body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  font-family: var(--font-main);
  color: var(--text-main);
}

body {
  background: radial-gradient(circle at top left, #e0e7ff 0, #f5f7fb 45%);
}

/* =========================
   LOGIN PAGE LAYOUT
   ========================= */

.auth-page {
  min-height: 100vh;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

/* Container to stack Announcement + Card */
.auth-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 100%;
  max-width: 420px;
  /* Ensure it centers properly in the flex parent */
  margin: auto;
}

/* --- ANNOUNCEMENT CARD --- */
.announcement-card {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
  display: flex;
  align-items: flex-start;
  gap: 14px;
  animation: slideDown 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.ann-icon-wrapper {
  background: rgba(255, 255, 255, 0.2);
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.ann-icon {
  font-size: 1.25rem;
}

.ann-content {
  flex: 1;
}

.ann-title {
  margin: 0 0 4px 0;
  font-size: 0.95rem;      /* Increased slightly */
  font-weight: 800;        /* Extra Bold */
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #ffffff;          /* Force White */
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* Soft shadow for contrast */
}

.ann-text {
  margin: 0;
  font-size: 1.05rem;      /* Larger text */
  line-height: 1.5;
  font-weight: 600;        /* Semi-Bold */
  color: #ffffff;          /* Force White */
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- LOGIN CARD --- */
.auth-card {
  background-color: var(--bg-card);
  border-radius: var(--radius-card);
  box-shadow: var(--shadow-soft);
  padding: 28px 26px 24px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  width: 100%;
}

.auth-logo {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.auth-logo img {
  max-width: 400px; /* Constrain size */
  max-height: 320px;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
}

.auth-extra {
  margin-top: 12px;
  margin-bottom: 6px;
  display: flex;
  justify-content: center;
}

.auth-title {
  margin: 0 0 4px;
  font-size: 1.4rem;
  font-weight: 600;
}

.auth-subtitle {
  margin: 0 0 20px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-size: 0.9rem;
  font-weight: 500;
}

.form-group input,
.form-group select {
  border-radius: var(--radius-input);
  border: 1px solid var(--border-color);
  padding: 10px 12px;
  font-size: 0.95rem;
  outline: none;
  background-color: #f9fafb;
  transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  background-color: #ffffff;
}

.form-footer {
  margin-top: 8px;
}

.btn-primary {
  width: 100%;
  border-radius: 8px;
  border: none;
  padding: 12px 14px;
  font-size: 1rem;
  font-weight: 600;
  color: #ffffff;
  background: linear-gradient(to right, var(--primary), #2563eb);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(to right, var(--primary-hover), #1d4ed8);
  transform: translateY(-1px);
  box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-ghost {
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  padding: 8px 14px;
  font-size: 0.9rem;
  background-color: #ffffff;
  color: #64748b;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-ghost:hover {
  background-color: #f8fafc;
  color: #334155;
  border-color: #cbd5e1;
}

.btn-ghost.full-width {
  width: 100%;
}

.form-message {
  margin-top: 10px;
  min-height: 1.2em;
  font-size: 0.9rem;
  text-align: center;
}

.form-message.error {
  color: var(--danger);
  background: #fef2f2;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #fee2e2;
}

.form-message.success {
  color: var(--success);
  background: #f0fdf4;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #dcfce7;
}

/* =========================
   ADMIN PAGE
   ========================= */

.admin-page {
  display: flex;
  flex-direction: column;
  gap: 24px;
  max-width: 1600px;
  width: 95%;        
  margin: 0 auto;
}

.admin-title {
  font-size: 1.75rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  color: #111827;
  letter-spacing: -0.02em;
}

/* Modern Tabs */
.admin-tabs {
  display: flex;
  gap: 24px;
  border-bottom: 2px solid #e5e7eb;
  margin-bottom: 8px;
}

.admin-tab-btn {
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  padding: 12px 4px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: -2px;
}

.admin-tab-btn:hover {
  color: var(--primary);
}

.admin-tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  font-weight: 600;
}

/* Admin Panels */
.admin-panel {
  background-color: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  border: 1px solid #e2e8f0;
  padding: 24px;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.admin-panel h2 {
  margin-top: 0;
  margin-bottom: 20px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Forms & Grids */
.admin-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.btn-danger {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
}
.btn-danger:hover {
  background-color: #fecaca;
  color: #7f1d1d;
}

.admin-grid-2 label {
  margin-bottom: 6px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #64748b;
}

.admin-grid-2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.admin-form label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: #4b5563;
  margin-bottom: 4px;
}

.admin-form input[type="text"],
.admin-form input[type="password"],
.admin-form select,
.admin-form textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background-color: #fff;
  font-size: 0.9rem;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.admin-form input:focus,
.admin-form select:focus,
.admin-form textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  outline: none;
}

/* Messages / Alerts */
.admin-msg {
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 0.9rem;
  margin-top: 12px;
  display: none;
}

.admin-msg:not(:empty) {
  display: block;
}

.admin-msg.success {
  background-color: #ecfdf5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.admin-msg.error {
  background-color: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* Search Results - User Cards */
.admin-results {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.admin-user-card {
  background: #ffffff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.admin-user-card h3 {
  margin-top: 0;
  padding-bottom: 10px;
  border-bottom: 1px solid #f1f5f9;
  font-size: 1.1rem;
  color: #0f172a;
}

.admin-card-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 8px;
  border-top: 1px solid #f1f5f9;
  padding-top: 16px;
}

.admin-user-card:hover {
  border-color: #cbd5e1;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.admin-user-title {
  font-size: 1rem;
  color: #0f172a;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 8px;
  margin-bottom: 12px;
}

/* Rights Table */
.rights-wrap {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 16px;
}

.rights-top {
  padding: 12px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.rights-filter {
  padding: 6px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.85rem;
  min-width: 200px;
}

.rights-bulk button {
  background: #fff;
  border: 1px solid #d1d5db;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.75rem;
  cursor: pointer;
  font-weight: 500;
}
.rights-bulk button:hover { background: #f3f4f6; }

.rights-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.rights-table th {
  background: #f1f5f9;
  text-align: left;
  padding: 10px 12px;
  font-weight: 600;
  color: #475569;
  text-transform: uppercase;
  font-size: 0.7rem;
  letter-spacing: 0.05em;
}

.rights-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #f1f5f9;
}

.rights-table tr:last-child td { border-bottom: none; }
.rights-table tr:hover td { background-color: #f8fafc; }

.rights-table th.c, 
.rights-table td.c { text-align: center; width: 80px; }

/* Announcements in Admin */
.ann-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 16px;
}

.ann-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  border-left: 4px solid var(--primary);
}

.ann-id { font-weight: 700; color: #9ca3af; font-size: 0.8rem; margin-right: 10px;}
.ann-text { font-size: 0.9rem; color: #ffffff; flex: 1; }

@media (max-width: 640px) {
  .admin-grid-2 { grid-template-columns: 1fr; }
  .admin-tabs { overflow-x: auto; white-space: nowrap; }
}

.admin-toolbar-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  width: 100%;
}

.admin-toolbar-row input, 
.admin-toolbar-row textarea {
  flex: 1; 
  width: auto;
  min-width: 0;
}

.admin-toolbar-row button {
  flex: 0 0 auto;
  width: auto;
  white-space: nowrap;
  height: fit-content;
}

.admin-panel .btn-primary,
.admin-panel .btn-danger,
.admin-panel .btn-secondary {
  width: auto;
  display: inline-flex;
}

.admin-user-card .admin-grid-2 {
  grid-template-columns: 1fr !important;
  gap: 12px;
}

.admin-user-card input,
.admin-user-card select {
  width: 100%;
  box-sizing: border-box;
  max-width: 100%;
}

.admin-card-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e2e8f0;
}

.admin-card-actions button {
  width: 100%;
  justify-content: center;
}

.admin-user-card label {
  font-size: 0.75rem;
  color: #64748b;
  margin-bottom: 2px;
}

/* =========================
   APP SHELL / NAVBAR
   ========================= */

.topbar {
  position: sticky;
  top: 0;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 10px 18px;
  background-color: #ffffff;
  border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.app-logo {
  font-weight: 700;
  letter-spacing: 0.08em;
  font-size: 0.9rem;
  color: #111827;
}

.topbar-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 10px;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-info {
  font-size: 0.9rem;
  color: #4b5563;
}

.nav-link {
  font-size: 0.9rem;
  text-decoration: none;
  color: #4b5563;
  padding: 6px 10px;
  border-radius: 999px;
  transition: background-color 120ms ease-out, color 120ms ease-out;
}

.nav-link:hover {
  background-color: #e5e7eb;
  color: #111827;
}

.nav-link-active {
  background-color: #1d4ed8;
  color: #ffffff;
}

/* =========================
   APP CONTENT
   ========================= */

.profile-mode .app-main {
  max-width: 1400px;
  transition: max-width 0.3s ease;
}

.wide-mode .app-main {
  max-width: 1600px;
  transition: max-width 0.3s ease;
}

.app-main {
  max-width: 960px;
  margin: 18px auto 24px;
  padding: 0 16px;
}

.app-content {
  background-color: #ffffff;
  border-radius: 14px;
  padding: 20px 18px;
  box-shadow: var(--shadow-soft);
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.app-title {
  margin: 0 0 6px;
  font-size: 1.3rem;
}

.app-subtitle {
  margin: 0;
  font-size: 0.95rem;
  color: var(--text-muted);
}

/* =========================
   RESPONSIVE
   ========================= */

@media (max-width: 640px) {
  .topbar {
    flex-wrap: wrap;
    align-items: flex-start;
  }

  .topbar-left {
    margin-bottom: 4px;
  }

  .topbar-nav {
    order: 3;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }

  .topbar-right {
    margin-left: auto;
  }
}

/* =========================
   PROFILE PAGE STYLES (Existing)
   ========================= */
.profile-sections {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 12px;
}

.profile-card {
  background-color: #ffffff;
  border-radius: 12px;
  padding: 14px 12px 12px;
  border: 1px solid rgba(148, 163, 184, 0.35);
}

.section-title {
  margin: 0 0 10px;
  font-size: 1rem;
  font-weight: 600;
}

.profile-details {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.9rem;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  gap: 8px;
}

.detail-label {
  color: var(--text-muted);
}

.detail-value {
  font-weight: 500;
}

/* =========================
   TABLES
   ========================= */
.table-wrapper {
  overflow-x: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
  background: #fff;
}

.data-table th {
  background-color: #f1f5f9;
  color: #334155;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  padding: 12px 16px;
  border-bottom: 2px solid #cbd5e1;
  text-align: left;
}

.data-table td {
  padding: 10px 16px;
  border-bottom: 1px solid #e2e8f0;
  vertical-align: middle;
  color: #1e293b;
}

.data-table th:last-child,
.data-table td:last-child {
  text-align: center;
  width: 110px;
}

.data-table tr:last-child td {
  border-bottom: none;
}

.table-empty {
  text-align: center;
  color: var(--text-muted);
  padding: 20px;
}

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.78rem;
  font-weight: 600;
}

.badge-write {
  background-color: #dcfce7;
  color: #166534;
}

.badge-read {
  background-color: #e0f2fe;
  color: #1d4ed8;
}

.badge-none {
  background-color: #f3f4f6;
  color: #4b5563;
}

@media (max-width: 640px) {
  .detail-row {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* =========================
   SEARCH MODULE
   ========================= */
.search-card {
  background-color: #ffffff;
  border-radius: 12px;
  padding: 14px 12px 12px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  margin-top: 12px;
}

.search-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.fields-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px 12px;
}

.fields-grid .f {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.fields-grid label {
  font-size: 0.85rem;
  font-weight: 500;
}

.search-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 6px;
}

.search-results {
  margin-top: 18px;
}

.search-results-info {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin: 2px 0 8px;
}

.search-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 10px 12px;
}

.search-result-card {
  background-color: #ffffff;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  padding: 8px 10px 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.search-result-card .result-header {
  display: flex;
  justify-content: flex-end;
}

.search-result-card .result-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.85rem;
}

.search-result-card .row {
  display: flex;
  justify-content: space-between;
  gap: 6px;
}

.search-result-card .row .k {
  color: var(--text-muted);
}

.search-result-card .row .v {
  font-weight: 500;
  text-align: right;
}

.search-result-card .result-footer {
  display: flex;
  justify-content: flex-end;
  margin-top: 4px;
}

.btn-small {
  padding: 3px 8px;
  font-size: 0.78rem;
}

/* status badge */
.badge-status {
  background-color: #eef2ff;
  color: #312e81;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 0.7rem;
  font-weight: 600;
}

@media (max-width: 900px) {
  .fields-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 640px) {
  .fields-grid {
    grid-template-columns: minmax(0, 1fr);
  }

  .search-result-card .row {
    flex-direction: column;
    align-items: flex-start;
  }

  .search-result-card .row .v {
    text-align: left;
  }
}

/* =========================
   UTILITIES / INTEROGARI
   ========================= */

.hidden { display: none !important; }
.full-width { width: 100%; }
.mb-2 { margin-bottom: 8px; }
.mt-4 { margin-top: 16px; }
.row-flex { display: flex; gap: 8px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.text-center { text-align: center; }
.span-2 { grid-column: span 2; }

/* Card Actions */
.card-action {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.card-action h3 {
  margin: 0 0 4px 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #1e293b;
}

.card-action p {
  font-size: 0.8rem;
  color: #64748b;
  margin: 0 0 8px 0;
}

.sm-input { width: 80px; }

.btn-small { padding: 2px 8px; font-size: 0.75rem; background: #e0f2fe; color: #0369a1; border: none; border-radius: 4px; cursor: pointer; }
.btn-small:hover { background: #bae6fd; }

/* PROFILE DETINUT STYLES (NEW HEADER) */

.detinut-header {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.08);
  border: 1px solid #e2e8f0;
  margin-bottom: 24px;
  display: flex;
  flex-wrap: wrap;
  overflow: hidden;
  position: relative;
}

.detinut-header::before {
  content: "";
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 5px;
  background: linear-gradient(to bottom, #2563eb, #1e40af);
}

.header-photos {
  padding: 16px;
  display: flex;
  gap: 12px;
  background: #f8fafc;
  border-right: 1px solid #f1f5f9;
  align-items: center;
  justify-content: center;
}

.header-photo {
  width: 90px;
  height: 110px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
  background-color: #e2e8f0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.header-photo.empty {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  font-weight: 700;
  font-size: 1.5rem;
}

.header-info {
  flex: 1;
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 10px;
  min-width: 300px;
}

.header-name {
  margin: 0;
  font-size: 1.65rem;
  color: #0f172a;
  font-weight: 700;
  line-height: 1.2;
}

.header-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 16px;
  color: #475569;
  font-size: 0.9rem;
}

.meta-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.meta-label {
  text-transform: uppercase;
  font-size: 0.7rem;
  font-weight: 700;
  color: #94a3b8;
  letter-spacing: 0.05em;
}

.meta-val {
  font-weight: 600;
  color: #334155;
}

.header-actions {
  padding: 20px;
  display: flex;
  align-items: flex-start;
  justify-content: flex-end;
  min-width: 150px;
}

/* Compact Edit Button Style */
.btn-compact-edit {
  background-color: #f1f5f9;
  color: #334155;
  border: 1px solid #e2e8f0;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.btn-compact-edit:hover {
  background-color: #fff;
  border-color: #cbd5e1;
  color: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

.btn-compact-edit.active {
  background-color: #fee2e2;
  color: #991b1b;
  border-color: #fecaca;
}

/* Sub-module Layout */
.sub-module-layout {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 24px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
  min-height: 400px;
}

.sub-nav {
  background: #f8fafc;
  border-right: 1px solid #e2e8f0;
  padding: 16px 0;
  display: flex;
  flex-direction: column;
}

.sub-nav-btn {
  background: transparent;
  border: none;
  text-align: left;
  padding: 12px 20px;
  font-size: 0.9rem;
  color: #64748b;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: all 0.2s;
}

.sub-nav-btn:hover {
  background: #f1f5f9;
  color: #334155;
}

.sub-nav-btn.active {
  background: #fff;
  color: #2563eb;
  border-left-color: #2563eb;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.sub-content {
  padding: 24px;
}

.error-box {
  background: #fef2f2;
  border: 1px solid #fee2e2;
  color: #991b1b;
  padding: 16px;
  border-radius: 8px;
}

@media (max-width: 850px) {
  .detinut-header { flex-direction: column; }
  .header-photos { border-right: none; border-bottom: 1px solid #f1f5f9; padding: 12px; }
  .header-actions { padding: 12px 24px; justify-content: flex-start; }
}

@media (max-width: 768px) {
  .sub-module-layout {
    grid-template-columns: 1fr;
  }
  .sub-nav {
    flex-direction: row;
    overflow-x: auto;
    border-right: none;
    border-bottom: 1px solid #e2e8f0;
  }
  .sub-nav-btn {
    border-left: none;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
  }
  .sub-nav-btn.active {
    border-left: none;
    border-bottom-color: #2563eb;
  }
}

.profile-mode .sub-module-layout {
  min-height: 600px;
}

/* --- MODAL STYLES --- */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

.modal-card {
  background: #fff;
  width: 90%;
  max-width: 500px;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  transform: translateY(20px);
  transition: transform 0.2s;
}

.modal-overlay.open .modal-card {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.btn-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  line-height: 1;
  cursor: pointer;
  color: #64748b;
}

.modal-body {
  margin-bottom: 20px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* 2. MAIN TABS (Top Navigation) */
/* ... inside public/resources/css/styles.css (append to end) */

/* Garan»õii de stat Badge */
.badge-guarantee {
  display: inline-block;
  background-color: #dc2626; /* Vivid Red */
  color: white;
  font-weight: 800;
  font-size: 0.85rem;
  padding: 4px 12px;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-top: 8px;
  box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
  animation: pulse-red 2s infinite;
  vertical-align: middle;
}

@keyframes pulse-red {
  0% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
  }
  70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
  }
  100% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
  }
}


.profile-tabs-nav {
  display: flex;
  gap: 8px;
  border-bottom: 1px solid #e2e8f0;
  margin-bottom: 28px;
  overflow-x: auto;
  padding-bottom: 1px;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 10px 14px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #64748b;
  cursor: pointer;
  border-radius: 8px 8px 0 0;
  transition: all 0.2s;
  position: relative;
}

.tab-btn:hover {
  color: #1e293b;
  background: #f8fafc;
}

.tab-btn.active {
  color: #2563eb;
  background: #fff;
  font-weight: 600;
}

.tab-btn.active::after {
  content: "";
  position: absolute;
  bottom: -2px; left: 0; right: 0;
  height: 2px;
  background: #2563eb;
}

/* 3. SUB-MODULE LAYOUT (Medical, etc.) */
.module-container {
  display: grid;
  grid-template-columns: 240px 1fr;
  gap: 0;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  min-height: 500px;
  overflow: hidden;
}

.module-sidebar {
  background: #f8fafc;
  border-right: 1px solid #e2e8f0;
  padding: 20px 0;
}

.module-sidebar h4 {
  margin: 0 0 12px 20px;
  font-size: 0.8rem;
  text-transform: uppercase;
  color: #94a3b8;
  letter-spacing: 0.05em;
}

.side-nav-btn {
  display: block;
  width: 100%;
  text-align: left;
  padding: 12px 20px;
  background: transparent;
  border: none;
  border-left: 3px solid transparent;
  font-size: 0.9rem;
  color: #475569;
  cursor: pointer;
  transition: background 0.15s;
}

.side-nav-btn:hover {
  background: #eef2ff;
  color: #1e40af;
}

.side-nav-btn.active {
  background: #fff;
  border-left-color: #2563eb;
  color: #2563eb;
  font-weight: 600;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.module-content {
  padding: 30px;
  background: #fff;
}

/* Loading/Error States */
.loader-box { padding: 40px; text-align: center; color: #64748b; }
.error-box { padding: 20px; background: #fef2f2; color: #b91c1c; border-radius: 8px; border: 1px solid #fecaca; }

/* Responsive */
@media (max-width: 800px) {
  .module-container { grid-template-columns: 1fr; }
  .module-sidebar { border-right: none; border-bottom: 1px solid #e2e8f0; display: flex; overflow-x: auto; padding: 0; }
  .module-sidebar h4 { display: none; }
  .side-nav-btn { border-left: none; border-bottom: 3px solid transparent; white-space: nowrap; width: auto; }
  .side-nav-btn.active { border-left: none; border-bottom-color: #2563eb; }
}

/* --- FILE UPLOAD / DRAG & DROP --- */
.upload-area {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  background-color: #f8fafc;
  transition: all 0.2s;
  cursor: pointer;
  margin-bottom: 16px;
}
.upload-area:hover, .upload-area.dragover {
  border-color: #2563eb;
  background-color: #eff6ff;
}
.upload-icon {
  font-size: 2rem;
  color: #94a3b8;
  margin-bottom: 8px;
}
.upload-text {
  color: #64748b;
  font-size: 0.9rem;
}
.upload-preview {
  margin-top: 16px;
  display: flex;
  justify-content: center;
}
.preview-img {
  max-width: 150px;
  max-height: 150px;
  border-radius: 8px;
  border: 2px solid #e2e8f0;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

/* --- SECTIONS & GRIDS --- */
.gen-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}
.profile-section-title {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #94a3b8;
  font-weight: 700;
  margin-bottom: 12px;
  border-bottom: 1px solid #f1f5f9;
  padding-bottom: 6px;
}

/* --- COMPACT TABLES FOR ACTS/JOBS --- */
.compact-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.compact-table th {
  text-align: left;
  color: #64748b;
  font-weight: 600;
  padding: 6px 4px;
  border-bottom: 1px solid #e2e8f0;
}
.compact-table td {
  padding: 8px 4px;
  border-bottom: 1px solid #f1f5f9;
  color: #334155;
}
.compact-table tr:last-child td { border-bottom: none; }

/* Responsive */
@media (max-width: 1100px) {
  .gen-grid-3 { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 700px) {
  .gen-grid-3 { grid-template-columns: 1fr; }
}

/* --- NEW MODAL & UI STYLES --- */
.detail-stack { display: flex; flex-direction: column; gap: 6px; }
.detail-label.block { display: block; font-size: 0.8rem; color: #64748b; font-weight: 700; }
.badges { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
.del-x { color: #ef4444; margin-left: 6px; cursor: pointer; font-weight: bold; }
.del-x:hover { color: #dc2626; }
.btn-tiny { padding: 2px 6px; font-size: 0.75rem; background: #e2e8f0; border-radius: 4px; border: none; cursor: pointer; }
.btn-tiny:hover { background: #cbd5e1; }
.addr-list { list-style: none; padding: 0; margin: 0; max-height: 120px; overflow-y: auto; font-size: 0.85rem; }
.addr-list li { border-bottom: 1px solid #f1f5f9; padding: 6px 0; }
.gallery-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
.gallery-item img { height: 100px; width: auto; border-radius: 6px; border: 1px solid #e2e8f0; transition: transform 0.2s; }
.gallery-item img:hover { transform: scale(1.05); }

/* --- Search Select Shim --- */
.search-select {
    appearance: none; 
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}
</file>

<file path="public/resources/js/api.js">
// public/js/api.js
const API_BASE_URL = "/api";

function getAuthHeaders() {
  const headers = {
    "Accept": "application/json"
  };
  
  // Retrieve the User ID from the browser session
  const userId = sessionStorage.getItem("prison.userId");
  if (userId) {
    headers["X-User-Id"] = userId;
  }
  
  return headers;
}

async function apiGet(path) {
  const response = await fetch(`${API_BASE_URL}${path}`, {
    credentials: "same-origin",
    headers: getAuthHeaders() // <--- Now includes X-User-Id
  });

  const data = await response.json().catch(() => ({}));

  if (!response.ok) {
    const msg = data.error || data.message || "Eroare la comunicarea cu serverul.";
    throw new Error(msg);
  }

  return data;
}

async function apiPost(path, body) {
  const headers = getAuthHeaders();
  headers["Content-Type"] = "application/json"; // Add content type for POST

  const response = await fetch(`${API_BASE_URL}${path}`, {
    method: "POST",
    credentials: "same-origin",
    headers: headers,
    body: JSON.stringify(body || {})
  });

  const data = await response.json().catch(() => ({}));

  if (!response.ok) {
    const msg = data.error || data.message || "Eroare la comunicarea cu serverul.";
    const err = new Error(msg);
    err.details = data;
    throw err;
  }

  return data;
}



// Expose globally (no bundler)
window.prisonApi = {
  get: apiGet,
  post: apiPost,
  // Add to window.prisonApi
  del: async (path) => {
    const response = await fetch(`${API_BASE_URL}${path}`, {
      method: "DELETE",
      headers: getAuthHeaders()
    });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) throw new Error(data.error || "Delete failed");
    return data;
}
};
</file>

<file path="public/resources/js/shell.js">
// public/js/shell.js
(function () {
  const navContainer = document.getElementById("navLinks");
  const userInfoEl = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");
  const appContent = document.getElementById("appContent");

  function getCurrentModuleKey() {
    const params = new URLSearchParams(window.location.search);
    return params.get("module") || null;
  }

  function ensureLoggedIn() {
    const userId = sessionStorage.getItem("prison.userId");
    const username = sessionStorage.getItem("prison.username");

    if (!userId || !username) {
      window.location.href = "/";
      return null;
    }
    userInfoEl.textContent = username;
    return userId;
  }

  function renderNav(modules, activeKey) {
    navContainer.innerHTML = "";

    modules.forEach((mod) => {
      // CHANGED: Check visibility flag before rendering
      if (mod.visible === false) return; 

      const link = document.createElement("a");
      link.href = mod.path || '#';
      link.textContent = mod.label;
      link.className = "nav-link";
      if (mod.key === activeKey) {
        link.classList.add("nav-link-active");
      }
      navContainer.appendChild(link);
    });
  }

  function renderDefaultContent(activeKey) {
    let title = "Bine ai venit";
    let subtitle = "SelecteazƒÉ un modul din meniul de sus.";

    if (activeKey) {
      subtitle = `Modulul "${activeKey}" nu are √ÆncƒÉ o implementare dedicatƒÉ sau nu a fost gƒÉsit.`;
    }

    appContent.innerHTML = `
      <h1 class="app-title">${title}</h1>
      <p class="app-subtitle">${subtitle}</p>
    `;
  }

  function runModule(activeKey, userId) {
    const registry = window.prisonModules || {};
    appContent.innerHTML = "";

    if (registry[activeKey] && typeof registry[activeKey].init === "function") {
      registry[activeKey].init({ userId, container: appContent });
    } else {
      renderDefaultContent(activeKey);
    }
  }

  async function initApp() {
    const userId = ensureLoggedIn();
    if (!userId) return;

    let activeKey = getCurrentModuleKey();

    try {
      const navData = await window.prisonApi.get(
        `/nav?userId=${encodeURIComponent(userId)}`
      );

      if (!navData.success) {
        throw new Error(navData.error || "Nu s-a putut √ÆncƒÉrca meniul.");
      }

      const modules = Array.isArray(navData.modules) ? navData.modules : [];

      // If no module in URL, pick first visible one
      if (!activeKey && modules.length > 0) {
        // Find first visible module
        const first = modules.find(m => m.visible !== false) || modules[0];
        activeKey = first.key;
        const url = new URL(window.location.href);
        url.searchParams.set("module", activeKey);
        window.history.replaceState({}, "", url.toString());
      }

      // Security Check: Is the requested module in the allowed list?
      // (Even hidden modules like 'detinut' should be in this list now)
      if (
        activeKey &&
        !modules.some((m) => m.key === activeKey) &&
        modules.length > 0
      ) {
        console.warn(`Module ${activeKey} not allowed or not found. Redirecting.`);
        const first = modules.find(m => m.visible !== false) || modules[0];
        activeKey = first.key;
        const url = new URL(window.location.href);
        url.searchParams.set("module", activeKey);
        window.history.replaceState({}, "", url.toString());
      }

      renderNav(modules, activeKey);
      runModule(activeKey, userId);

    } catch (err) {
      console.error("App Init Error:", err);
      appContent.innerHTML = `
        <h1 class="app-title">Eroare</h1>
        <p class="app-subtitle">${err.message || "Eroare la ini»õializare."}</p>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    initApp().catch(() => {});

    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        sessionStorage.removeItem("prison.userId");
        sessionStorage.removeItem("prison.username");
        window.location.href = "/";
      });
    }
  });
})();
</file>

<file path="src/config.js">
// src/config.js

module.exports = {
  port: process.env.PORT || 3000,

  // Oracle 11g connection
  dbUser: process.env.DB_USER || "PRISON",
  dbPassword: process.env.DB_PASSWORD || "ANP35",
  dbConnectString:
    process.env.DB_CONNECT_STRING ||
    "(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=10.0.0.200)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=XEPDB1)))",

  // Login security
  loginCooldownMinutes: 15,
  loginMaxFailedAttempts: 5
};
</file>

<file path="src/db.js">
// src/db.js
const oracledb = require("oracledb");
const config = require("./config");

oracledb.outFormat = oracledb.OUT_FORMAT_OBJECT;
// Optional: get DATEs as strings if you want
// oracledb.fetchAsString = [oracledb.DATE];

let pool = null;

async function initPool() {
  if (pool) return pool;

  // If you use Instant Client on Windows/Linux:
  // oracledb.initOracleClient({ libDir: "C:\\oracle\\instantclient_19_17" });

  pool = await oracledb.createPool({
    user: config.dbUser,
    password: config.dbPassword,
    connectString: config.dbConnectString,
    poolMin: 1,
    poolMax: 5,
    poolIncrement: 1
  });

  console.log("Oracle pool created");
  return pool;
}

async function getConnection() {
  const p = await initPool();
  const conn = await p.getConnection();

  // Match legacy NLS date format
  await conn.execute("ALTER SESSION SET NLS_DATE_FORMAT = 'DD.MM.YYYY'");

  return conn;
}

async function execute(sql, binds = {}, options = {}) {
  const conn = await getConnection();
  try {
    const result = await conn.execute(sql, binds, options);
    return result;
  } finally {
    try {
      await conn.close();
    } catch (err) {
      console.error("Error closing connection:", err);
    }
  }
}

module.exports = {
  initPool,
  getConnection,
  execute
};
</file>

<file path="src/modules/admin/client.js">
// public/js/admin.js
(function () {
  const api = window.prisonApi;

  // --- Helper Functions ---
  function qs(root, sel) {
    return root.querySelector(sel);
  }
  function qsa(root, sel) {
    return Array.from(root.querySelectorAll(sel));
  }

  function setMsg(el, text, type) {
    if (!el) return;
    el.textContent = text || "";
    el.className = "admin-msg" + (type ? " " + type : "");
  }

  function fillSelect(sel, items, placeholder) {
    if (!sel) return;
    sel.innerHTML = "";
    if (placeholder) {
      const o = document.createElement("option");
      o.value = "";
      o.textContent = placeholder;
      sel.appendChild(o);
    }
    items.forEach((it) => {
      const o = document.createElement("option");
      o.value = it.id;
      o.textContent = it.name;
      sel.appendChild(o);
    });
  }

  // Ensure Chart.js is loaded
  function ensureChartJS() {
    return new Promise((resolve, reject) => {
      if (window.Chart) return resolve();
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function loadMeta() {
    const data = await api.get("/admin/meta");
    if (!data.success) throw new Error(data.error || "Eroare meta.");
    return data;
  }

  // --- Rights Management ---
  async function loadRights(container, userId) {
    container.textContent = "Se √ÆncarcƒÉ drepturile...";
    const data = await api.get(`/admin/user/${userId}/rights`);
    if (!data.success) {
      container.textContent = data.error || "Eroare drepturi.";
      return;
    }
    const mods = data.modules || [];
    if (!mods.length) {
      container.textContent = "Nu existƒÉ module definite.";
      return;
    }

    const rows = mods
      .map((m) => {
        const id = m.moduleId;
        const drept = (m.drept || "N").toUpperCase();
        return `
        <tr data-module-id="${id}" data-access-id="${m.accessId || ""}">
          <td>${m.moduleName}</td>
          <td class="c"><input type="radio" name="mod-${id}" value="N"${
          drept === "N" ? " checked" : ""
        }></td>
          <td class="c"><input type="radio" name="mod-${id}" value="R"${
          drept === "R" ? " checked" : ""
        }></td>
          <td class="c"><input type="radio" name="mod-${id}" value="W"${
          drept === "W" ? " checked" : ""
        }></td>
        </tr>
      `;
      })
      .join("");

    container.innerHTML = `
      <div class="rights-wrap">
        <div class="rights-top">
          <input type="text" class="rights-filter" placeholder="FiltreazƒÉ module..." />
          <div class="rights-bulk">
            <button type="button" data-bulk="N">FƒÉrƒÉ</button>
            <button type="button" data-bulk="R">Citire</button>
            <button type="button" data-bulk="W">Scriere</button>
          </div>
        </div>
        <table class="rights-table">
          <thead>
            <tr>
              <th>Modul</th>
              <th class="c">FƒÉrƒÉ</th>
              <th class="c">Citire</th>
              <th class="c">Scriere</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="form-buttons right">
          <button type="button" class="btn-secondary rights-save">SalveazƒÉ drepturi</button>
        </div>
        <div class="admin-msg" id="rightsMsg"></div>
      </div>
    `;

    const filter = qs(container, ".rights-filter");
    const tbody = qs(container, "tbody");
    const msg = qs(container, "#rightsMsg");

    if (filter && tbody) {
      filter.addEventListener("input", () => {
        const q = filter.value.toLowerCase();
        qsa(tbody, "tr").forEach((tr) => {
          const name = (tr.cells[0].textContent || "").toLowerCase();
          tr.style.display = name.indexOf(q) !== -1 ? "" : "none";
        });
      });
    }

    qsa(container, "[data-bulk]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const v = btn.getAttribute("data-bulk");
        qsa(tbody, `input[type=radio][value=${v}]`).forEach(
          (r) => (r.checked = true)
        );
      });
    });

    const saveBtn = qs(container, ".rights-save");
    if (saveBtn) {
      saveBtn.addEventListener("click", async () => {
        setMsg(msg, "", "");
        const rights = [];
        qsa(tbody, "tr").forEach((tr) => {
          const moduleId = Number(tr.getAttribute("data-module-id"));
          const accessId = tr.getAttribute("data-access-id");
          const checked = qs(tr, "input[type=radio]:checked");
          if (!checked) return;
          rights.push({
            moduleId,
            accessId: accessId ? Number(accessId) : null,
            drept: checked.value,
          });
        });
        try {
          const resp = await api.post(`/admin/user/${userId}/rights`, {
            rights,
          });
          if (!resp.success) throw new Error(resp.error || "Eroare salvare.");
          setMsg(msg, "Drepturi salvate.", "success");
        } catch (e) {
          setMsg(msg, e.message || "Eroare la salvarea drepturilor.", "error");
        }
      });
    }
  }

  // --- User Cards & Actions ---
  function renderUserCard(user, meta) {
    const div = document.createElement("div");
    div.className = "admin-user-card";
    
    let lastLogin = "N/A";
    if (user.lastLogin) {
      try {
        const d = new Date(user.lastLogin);
        if (!isNaN(d.getTime())) {
          lastLogin = d.toLocaleString('ro-RO', { 
            day: '2-digit', month: '2-digit', year: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
          });
        } else {
            lastLogin = user.lastLogin; 
        }
      } catch(e) { lastLogin = user.lastLogin; }
    }

    div.innerHTML = `
      <h3 class="admin-user-title">
        ${user.username} <span style="font-weight:400; color:#64748b; font-size:0.9em;">(ID: ${user.id})</span>
      </h3>
      
      <div class="admin-grid-2">
        <div class="f">
           <label>Ultima autentificare</label>
           <input type="text" value="${lastLogin}" readonly style="background:#f8fafc; color:#64748b;">
        </div>

        <div class="f">
          <label>Username (Login)</label>
          <input type="text" name="username" value="${user.username}">
        </div>

        <div class="f">
          <label>Resetare ParolƒÉ</label>
          <input type="text" name="password" value="" placeholder="(LasƒÉ gol pt. a pƒÉstra)">
        </div>

        <div class="f">
          <label>Rol Acces</label>
          <select name="roleId"></select>
        </div>

        <div class="f">
          <label>Penitenciar</label>
          <select name="penitenciarId"></select>
        </div>
      </div>

      <div class="admin-card-actions">
        <button type="button" class="btn-primary btn-save">SalveazƒÉ schimbƒÉri</button>
        <button type="button" class="btn-danger btn-deactivate">DezactiveazƒÉ utilizator</button>
      </div>
      
      <div class="admin-msg user-msg"></div>
    `;

    const roleSel = qs(div, "select[name=roleId]");
    const penSel = qs(div, "select[name=penitenciarId]");
    
    // Add placeholders to handle null values correctly
    fillSelect(roleSel, meta.roles, "-- SelecteazƒÉ --");
    fillSelect(penSel, meta.penitenciars, "-- SelecteazƒÉ --");
    
    // Set value or empty string for null
    if (user.roleId !== null && user.roleId !== undefined) {
        roleSel.value = String(user.roleId);
    } else {
        roleSel.value = "";
    }

    if (user.penitenciarId !== null && user.penitenciarId !== undefined) {
        penSel.value = String(user.penitenciarId);
    } else {
        penSel.value = "";
    }

    const msg = qs(div, ".user-msg");
    
    const btnSave = qs(div, ".btn-save");
    btnSave.addEventListener("click", async () => {
      setMsg(msg, "Se salveazƒÉ...", "");
      
      const rVal = roleSel.value;
      const pVal = penSel.value;

      const payload = {
        username: qs(div, "input[name=username]").value.trim(),
        password: qs(div, "input[name=password]").value.trim(),
        // Convert to Number, default to 0 for constraints
        roleId: rVal === "" ? 0 : Number(rVal),
        penitenciarId: pVal === "" ? 0 : Number(pVal),
      };

      try {
        const resp = await api.post(`/admin/user/${user.id}/update`, payload);
        if (!resp.success) throw new Error(resp.error || "Eroare actualizare.");
        setMsg(msg, "Salvat cu succes.", "success");
        qs(div, "input[name=password]").value = "";
      } catch (e) {
        setMsg(msg, e.message, "error");
      }
    });

    const btnDeact = qs(div, ".btn-deactivate");
    btnDeact.addEventListener("click", async () => {
      if (!confirm("Sigur dezactiva»õi acest utilizator?")) return;
      try {
        const resp = await api.post(`/admin/user/${user.id}/deactivate`, {});
        if (!resp.success) throw new Error(resp.error || "Eroare dezactivare.");
        setMsg(msg, "Utilizator dezactivat.", "success");
        div.style.opacity = "0.5";
        div.style.pointerEvents = "none";
      } catch (e) {
        setMsg(msg, e.message, "error");
      }
    });

    return div;
  }

  // --- Announcements (Simplified: Only One allowed) ---
  async function initAnnouncements(root) {
    const listEl = qs(root, "#adminAnnList");
    const form = qs(root, "#adminAnnForm");
    const msg = qs(root, "#adminAnnMsg");

    async function refresh() {
      listEl.textContent = "Se √ÆncarcƒÉ...";
      try {
        const data = await api.get("/admin/ann");
        if (!data.success) throw new Error(data.error || "Eroare anun»õuri.");
        const items = data.items || [];
        
        listEl.innerHTML = "";
        
        if (!items.length) {
          listEl.innerHTML = '<div style="padding:10px; color:#6b7280; font-style:italic;">Nu existƒÉ niciun anun»õ activ.</div>';
          return;
        }

        // Show only the latest one
        const latest = items[0]; // Assuming order DESC from backend
        const row = document.createElement("div");
        row.className = "ann-item";
        row.style.background = "#fff";
        row.innerHTML = `
            <div style="flex:1;">
                <strong style="display:block; font-size:0.75rem; color:#2563eb; text-transform:uppercase; margin-bottom:4px;">Anun»õ Activ</strong>
                <span class="ann-text" style="font-size:1rem;">${latest.message}</span>
            </div>
            <button type="button" class="btn-danger btn-small">»òterge</button>
        `;
        
        const btn = qs(row, "button");
        btn.addEventListener("click", async () => {
            if (!confirm(`»òtergi anun»õul?`)) return;
            try {
              // Delete specific ID or all - safer to delete all if we enforce single
              const resp = await api.del(`/admin/ann`); 
              if (!resp.success) throw new Error(resp.error || "Eroare »ôtergere.");
              refresh();
            } catch (e) {
              setMsg(msg, e.message || "Eroare »ôtergere.", "error");
            }
        });
        listEl.appendChild(row);

      } catch (e) {
        listEl.textContent = e.message || "Eroare anun»õuri.";
      }
    }

    if (form) {
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        setMsg(msg, "", "");
        const text = qs(form, "textarea[name=message]").value.trim();
        if (!text) {
          setMsg(msg, "Textul este gol.", "error");
          return;
        }
        try {
          // Enforce Singleton: Delete all existing before adding new
          await api.del("/admin/ann");

          const resp = await api.post("/admin/ann", { message: text });
          if (!resp.success) throw new Error(resp.error || "Eroare salvare.");
          
          qs(form, "textarea[name=message]").value = "";
          setMsg(msg, "Anun»õ publicat.", "success");
          refresh();
        } catch (e) {
          setMsg(msg, e.message || "Eroare salvare.", "error");
        }
      });
    }

    refresh();
  }

  // --- Statistics Panel ---
  async function initStatsPanel(root) {
    const activeVal = qs(root, "#statActive");
    const deactVal = qs(root, "#statDeact");
    const inactVal = qs(root, "#statInact");
    const canvas = qs(root, "#usersByPrisonChart");
    const container = qs(root, "[data-admin-panel=stats]");

    if (!container || !canvas) return;

    // Load Data and ChartJS
    try {
      await ensureChartJS();
      const res = await api.get("/admin/stats/users");
      if (!res.success) throw new Error(res.error || "Eroare date statistici");

      // Set Counters
      if(activeVal) activeVal.textContent = res.counters.active;
      if(deactVal) deactVal.textContent = res.counters.deactivated;
      if(inactVal) inactVal.textContent = res.counters.inactive;

      // --- FIX: Check for and destroy existing chart instance ---
      // Chart.js 4.x attaches the instance to the canvas using Chart.getChart(canvas)
      if (window.Chart) {
          const existingChart = window.Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
      }

      // Render Chart
      const dist = res.distribution || [];
      const labels = dist.map(d => d.label);
      const data = dist.map(d => d.count);

      new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'NumƒÉr Useri',
            data: data,
            backgroundColor: '#2563eb',
            barPercentage: 0.7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: labels.length > 8 ? 'y' : 'x', // Horizontal if many items
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } },
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });

    } catch (e) {
      console.error("Stats Error:", e);
      // Don't append error if one already exists to avoid clutter
      if(!container.querySelector('.admin-msg.error')) {
          container.innerHTML += `<div class="admin-msg error">Eroare √ÆncƒÉrcare statistici: ${e.message}</div>`;
      }
    }
  }

  // --- Panels Initialization ---
  async function initCreatePanel(root, meta) {
    const form = qs(root, "#adminCreateForm");
    const msg = qs(root, "#adminCreateMsg");
    if (!form) return;

    fillSelect(qs(form, "select[name=roleId]"), meta.roles, "-- Rol --");
    fillSelect(
      qs(form, "select[name=penitenciarId]"),
      meta.penitenciars,
      "-- Penitenciar --"
    );

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      setMsg(msg, "", "");
      const fd = new FormData(form);
      
      const rVal = fd.get("roleId");
      const pVal = fd.get("penitenciarId");

      const payload = {
        username: fd.get("username"),
        password: fd.get("password"),
        autoPassword: fd.get("autoPassword") === "on",
        // Ensure values are Numbers, defaulting to 0
        roleId: rVal === "" ? 0 : Number(rVal),
        penitenciarId: pVal === "" ? 0 : Number(pVal),
      };
      try {
        const data = await api.post("/admin/user/create", payload);
        if (!data.success) throw new Error(data.error || "Eroare creare.");
        let txt = `Utilizator creat: ${data.username}`;
        if (data.autoPassword) txt += ` | ParolƒÉ: ${data.autoPassword}`;
        setMsg(msg, txt, "success");
        form.reset();
      } catch (e) {
        setMsg(msg, e.message || "Eroare creare.", "error");
      }
    });
  }

  async function initBulkPanel(root, meta) {
    const form = qs(root, "#adminBulkForm");
    const msg = qs(root, "#adminBulkMsg");
    const report = qs(root, "#adminBulkReport");
    if (!form) return;

    fillSelect(qs(form, "select[name=roleId]"), meta.roles, "-- Rol --");
    fillSelect(
      qs(form, "select[name=penitenciarId]"),
      meta.penitenciars,
      "-- Penitenciar --"
    );

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      setMsg(msg, "", "");
      report.textContent = "";
      const fd = new FormData(form);
      
      const rVal = fd.get("roleId");
      const pVal = fd.get("penitenciarId");

      const payload = {
        usernamesText: fd.get("usernamesText"),
        // Ensure values are Numbers, defaulting to 0
        roleId: rVal === "" ? 0 : Number(rVal),
        penitenciarId: pVal === "" ? 0 : Number(pVal),
        autoPassword: fd.get("autoPassword") === "on",
        samePassword: fd.get("samePassword"),
      };
      try {
        const data = await api.post("/admin/user/bulk", payload);
        if (!data.success) throw new Error(data.error || "Eroare bulk.");
        setMsg(
          msg,
          `AdƒÉugate: ${data.okCount || 0}, E»ôecuri: ${data.failCount || 0}`,
          "success"
        );
        report.textContent = (data.report || []).join("\n");
      } catch (e) {
        setMsg(msg, e.message || "Eroare bulk.", "error");
      }
    });
  }

  async function initSearchPanel(root, meta) {
    const form = qs(root, "#adminSearchForm");
    const results = qs(root, "#adminSearchResults");
    if (!form || !results) return;

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const q = qs(form, "input[name=q]").value.trim();
      if (!q) {
        results.textContent = "Introduce»õi un termen de cƒÉutare.";
        return;
      }
      results.textContent = "Se cautƒÉ...";
      try {
        const data = await api.get(
          `/admin/user/search?q=${encodeURIComponent(q)}`
        );
        if (!data.success) throw new Error(data.error || "Eroare cƒÉutare.");
        const users = data.users || [];
        if (!users.length) {
          results.textContent = "Nu a fost gƒÉsit niciun utilizator.";
          return;
        }
        results.innerHTML = "";
        users.forEach((u) => results.appendChild(renderUserCard(u, meta)));
      } catch (e) {
        results.textContent = e.message || "Eroare cƒÉutare.";
      }
    });
  }

  function setupTabs(root) {
    const buttons = qsa(root, "[data-admin-tab]");
    const panels = qsa(root, "[data-admin-panel]");
    function show(name) {
      panels.forEach((p) => {
        p.style.display =
          p.getAttribute("data-admin-panel") === name ? "" : "none";
      });
      buttons.forEach((b) => {
        b.className = "admin-tab-btn"; 
        if (b.getAttribute("data-admin-tab") === name) {
          b.classList.add("active");
        }
      });
      // Lazy load stats when tab is clicked
      if (name === "stats") {
        const container = qs(root, "[data-admin-panel=stats]");
        // Simple check to prevent double init if we wanted, 
        // but re-init refreshes data which is good.
        initStatsPanel(root);
      }
    }
    buttons.forEach((b) =>
      b.addEventListener("click", () => show(b.getAttribute("data-admin-tab")))
    );
    show("create"); // Default tab
  }

  // --- Main Render Function ---
  async function renderAdminPage(mainEl) {
    if (!mainEl) return;
    mainEl.innerHTML = `<div class="admin-msg">Se √ÆncarcƒÉ administrarea...</div>`;
    try {
      const meta = await loadMeta();

      mainEl.innerHTML = `
        <div class="admin-page">
          <header class="admin-header-main">
            <h1 class="admin-title">Administrare</h1>
            <p class="app-subtitle">GestioneazƒÉ utilizatori, drepturi »ôi anun»õuri.</p>
          </header>

          <div class="admin-tabs">
            <button type="button" class="admin-tab-btn" data-admin-tab="create">AdaugƒÉ User</button>
            <button type="button" class="admin-tab-btn" data-admin-tab="bulk">Import Masiv</button>
            <button type="button" class="admin-tab-btn" data-admin-tab="search">CautƒÉ & EditeazƒÉ</button>
            <button type="button" class="admin-tab-btn" data-admin-tab="ann">Anun»õuri</button>
            <button type="button" class="admin-tab-btn" data-admin-tab="stats">Statistici</button>
          </div>

          <!-- CREATE PANEL -->
          <section class="admin-panel" data-admin-panel="create">
            <h2>üë§ AdaugƒÉ utilizator nou</h2>
            <form id="adminCreateForm" class="admin-form">
              <div class="admin-grid-2">
                <div class="f">
                  <label>Username (lowercase)</label>
                  <input type="text" name="username" autocomplete="off" placeholder="ex: popescu.ion">
                </div>
                <div class="f">
                  <label>ParolƒÉ</label>
                  <input type="text" name="password" autocomplete="off" placeholder="ParolƒÉ ini»õialƒÉ">
                  <label style="margin-top:6px; font-weight:400; font-size:0.8rem; color:#666;">
                    <input type="checkbox" name="autoPassword"> GenereazƒÉ automat
                  </label>
                </div>
                <div class="f">
                  <label>Rol</label>
                  <select name="roleId"></select>
                </div>
                <div class="f">
                  <label>Penitenciar</label>
                  <select name="penitenciarId"></select>
                </div>
              </div>
              <div class="form-buttons right">
                <button type="submit" class="btn-primary">CreeazƒÉ utilizator</button>
              </div>
              <div id="adminCreateMsg" class="admin-msg"></div>
            </form>
          </section>

          <!-- BULK PANEL -->
          <section class="admin-panel" data-admin-panel="bulk">
            <h2>üì• AdaugƒÉ utilizatori √Æn masƒÉ</h2>
            <p style="font-size:0.85rem; color:#6b7280; margin-bottom:12px;">
              Introduce»õi o listƒÉ de utilizatori (unul pe linie sau separa»õi prin virgulƒÉ).
            </p>
            <form id="adminBulkForm" class="admin-form">
              <textarea name="usernamesText" rows="6" placeholder="popescu.ion&#10;vasile.george&#10;..." style="font-family:monospace;"></textarea>

              <div class="admin-grid-2">
                <div class="f">
                  <label>Rol (pentru to»õi)</label>
                  <select name="roleId"></select>
                </div>
                <div class="f">
                  <label>Penitenciar (pentru to»õi)</label>
                  <select name="penitenciarId"></select>
                </div>
              </div>

              <div style="background:#f3f4f6; padding:10px; border-radius:8px;">
                <label style="margin-bottom:8px; display:block;">SetƒÉri ParolƒÉ</label>
                <div class="admin-grid-2">
                  <label style="font-weight:400;">
                    <input type="checkbox" name="autoPassword"> Generare aleatorie unicƒÉ
                  </label>
                  <div>
                    <input type="text" name="samePassword" placeholder="Sau o parolƒÉ comunƒÉ..." style="margin-top:0;">
                  </div>
                </div>
              </div>

              <div class="form-buttons right">
                <button type="submit" class="btn-primary">ProceseazƒÉ lista</button>
              </div>
              <pre id="adminBulkReport" class="admin-report"></pre>
              <div id="adminBulkMsg" class="admin-msg"></div>
            </form>
          </section>

          <!-- SEARCH PANEL -->
          <section class="admin-panel" data-admin-panel="search">
            <h2>üîé CautƒÉ »ôi gestioneazƒÉ</h2>
            <form id="adminSearchForm" class="admin-form">
               <div style="display:flex; gap:10px;">
                 <div style="flex:1;">
                    <input type="text" name="q" autocomplete="off" placeholder="CautƒÉ dupƒÉ nume sau ID..." style="width:100%;">
                 </div>
                 <button type="submit" class="btn-primary">CautƒÉ</button>
               </div>
            </form>
            <div id="adminSearchResults" class="admin-results"></div>
          </section>

          <!-- ANNOUNCEMENTS PANEL -->
          <section class="admin-panel" data-admin-panel="ann">
            <div style="display:flex; justify-content:space-between; align-items:center;">
               <h2>üì¢ Anun»õuri sistem</h2>
            </div>
            <form id="adminAnnForm" class="admin-form" style="margin-bottom:20px;">
              <label>SeteazƒÉ mesaj nou (√Ænlocuie»ôte orice anun»õ existent)</label>
              <div style="display:flex; gap:10px; align-items:flex-start;">
                <textarea name="message" rows="2" style="flex:1;" placeholder="Scrie un mesaj pentru to»õi utilizatorii..."></textarea>
                <button type="submit" class="btn-primary" style="margin-top:4px;">PublicƒÉ</button>
              </div>
            </form>
            <div id="adminAnnMsg" class="admin-msg"></div>
            <div id="adminAnnList" class="ann-list" style="margin-top:20px;"></div>
          </section>

          <!-- STATS PANEL (New) -->
          <section class="admin-panel" data-admin-panel="stats">
             <h2>üìä Statistici Utilizatori</h2>
             
             <!-- KPI Cards -->
             <div class="admin-grid-3" style="margin-bottom: 24px;">
               <div class="stat-card">
                 <div class="stat-label">Useri Activi (< 3 luni)</div>
                 <div class="stat-val" id="statActive">...</div>
               </div>
               <div class="stat-card">
                 <div class="stat-label">Dezactiva»õi ("INACTIV")</div>
                 <div class="stat-val" id="statDeact">...</div>
               </div>
               <div class="stat-card">
                 <div class="stat-label">Inactivi (> 3 luni)</div>
                 <div class="stat-val" id="statInact">...</div>
               </div>
             </div>

             <!-- Chart Container -->
             <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:16px;">
                <h3 style="margin-top:0; font-size:1rem; color:#475569; margin-bottom:12px;">Reparti»õie useri dupƒÉ penitenciar</h3>
                <div style="height: 400px; position: relative;">
                  <canvas id="usersByPrisonChart"></canvas>
                </div>
             </div>
          </section>

        </div>
        
        <!-- Extra Style for Stats -->
        <style>
          .admin-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
          .stat-card { background: #fff; padding: 16px; border: 1px solid #cbd5e1; border-radius: 8px; text-align: center; }
          .stat-label { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
          .stat-val { font-size: 1.8rem; font-weight: 700; color: #2563eb; }
          @media(max-width: 700px) { .admin-grid-3 { grid-template-columns: 1fr; } }
        </style>
      `;

      const root = mainEl.firstElementChild;
      setupTabs(root);
      await initCreatePanel(root, meta);
      await initBulkPanel(root, meta);
      await initSearchPanel(root, meta);
      await initAnnouncements(root);
      // initStatsPanel is called via tab click
    } catch (err) {
      mainEl.innerHTML = `<div class="admin-msg error">${
        err.message || "Eroare la √ÆncƒÉrcare."
      }</div>`;
    }
  }

  window.prisonModules = window.prisonModules || {};
  window.prisonModules.admin = {
    init({ userId, container }) {
      renderAdminPage(container);
    },
  };
})();
</file>

<file path="src/modules/admin/router.js">
const express = require("express");
const db = require("../../db");
const router = express.Router();

/** Simple admin guard: requires x-user-id and role 7 */
async function adminGuard(req, res, next) {
  const uid = Number(req.header("x-user-id") || req.header("X-User-Id"));
  if (!uid) return res.status(401).json({ success: false, error: "Neautorizat." });

  try {
    const r = await db.execute(
      "SELECT ID_ROLE FROM USERS WHERE ID = :id",
      { id: uid }
    );
    if (!r.rows || !r.rows.length) {
      return res.status(401).json({ success: false, error: "Utilizator inexistent." });
    }
    const roleId = Number(r.rows[0].ID_ROLE);
    if (roleId !== 7) {
      return res.status(403).json({ success: false, error: "Acces interzis (rol ‚â† 7)." });
    }
    req.adminId = uid;
    next();
  } catch (err) {
    console.error("adminGuard:", err);
    res.status(500).json({ success: false, error: "Eroare internƒÉ." });
  }
}

router.use("/admin", adminGuard);

/** GET /api/admin/meta -> roles + penitenciars */
router.get("/admin/meta", async (req, res) => {
  try {
    const rolesRes = await db.execute(
      "SELECT ID, NAME FROM SPR_ROLES ORDER BY NAME"
    );
    const penRes = await db.execute(
      "SELECT ID, NAME FROM SPR_PENITENCIAR ORDER BY NAME"
    );

    res.json({
      success: true,
      roles: (rolesRes.rows || []).map(r => ({ id: Number(r.ID), name: r.NAME })),
      penitenciars: (penRes.rows || []).map(r => ({ id: Number(r.ID), name: r.NAME }))
    });
  } catch (err) {
    console.error("/admin/meta:", err);
    res.status(500).json({ success: false, error: "Eroare meta." });
  }
});

/** GET /api/admin/stats/users -> Statistics for the new tab */
router.get("/admin/stats/users", async (req, res) => {
  try {
    // 1. User Counters
    // Active: Login < 3 months
    // Deactivated: Name contains 'INACTIV'
    // Inactive: Not deactivated, but login > 3 months or never
    const sqlCounters = `
      SELECT
        SUM(CASE WHEN LAST_LOGIN >= ADD_MONTHS(SYSDATE,-3) THEN 1 ELSE 0 END) AS ACTIVE_CNT,
        SUM(CASE WHEN INSTR(UPPER(NVL(USERNAME,'')),'INACTIV')>0 THEN 1 ELSE 0 END) AS DEACTIVATED_CNT,
        SUM(CASE WHEN INSTR(UPPER(NVL(USERNAME,'')),'INACTIV')=0
                 AND (LAST_LOGIN IS NULL OR LAST_LOGIN < ADD_MONTHS(SYSDATE,-3))
                THEN 1 ELSE 0 END) AS INACTIVE_CNT
      FROM USERS
    `;
    const r1 = await db.execute(sqlCounters);
    const row1 = r1.rows && r1.rows[0] ? r1.rows[0] : {};

    // 2. Users by Penitentiary (checking non-zero counts)
    const sqlDist = `
      SELECT sp.NAME AS PENITENCIAR, COUNT(u.ID) AS CNT
      FROM SPR_PENITENCIAR sp
      LEFT JOIN USERS u ON u.ID_PENITENTIAR = sp.ID
      GROUP BY sp.NAME
      HAVING COUNT(u.ID) > 0
      ORDER BY sp.NAME
    `;
    const r2 = await db.execute(sqlDist);
    const dist = (r2.rows || []).map(r => ({ label: r.PENITENCIAR, count: Number(r.CNT) }));

    res.json({
      success: true,
      counters: {
        active: Number(row1.ACTIVE_CNT || 0),
        deactivated: Number(row1.DEACTIVATED_CNT || 0),
        inactive: Number(row1.INACTIVE_CNT || 0)
      },
      distribution: dist
    });
  } catch (err) {
    console.error("/admin/stats/users:", err);
    res.status(500).json({ success: false, error: "Eroare statistici." });
  }
});

function genPassword(len = 10) {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789@#$%";
  let out = "";
  for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
  return out;
}

/** POST /api/admin/user/create */
router.post("/admin/user/create", async (req, res) => {
  try {
    let { username, password, autoPassword, roleId, penitenciarId } = req.body || {};
    username = (username || "").trim().toLowerCase();
    password = (password || "").trim();
    const autoPass = !!autoPassword;
    const role = Number(roleId);
    const pen = Number(penitenciarId);

    // FIX: Check isNaN to allow 0 (ANP)
    if (!username || (!password && !autoPass) || isNaN(role) || isNaN(pen)) {
      return res.status(400).json({
        success: false,
        error: "Username, rol, penitenciar »ôi parolƒÉ / auto-parolƒÉ obligatorii."
      });
    }
    if (autoPass) password = genPassword(10);

    await db.execute(
      `INSERT INTO USERS (USERNAME, PASSWD, ID_ROLE, ID_PENITENTIAR, USERTYPE, USERDATE)
       VALUES (:u, :p, :r, :pen, 1, SYSDATE)`,
      { u: username, p: password, r: role, pen },
      { autoCommit: true }
    );

    res.json({
      success: true,
      username,
      autoPassword: autoPass ? password : null
    });
  } catch (err) {
    console.error("/admin/user/create:", err);
    res.status(500).json({ success: false, error: "Eroare la crearea utilizatorului." });
  }
});

/** POST /api/admin/user/bulk */
router.post("/admin/user/bulk", async (req, res) => {
  let conn;
  try {
    let { usernamesText, roleId, penitenciarId, autoPassword, samePassword } = req.body || {};
    const blob = (usernamesText || "").trim();
    const role = Number(roleId);
    const pen = Number(penitenciarId);
    const autoPass = !!autoPassword;
    const onePass = (samePassword || "").trim();

    // FIX: Check isNaN to allow 0
    if (!blob || isNaN(role) || isNaN(pen)) {
      return res.status(400).json({
        success: false,
        error: "Lista utilizatori, rol »ôi penitenciar obligatorii."
      });
    }

    const list = blob
      .split(/[\r\n,;]+/)
      .map(v => v.trim().toLowerCase())
      .filter(v => v.length);

    if (!list.length) {
      return res.status(400).json({ success: false, error: "Nu existƒÉ usernames valide." });
    }

    conn = await db.getConnection();
    let ok = 0, fail = 0;
    const report = [];

    for (const u of list) {
      let pwd = "";
      if (autoPass) pwd = genPassword(10);
      else if (onePass) pwd = onePass;
      else {
        fail++;
        report.push(`‚®Ø ${u} ‚Äî lipsƒÉ parolƒÉ`);
        continue;
      }

      try {
        await conn.execute(
          `INSERT INTO USERS (USERNAME, PASSWD, ID_ROLE, ID_PENITENTIAR, USERTYPE, USERDATE)
           VALUES (:u, :p, :r, :pen, 1, SYSDATE)`,
          { u, p: pwd, r: role, pen }
        );
        ok++;
        report.push(autoPass ? `‚úì ${u} ‚Äî parolƒÉ: ${pwd}` : `‚úì ${u}`);
      } catch (e) {
        fail++;
        report.push(`‚®Ø ${u} ‚Äî ${e.message || "Eroare"}`);
      }
    }

    await conn.commit();
    res.json({ success: true, okCount: ok, failCount: fail, report });
  } catch (err) {
    console.error("/admin/user/bulk:", err);
    if (conn) try { await conn.rollback(); } catch (_) {}
    res.status(500).json({ success: false, error: "Eroare la adƒÉugarea √Æn masƒÉ." });
  } finally {
    if (conn) try { await conn.close(); } catch (_) {}
  }
});

/** GET /api/admin/user/search?q=... */
router.get("/admin/user/search", async (req, res) => {
  try {
    const q = (req.query.q || "").toString().trim().toLowerCase();
    if (!q) {
      return res.status(400).json({ success: false, error: "Termen de cƒÉutare lipsƒÉ." });
    }
    const like = q + "%";
    const isNum = /^[0-9]+$/.test(q);
    let sql, binds = { term: like };
    if (isNum) {
      sql = `
        SELECT ID, USERNAME, PASSWD, ID_ROLE, ID_PENITENTIAR, LAST_LOGIN
        FROM USERS
        WHERE LOWER(USERNAME) LIKE :term OR ID = :id
        ORDER BY ID
      `;
      binds.id = Number(q);
    } else {
      sql = `
        SELECT ID, USERNAME, PASSWD, ID_ROLE, ID_PENITENTIAR, LAST_LOGIN
        FROM USERS
        WHERE LOWER(USERNAME) LIKE :term
        ORDER BY ID
      `;
    }

    const r = await db.execute(sql, binds);
    const users = (r.rows || []).map(row => ({
      id: Number(row.ID),
      username: row.USERNAME,
      password: row.PASSWD,
      roleId: Number(row.ID_ROLE),
      penitenciarId: Number(row.ID_PENITENTIAR),
      lastLogin: row.LAST_LOGIN || null
    }));
    res.json({ success: true, users });
  } catch (err) {
    console.error("/admin/user/search:", err);
    res.status(500).json({ success: false, error: "Eroare la cƒÉutare." });
  }
});

/** POST /api/admin/user/:id/update */
router.post("/admin/user/:id/update", async (req, res) => {
  try {
    const id = Number(req.params.id);
    if (!id) return res.status(400).json({ success: false, error: "ID invalid." });

    let { username, password, roleId, penitenciarId } = req.body || {};
    username = (username || "").trim().toLowerCase();
    password = (password || "").trim();
    const role = Number(roleId);
    const pen = Number(penitenciarId);
    
    // FIX: Check isNaN to allow 0
    if (!username || isNaN(role) || isNaN(pen)) {
      return res.status(400).json({ success: false, error: "C√¢mpuri obligatorii lipsƒÉ." });
    }

    let sql, binds;
    if (password) {
      sql = `
        UPDATE USERS
        SET USERNAME = :u, PASSWD = :p, ID_ROLE = :r, ID_PENITENTIAR = :pen
        WHERE ID = :id
      `;
      binds = { u: username, p: password, r: role, pen, id };
    } else {
      sql = `
        UPDATE USERS
        SET USERNAME = :u, ID_ROLE = :r, ID_PENITENTIAR = :pen
        WHERE ID = :id
      `;
      binds = { u: username, r: role, pen, id };
    }

    await db.execute(sql, binds, { autoCommit: true });
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/user/:id/update:", err);
    res.status(500).json({ success: false, error: "Eroare la actualizare." });
  }
});

/** POST /api/admin/user/:id/deactivate */
router.post("/admin/user/:id/deactivate", async (req, res) => {
  try {
    const id = Number(req.params.id);
    if (!id) return res.status(400).json({ success: false, error: "ID invalid." });

    const randomHex =
      Math.floor(100000000 + Math.random() * 900000000).toString(16) +
      Math.floor(100000000 + Math.random() * 900000000).toString(16);

    await db.execute(
      `UPDATE USERS
       SET USERNAME = 'INACTIV.' || USERNAME,
           PASSWD   = :p
       WHERE ID = :id`,
      { p: randomHex, id },
      { autoCommit: true }
    );
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/user/:id/deactivate:", err);
    res.status(500).json({ success: false, error: "Eroare la dezactivare." });
  }
});

/** GET /api/admin/user/:id/rights */
router.get("/admin/user/:id/rights", async (req, res) => {
  try {
    const id = Number(req.params.id);
    if (!id) return res.status(400).json({ success: false, error: "ID invalid." });

    const r = await db.execute(
      `
      SELECT
        m.ID   AS MODULE_ID,
        m.NAME AS MODULE_NAME,
        a.ID   AS ACCESS_ID,
        a.DREPT
      FROM SPR_MODULES m
      LEFT JOIN SPR_ACCESS a
        ON a.ID_MODUL = m.ID
        AND a.ID_USER  = :uid
      ORDER BY m.NAME
      `,
      { uid: id }
    );

    const modules = (r.rows || []).map(row => ({
      moduleId: Number(row.MODULE_ID),
      moduleName: row.MODULE_NAME,
      accessId: row.ACCESS_ID ? Number(row.ACCESS_ID) : null,
      drept: row.DREPT || "N"
    }));
    res.json({ success: true, modules });
  } catch (err) {
    console.error("/admin/user/:id/rights:", err);
    res.status(500).json({ success: false, error: "Eroare la √ÆncƒÉrcarea drepturilor." });
  }
});

/** POST /api/admin/user/:id/rights */
router.post("/admin/user/:id/rights", async (req, res) => {
  let conn;
  try {
    const id = Number(req.params.id);
    if (!id) return res.status(400).json({ success: false, error: "ID invalid." });

    const rights = Array.isArray(req.body.rights) ? req.body.rights : [];
    if (!rights.length) {
      return res.status(400).json({ success: false, error: "Nu existƒÉ drepturi de salvat." });
    }

    conn = await db.getConnection();

    for (const r of rights) {
      const modul = Number(r.moduleId);
      const drept = (r.drept || "N").toUpperCase();
      if (!modul || !["N", "R", "W"].includes(drept)) continue;

      const accessId = r.accessId ? Number(r.accessId) : null;
      if (!accessId && (drept === "R" || drept === "W")) {
        await conn.execute(
          `INSERT INTO PRISON.SPR_ACCESS (ID, ID_MODUL, ID_USER, DREPT)
           VALUES (PRISON.SPR_ACCESS_SEQ.NEXTVAL, :m, :u, :d)`,
          { m: modul, u: id, d: drept }
        );
      } else if (accessId && drept === "N") {
        await conn.execute(
          "DELETE FROM SPR_ACCESS WHERE ID = :id",
          { id: accessId }
        );
      } else if (accessId) {
        await conn.execute(
          "UPDATE SPR_ACCESS SET DREPT = :d WHERE ID = :id",
          { d: drept, id: accessId }
        );
      }
    }

    await conn.commit();
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/user/:id/rights:", err);
    if (conn) try { await conn.rollback(); } catch (_) {}
    res.status(500).json({ success: false, error: "Eroare la salvarea drepturilor." });
  } finally {
    if (conn) try { await conn.close(); } catch (_) {}
  }
});

/** Announcements */

// GET /api/admin/ann
router.get("/admin/ann", async (req, res) => {
  try {
    const r = await db.execute(
      "SELECT ID, MESAJ FROM PRISON.ANUNT ORDER BY ID DESC"
    );
    res.json({
      success: true,
      items: (r.rows || []).map(row => ({
        id: Number(row.ID),
        message: (row.MESAJ || "").trim()
      }))
    });
  } catch (err) {
    console.error("/admin/ann GET:", err);
    res.status(500).json({ success: false, error: "Eroare la √ÆncƒÉrcarea anun»õurilor." });
  }
});

// POST /api/admin/ann
router.post("/admin/ann", async (req, res) => {
  try {
    const msg = (req.body.message || "").trim();
    if (!msg) {
      return res.status(400).json({ success: false, error: "Textul este gol." });
    }
    await db.execute(
      "INSERT INTO PRISON.ANUNT (ID, MESAJ) VALUES (ANUNT_SEQ.NEXTVAL, :m)",
      { m: msg },
      { autoCommit: true }
    );
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/ann POST:", err);
    res.status(500).json({ success: false, error: "Eroare la salvare." });
  }
});

// DELETE /api/admin/ann (all)
router.delete("/admin/ann", async (req, res) => {
  try {
    await db.execute("DELETE FROM PRISON.ANUNT", {}, { autoCommit: true });
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/ann DELETE all:", err);
    res.status(500).json({ success: false, error: "Eroare la »ôtergere." });
  }
});

// DELETE /api/admin/ann/:id
router.delete("/admin/ann/:id", async (req, res) => {
  try {
    const id = Number(req.params.id);
    if (!id) return res.status(400).json({ success: false, error: "ID invalid." });

    await db.execute(
      "DELETE FROM PRISON.ANUNT WHERE ID = :id",
      { id },
      { autoCommit: true }
    );
    res.json({ success: true });
  } catch (err) {
    console.error("/admin/ann/:id DELETE:", err);
    res.status(500).json({ success: false, error: "Eroare la »ôtergere." });
  }
});

module.exports = router;
</file>

<file path="src/modules/auth/client.js">
// public/js/login.js
(function () {
  const formEl = document.getElementById("loginForm");
  const usernameEl = document.getElementById("username");
  const passwordEl = document.getElementById("password");
  const motivationEl = document.getElementById("motivation");
  const messageEl = document.getElementById("loginMessage");
  const loginBtn = document.getElementById("loginBtn");
  const guideBtn = document.getElementById("guideBtn");
  const authCard = document.querySelector(".auth-card");

  function setMessage(text, type) {
    if (!messageEl) return;
    messageEl.textContent = text || "";
    messageEl.className = "form-message" + (type ? " " + type : "");
  }

  // --- 1. DB Health Check ---
  async function checkHealth() {
    if (!authCard) return;
    try {
      const data = await window.prisonApi.get("/health");
      if (data && data.dbAvailable === false) {
        authCard.innerHTML = `
          <h1 class="auth-title">Eroare conexiune DB</h1>
          <p class="auth-subtitle">
            Contacta»õi administratorul: <a href="mailto:admin@anp.gov.md">admin@anp.gov.md</a>
          </p>
        `;
      }
    } catch (err) { console.error("Health check error", err); }
  }

  // --- 2. Load System Announcement ---
  async function loadAnnouncement() {
    try {
      console.log("Fetching announcement...");
      const data = await window.prisonApi.get("/ann");
      console.log("Announcement data:", data);

      if (data.success && data.message && data.message.trim().length > 0) {
        const banner = document.getElementById("systemAnnouncement");
        const textEl = document.getElementById("sysAnnText");
        
        if (banner && textEl) {
          textEl.textContent = data.message;
          // Force display flex to override display:none
          banner.style.display = "flex"; 
          // Add visible class for animation
          setTimeout(() => banner.classList.add('visible'), 50);
        }
      } else {
        console.log("No active announcement found.");
      }
    } catch (e) {
      console.error("Error loading announcement:", e);
    }
  }

  // --- 3. Load Motives ---
  async function loadMotives() {
    if (!motivationEl) return;
    try {
      const data = await window.prisonApi.get("/motives");
      if (!data.success) throw new Error(data.error);

      motivationEl.innerHTML = '<option value="">-- Selecta»õi motivul --</option>';
      (data.motives || []).forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.text;
        motivationEl.appendChild(opt);
      });
    } catch (err) {
      console.error("Motives load error:", err);
    }
  }

  // --- 4. Handle Login ---
  async function handleSubmit(ev) {
    ev.preventDefault();
    if (!formEl) return;
    setMessage("", "");

    const username = usernameEl.value.trim();
    const password = passwordEl.value;
    const motivId = motivationEl.value;

    if (!username || !password || !motivId) {
      setMessage("Toate c√¢mpurile sunt obligatorii.", "error");
      return;
    }

    loginBtn.disabled = true;

    try {
      const data = await window.prisonApi.post("/login", { username, password, motivId });
      if (!data.success) throw new Error(data.error || "Login failed");

      sessionStorage.setItem("prison.userId", data.user.id);
      sessionStorage.setItem("prison.username", data.user.username);
      
      window.location.href = "/app/index.html?module=cautare";
    } catch (err) {
      setMessage(err.message, "error");
    } finally {
      loginBtn.disabled = false;
    }
  }

  // --- Init ---
  document.addEventListener("DOMContentLoaded", () => {
    // Run checks parallel
    checkHealth();
    loadMotives();
    loadAnnouncement();

    if (formEl) formEl.addEventListener("submit", handleSubmit);
    if (guideBtn) guideBtn.addEventListener("click", () => window.location.href = "/ghid.html");
  });
})();
</file>

<file path="src/modules/auth/router.js">
// src/routes/auth.js
const express = require("express");
const crypto = require("crypto");
const bcrypt = require("bcryptjs");
const db = require("../../db");
const config = require("../../config");

const router = express.Router();

/**
 * Legacy password verification:
 * - plain text match
 * - bcrypt ($2*... 60 chars)
 * - MD5 (32 hex chars)
 */
function verifyPasswordLegacy(input, dbHash) {
  if (!dbHash) return false;
  input = String(input);
  dbHash = String(dbHash);

  // Plain text
  if (input === dbHash) return true;

  // bcrypt
  if (dbHash.length === 60 && dbHash.startsWith("$2")) {
    try {
      return bcrypt.compareSync(input, dbHash);
    } catch {
      return false;
    }
  }

  // MD5
  if (dbHash.length === 32 && /^[a-fA-F0-9]{32}$/.test(dbHash)) {
    const md5 = crypto.createHash("md5").update(input, "utf8").digest("hex");
    return md5.toLowerCase() === dbHash.toLowerCase();
  }

  return false;
}

async function logUserAction(username, action, detail) {
  const safeUser = String(username || "").substring(0, 30);
  const safeDetail = String(detail || "").substring(0, 50);

  const sql =
    "INSERT INTO USER_LOGS (USERNAME, ACTION, E_DATE, DETINUT) " +
    "VALUES (:u, :a, SYSDATE, :d)";

  try {
    await db.execute(
      sql,
      { u: safeUser, a: action, d: safeDetail },
      { autoCommit: true }
    );
  } catch (err) {
    console.error("USER_LOGS insert failed:", err);
  }
}

async function isLoginBlocked(username) {
  const intervalDays = config.loginCooldownMinutes / (60 * 24); // minutes -> fraction of day

  const sql =
    "SELECT COUNT(*) AS CNT " +
    "FROM USER_LOGS " +
    "WHERE USERNAME = :u " +
    "  AND ACTION = 'LOGIN_FAIL' " +
    "  AND E_DATE >= SYSDATE - :intervalDays";

  try {
    const result = await db.execute(
      sql,
      { u: username, intervalDays },
      {}
    );
    const rows = result.rows || [];
    const count = rows.length ? Number(rows[0].CNT) : 0;
    return {
      blocked: count >= config.loginMaxFailedAttempts,
      failedCount: count
    };
  } catch (err) {
    console.error("Cooldown check failed:", err);
    return { blocked: false, failedCount: 0 };
  }
}

/**
 * GET /api/motives
 * Load SPR_MOTIV_ACCESS for dropdown.
 */
router.get("/motives", async (req, res) => {
  try {
    const sql =
      "SELECT ID, TEXT " +
      "FROM SPR_MOTIV_ACCESS " +
      "ORDER BY TEXT";
    const result = await db.execute(sql, {}, {});
    const motives = (result.rows || []).map((row) => ({
      id: Number(row.ID),
      text: String(row.TEXT || "")
    }));

    res.json({
      success: true,
      motives
    });
  } catch (err) {
    console.error("SPR_MOTIV_ACCESS query failed:", err);
    res.status(500).json({
      success: false,
      error: "Nu s-au putut √ÆncƒÉrca motivele de acces."
    });
  }
});

/**
 * GET /api/ann
 * Public endpoint to get the latest system announcement.
 */
router.get("/ann", async (req, res) => {
  try {
    // Robust query: Order by ID descending, grab first row
    // Using ROWNUM wrapping for Oracle 11g compatibility
    const sql = `
      SELECT MESAJ 
      FROM (
        SELECT MESAJ 
        FROM PRISON.ANUNT 
        ORDER BY ID DESC
      ) 
      WHERE ROWNUM <= 1
    `;
    
    const result = await db.execute(sql, {}, {});
    const rows = result.rows || [];
    
    // Check if we have data
    if (rows.length > 0) {
      // NOTE: node-oracledb usually returns keys in UPPERCASE ('MESAJ')
      const msg = rows[0].MESAJ; 
      res.json({ success: true, message: msg });
    } else {
      res.json({ success: true, message: null });
    }
  } catch (err) {
    console.error("Public Ann error:", err);
    res.json({ success: false, error: "Eroare la incarcarea anuntului." });
  }
});

/**
 * POST /api/login
 * Body: { username, password, motivId }
 */
router.post("/login", async (req, res) => {
  const usernameRaw = (req.body.username || "").trim();
  const password = String(req.body.password || "");
  const motivId = Number(req.body.motivId || 0);

  if (!usernameRaw || !password || !motivId) {
    return res.status(400).json({
      success: false,
      error: "Utilizator, parolƒÉ »ôi motiv acces sunt obligatorii."
    });
  }

  // Adjust if your DB stores usernames uppercased
  const username = usernameRaw; // or usernameRaw.toUpperCase();

  // Cooldown check
  const { blocked } = await isLoginBlocked(username);
  if (blocked) {
    await logUserAction(
      username,
      "LOGIN_BLOCKED",
      "Cooldown after too many failed attempts"
    );
    return res.status(429).json({
      success: false,
      error: "Prea multe √ÆncercƒÉri e»ôuate. A»ôtepta»õi √Ænainte de a re√Æncerca.",
      code: "COOLDOWN",
      retryAfterMinutes: config.loginCooldownMinutes
    });
  }

  try {
    // 1. Load user
    const userSql =
      "SELECT ID, USERNAME, PASSWD, ID_PENITENTIAR, ID_ROLE " +
      "FROM USERS " +
      "WHERE USERNAME = :u";

    const userResult = await db.execute(userSql, { u: username }, {});
    const userRows = userResult.rows || [];

    if (!userRows.length) {
      await logUserAction(username, "LOGIN_FAIL", "Invalid username or password");
      return res.status(401).json({
        success: false,
        error: "Utilizator sau parolƒÉ incorectƒÉ."
      });
    }

    const userRow = userRows[0];
    const dbHash = userRow.PASSWD || "";

    if (!verifyPasswordLegacy(password, dbHash)) {
      await logUserAction(username, "LOGIN_FAIL", "Invalid username or password");
      return res.status(401).json({
        success: false,
        error: "Utilizator sau parolƒÉ incorectƒÉ."
      });
    }

    // 2. Load motive text
    const motivSql = "SELECT TEXT FROM SPR_MOTIV_ACCESS WHERE ID = :id";
    const motivResult = await db.execute(motivSql, { id: motivId }, {});
    const motivRows = motivResult.rows || [];

    if (!motivRows.length || !motivRows[0].TEXT) {
      return res.status(400).json({
        success: false,
        error: "Motiv de acces invalid."
      });
    }

    const motivText = String(motivRows[0].TEXT);

    // 3. Update USERS: LAST_LOGIN + NOTES
    const updateSql =
      "UPDATE USERS " +
      "SET LAST_LOGIN = SYSDATE, " +
      "    NOTES = :note " +
      "WHERE ID = :id";

    await db.execute(
      updateSql,
      {
        note: motivText.substring(0, 50), // NOTES is VARCHAR2(50)
        id: userRow.ID
      },
      { autoCommit: true }
    );

    // 4. Log success
    await logUserAction(username, "LOGIN_OK", motivText);

    // 5. Return user payload
    const userPayload = {
      id: Number(userRow.ID),
      username: String(userRow.USERNAME),
      id_penitentiary: userRow.ID_PENITENTIAR != null ? Number(userRow.ID_PENITENTIAR) : null,
      id_role: userRow.ID_ROLE != null ? Number(userRow.ID_ROLE) : null
    };

    return res.json({
      success: true,
      user: userPayload
    });
  } catch (err) {
    console.error("Login error:", err);
    return res.status(500).json({
      success: false,
      error: "Eroare internƒÉ la autentificare."
    });
  }
});

module.exports = router;
</file>

<file path="src/modules/detinut-add/client.js">
(function() {
    window.prisonModules = window.prisonModules || {};

    window.prisonModules.adaugaDetinut = {
        init: async function({ container }) {
            // Using inline styles to ensure layout ignores potential external CSS conflicts
            container.innerHTML = `
                <div class="admin-page" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                    <header class="admin-header-main" style="text-align: center; margin-bottom: 30px; width: 100%;">
                        <h1 class="admin-title">AdaugƒÉ De»õinut Nou</h1>
                        <p class="app-subtitle">√énregistrare primarƒÉ √Æn baza de date.</p>
                    </header>
                    
                    <div class="admin-panel" style="max-width: 800px; width: 100%; padding: 40px; box-sizing: border-box;">
                        <form id="addDetinutForm" autocomplete="off">
                            
                            <div class="form-group mb-4" style="text-align: center; margin-bottom: 2rem;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 700; color: #374151;">IDNP</label>
                                <input type="text" name="idnp" maxlength="13" 
                                       placeholder="xxxxxxxxxxxxx" 
                                       style="width: 100%; max-width: 400px; text-align: center; font-size: 1.2rem; letter-spacing: 0.15em; font-family: monospace; padding: 12px; margin: 0 auto; display: block; box-sizing: border-box;"
                                       required>
                            </div>

                            <hr style="border: 0; border-top: 1px solid #e5e7eb; margin: 24px 0;">

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="display: flex; flex-direction: column; text-align: center;">
                                    <label style="margin-bottom: 8px; font-weight: 600; color: #374151;">Nume (Familia)</label>
                                    <input type="text" name="nume" 
                                           style="width: 100%; text-align: center; padding: 10px; box-sizing: border-box;" 
                                           required>
                                </div>
                                <div style="display: flex; flex-direction: column; text-align: center;">
                                    <label style="margin-bottom: 8px; font-weight: 600; color: #374151;">Prenume</label>
                                    <input type="text" name="prenume" 
                                           style="width: 100%; text-align: center; padding: 10px; box-sizing: border-box;" 
                                           required>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="display: flex; flex-direction: column; text-align: center;">
                                    <label style="margin-bottom: 8px; font-weight: 600; color: #374151;">Patronimic</label>
                                    <input type="text" name="patronimic" placeholder="-"
                                           style="width: 100%; text-align: center; padding: 10px; box-sizing: border-box;">
                                </div>
                                <div style="display: flex; flex-direction: column; text-align: center;">
                                    <label style="margin-bottom: 8px; font-weight: 600; color: #374151;">Data Na»ôterii</label>
                                    <input type="date" name="data_nasterii_raw" 
                                           style="width: 100%; text-align: center; padding: 10px; box-sizing: border-box;" 
                                           required>
                                </div>
                            </div>

                            <div class="form-actions mt-6" style="display: flex; justify-content: center; gap: 16px; margin-top: 40px;">
                                <button type="button" class="btn-ghost" onclick="window.history.back()" style="min-width: 120px;">AnuleazƒÉ</button>
                                <button type="submit" class="btn-primary" style="min-width: 200px; justify-content: center;">üíæ SalveazƒÉ De»õinut</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            const form = document.getElementById('addDetinutForm');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const rawDate = form.data_nasterii_raw.value;
                if(!rawDate) { alert("Data na»ôterii este obligatorie"); return; }
                const [y, m, d] = rawDate.split('-');
                const formattedDate = `${d}.${m}.${y}`;

                const payload = {
                    idnp: form.idnp.value.trim(),
                    nume: form.nume.value.trim().toUpperCase(),
                    prenume: form.prenume.value.trim().toUpperCase(),
                    patronimic: form.patronimic.value.trim().toUpperCase(),
                    data_nasterii: formattedDate
                };

                try {
                    const resp = await window.prisonApi.post("/detinuti/add", payload);
                    if(resp.success) {
                        if(confirm("De»õinut adƒÉugat cu succes! Mergem la dosarul lui?")) {
                            window.location.hash = `#detinut?id=${resp.id}`;
                        } else {
                            form.reset();
                        }
                    } else {
                        alert("Eroare: " + resp.error);
                    }
                } catch(err) {
                    alert("Eroare de conexiune.");
                    console.error(err);
                }
            });
        }
    };
})();
</file>

<file path="src/modules/detinut-add/router.js">
const express = require("express");
const db = require("../../db");const oracledb = require("oracledb"); // <--- Ensures BIND_OUT and NUMBER are available
const router = express.Router();

// Middleware to check permissions (Roles 1, 7, 99)
async function checkPermission(req, res, next) {
  const uid = req.header("x-user-id");
  if (!uid) return res.status(401).json({ success: false, error: "Unauthorized" });

  try {
    const r = await db.execute("SELECT ID_ROLE FROM USERS WHERE ID = :id", { id: uid });
    if (r.rows.length > 0) {
      const role = Number(r.rows[0].ID_ROLE);
      // Roles allowed: 1, 7, 99
      if ([1, 7, 99].includes(role)) {
        return next();
      }
    }
    return res.status(403).json({ success: false, error: "Access denied." });
  } catch (err) {
    return res.status(500).json({ success: false, error: "Server error checking permissions." });
  }
}

router.post("/detinuti/add", checkPermission, async (req, res) => {
  const { nume, prenume, patronimic, data_nasterii, idnp } = req.body;

  // Basic validation
  if (!nume || !prenume || !data_nasterii || !idnp) {
    return res.json({ success: false, error: "Toate c√¢mpurile (mai pu»õin patronimic) sunt obligatorii." });
  }

  const sql = `
    INSERT INTO PRISON.DETINUTI (
      NAME, 
      SURNAME, 
      SEC_NAME, 
      BIRDTH, 
      IDNP,
      -- Defaults required by Non-Null constraints
      SEX, WPOLICE, ID_SPR_CATEG_SOCIAL, ID_SPR_EDU_LEVEL, 
      ID_HEALTH_STAT, ID_MAR_STATUS, ID_SPR_NATIONALITY, ID_SPR_RELIGION
    ) VALUES (
      :prenume, 
      :nume, 
      :patronimic, 
      TO_DATE(:dob, 'DD.MM.YYYY'), 
      :idnp,
      'M', 'N', 0, 0, 0, 0, 0, 0
    )
    RETURNING ID INTO :rid
  `;

  try {
    const result = await db.execute(
      sql, 
      {
        prenume: prenume,
        nume: nume,
        patronimic: patronimic || '-',
        dob: data_nasterii,
        idnp: idnp,
        // Using correct oracledb constants
        rid: { dir: oracledb.BIND_OUT, type: oracledb.NUMBER } 
      },
      { autoCommit: true } // <--- CRITICAL FIX: Commits the transaction
    );

    const newId = result.outBinds.rid ? result.outBinds.rid[0] : null;

    res.json({ success: true, message: "De»õinut adƒÉugat cu succes.", id: newId });

  } catch (err) {
    console.error("Add Detinut Error:", err);
    // Handle Unique Constraint on IDNP
    if (err.message.includes("unique constraint") && err.message.includes("IDNP")) {
      return res.json({ success: false, error: "Acest IDNP existƒÉ deja √Æn baza de date." });
    }
    res.status(500).json({ success: false, error: "Eroare la salvarea √Æn baza de date." });
  }
});

module.exports = router;
</file>

<file path="src/modules/health/router.js">
// src/routes/health.js
const express = require("express");
const db = require("../../db");
const router = express.Router();

/**
 * GET /api/health
 * Tries a trivial SELECT 1 FROM DUAL.
 * If it fails (Oracle client missing, DB down, etc.), we tell the frontend
 * that the DB connection is not available.
 */
router.get("/health", async (req, res) => {
  try {
    await db.execute("SELECT 1 FROM DUAL", {}, {});
    return res.json({
      success: true,
      dbAvailable: true
    });
  } catch (err) {
    console.error("DB health check failed:", err);
    return res.status(200).json({
      success: false,
      dbAvailable: false,
      message:
        "Pagina web este accesibilƒÉ dar conexiunea cu baza de date a e»ôuat. VƒÉ rugƒÉm contacta»õi-ne de urgen»õƒÉ la anp.siarprac@anp.gov.md."
    });
  }
});

module.exports = router;
</file>

<file path="src/modules/inmate/complici/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    
    let currentIdnp = null;
    let meta = null; // Cache for dropdown data (SPR_COMPLICI_STATUS)

    // --- METADATA LOADER ---
    async function fetchMeta() {
        if(meta) return;
        
        const res = await window.prisonApi.get('/detinut/meta/complici');
        if(res.success) meta = res;
        else throw new Error(res.error || "Nu s-au putut √ÆncƒÉrca nomenclatoarele pentru complici.");
    }

    // --- HTML & UI Helpers ---
    function injectCompliceModal() {
        if(document.getElementById('compliceModal')) return;

        // Modal for adding a new accomplice
        const html = `
        <div class="modal-overlay" id="compliceModal">
            <div class="modal-card" style="max-width:700px;">
                <div class="modal-header">
                    <h3 class="modal-title">AdaugƒÉ Complice</h3>
                    <button class="btn-close" onclick="window.compliceOps.closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="compliceForm" class="admin-form" onsubmit="return false;">
                        <div class="admin-grid-3">
                            <div class="f">
                                <label for="nume">Nume *</label>
                                <input type="text" id="nume" name="nume" class="full-width" required>
                            </div>
                            <div class="f">
                                <label for="prenume">Prenume *</label>
                                <input type="text" id="prenume" name="prenume" class="full-width" required>
                            </div>
                            <div class="f">
                                <label for="patronimic">Patronimic</label>
                                <input type="text" id="patronimic" name="patronimic" class="full-width">
                            </div>
                        </div>

                        <div class="admin-grid-3 mt-2">
                            <div class="f">
                                <label for="idnpComplice">IDNP Complice</label>
                                <input type="text" id="idnpComplice" name="idnpComplice" maxlength="13" class="full-width" placeholder="xxxxxxxxxxxxx">
                            </div>
                            <div class="f">
                                <label for="birthday">Data Na»ôterii</label>
                                <input type="text" id="birthday" name="birthday" class="datepicker full-width" placeholder="DD.MM.YYYY">
                            </div>
                            <div class="f">
                                <label for="idStatus">Status *</label>
                                <select name="idStatus" id="compliceStatusSelect" class="full-width" required></select>
                            </div>
                        </div>

                        <div class="admin-grid-2 mt-2">
                            <div class="f">
                                <label for="dosar">Nr. Dosar Penal</label>
                                <input type="text" id="dosar" name="dosar" class="full-width">
                            </div>
                            <div class="f">
                                <label for="hDate">Data HotƒÉr√¢rii (Dosar)</label>
                                <input type="text" id="hDate" name="hDate" class="datepicker full-width" placeholder="DD.MM.YYYY">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-ghost" onclick="window.compliceOps.closeModal()">AnuleazƒÉ</button>
                    <button class="btn-primary" id="btnCompliceSave" onclick="window.compliceOps.submitForm()">SalveazƒÉ</button>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // Initialize date pickers if available
        if (typeof window.flatpickr !== 'undefined') {
            flatpickr(document.getElementById('birthday'), { dateFormat: "d.m.Y" });
            flatpickr(document.getElementById('hDate'), { dateFormat: "d.m.Y" });
        }
    }
    
    function fillSelect(id, items) { 
        const el = document.getElementById(id); 
        if(!el) return;
        el.innerHTML = '<option value="">- SelecteazƒÉ -</option>' + 
                       items.map(i => `<option value="${i.ID}">${i.NAME}</option>`).join(''); 
    }

    // --- DATA & RENDERER ---
    async function loadComplici(container) {
        container.innerHTML = `<div class="loader-box">Se √ÆncarcƒÉ lista de complici...</div>`;
        
        try {
            const res = await window.prisonApi.get(`/detinut/${currentIdnp}/complici`);
            const rows = res.rows || [];
            const canWrite = res.canWrite; 

            const btnAdd = canWrite ? 
                `<button class="btn-primary" onclick="window.compliceOps.openModal()">+ AdaugƒÉ Complice</button>` : '';

            let html = `
                <div class="flex-between" style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:20px;">
                    <h2 style="margin:0; font-size:1.1rem; color:#1e293b;">Lista de Complici</h2>
                    ${btnAdd}
                </div>
            `;

            if (rows.length === 0) {
                html += `<div class="table-empty">Nu existƒÉ complici √Ænregistra»õi.</div>`;
            } else {
                html += `
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nume & Prenume</th>
                                    <th>IDNP / Data Na»ôterii</th>
                                    <th>Status</th>
                                    <th>Dosar Penal</th>
                                    <th style="width:100px; text-align:center;">Ac»õiuni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                html += rows.map(r => `
                    <tr>
                        <td><b>${r.NUME} ${r.PRENUME}</b> ${r.PATRONIMIC||'‚Äî'}</td>
                        <td>${r.IDNP || '‚Äî'} / ${r.BIRTHDAY_STR || '‚Äî'}</td>
                        <td><span class="badge ${r.ID_STATUS === 1 ? 'badge-info' : 'badge-default'}">${r.STATUS_NAME}</span></td>
                        <td>${r.DOSAR || '‚Äî'} ${r.HDATE_STR ? `(Hot. ${r.HDATE_STR})` : ''}</td>
                        <td class="text-center">
                            ${canWrite ? `<button class="btn-danger btn-tiny" onclick="window.compliceOps.delete(${r.ID})" title="»òterge Complice">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                            </button>` : '‚Äî'}
                        </td>
                    </tr>
                `).join('');

                html += `</tbody></table></div>`;
            }
            container.innerHTML = html;

        } catch (e) {
            console.error("Error loading complici:", e);
            container.innerHTML = `<div class="error-box">Eroare la √ÆncƒÉrcarea complicilor: ${e.message}</div>`;
        }
    }

    // --- GLOBAL OPERATIONS WRAPPER ---
    window.compliceOps = {
        openModal: () => {
            const modal = document.getElementById('compliceModal');
            const form = document.getElementById('compliceForm');
            if(form) form.reset();
            
            // Populate dropdown before opening
            if (meta && meta.compliciStatus) {
                fillSelect('compliceStatusSelect', meta.compliciStatus);
            }
            
            if(modal) modal.classList.add('open');
        },

        closeModal: () => {
            const modal = document.getElementById('compliceModal');
            if(modal) modal.classList.remove('open');
        },

        submitForm: async () => {
            const form = document.getElementById('compliceForm');
            const btn = document.getElementById('btnCompliceSave');
            const fd = new FormData(form);
            const payload = Object.fromEntries(fd);
            
            if(!payload.nume || !payload.prenume || !payload.idStatus) {
                alert("VƒÉ rugƒÉm completa»õi Nume, Prenume »ôi Statusul complicelui.");
                return; 
            }

            btn.disabled = true;
            btn.textContent = "Se salveazƒÉ...";

            try {
                const url = `/detinut/${currentIdnp}/complici`;
                const res = await window.prisonApi.post(url, payload);
                
                if(!res.success) throw new Error(res.error);
                
                window.compliceOps.closeModal();
                await loadComplici(document.getElementById('profileContent')); // Reload list
            } catch (e) {
                alert("Eroare la salvare: " + e.message); 
            } finally {
                btn.disabled = false;
                btn.textContent = "SalveazƒÉ";
            }
        },

        delete: async (id) => {
            if(!confirm("Sigur »ôterge»õi aceastƒÉ √Ænregistrare de complice?")) return;
            try {
                const res = await window.prisonApi.del(`/detinut/complici/${id}`);
                if (!res.success) throw new Error(res.error || "»òtergerea nu a reu»ôit.");
                await loadComplici(document.getElementById('profileContent')); // Reload list
            } catch(e) { 
                alert("Eroare la »ôtergere: " + e.message); 
            }
        }
    };

    // --- TAB RENDER ENTRY POINT ---
    window.DetinutTabs['complici'] = {
        render: async (container, detinutId) => {
             const idnp = window.currentDetinutData ? window.currentDetinutData.IDNP : null;
             if (!idnp) { 
                 container.innerHTML = '<div class="error-box">LipsƒÉ IDNP al de»õinutului.</div>'; 
                 return; 
             }
             currentIdnp = idnp;

             // 1. Fetch Metadata (Dropdowns)
             try {
                 await fetchMeta();
             } catch(e) {
                 container.innerHTML = `<div class="error-box">${e.message}</div>`;
                 return;
             }

             // 2. Inject Modal UI
             injectCompliceModal();
             
             // 3. Load & Render Data Table
             await loadComplici(container);
        }
    };
})();
</file>

<file path="src/modules/inmate/complici/router.js">
const express = require("express");
const db = require("../../../db");
const router = express.Router();

// Modulul ID 4 pentru "Complici" (presupus urmƒÉtorul ID)
const COMPLICI_MODULE_ID = 4; 

// --- Func»õii Helper (Copiate pentru modularitate) ---
function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}
const safe = (val) => (val === undefined || val === '') ? null : val;

/**
 * VerificƒÉ permisiunile utilizatorului pe un modul specific.
 */
async function checkPermission(userId, moduleId, requiredRight = 'R') {
  if (!userId) return false;
  try {
    const sql = `SELECT DREPT FROM PRISON.SPR_ACCESS WHERE ID_USER = :u AND ID_MODUL = :m`;
    const res = await db.execute(sql, { u: userId, m: moduleId });
    const right = res.rows.length ? res.rows[0].DREPT : null;
    
    if (!right) return false;
    
    if (requiredRight === 'R') return (right === 'R' || right === 'W');
    if (requiredRight === 'W') return (right === 'W');
    
    return false;
  } catch (e) { 
    console.error("Permission check failed:", e);
    return false;
  }
}

// --- METADATA ROUTE (SPR_COMPLICI_STATUS) ---
router.get("/detinut/meta/complici", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, COMPLICI_MODULE_ID, 'R')) {
      return res.status(403).json({ success: false, error: "Acces interzis la metadate." });
  }

  try {
    const statusRes = await db.execute("SELECT ID, NAME FROM PRISON.SPR_COMPLICI_STATUS ORDER BY NAME");
    res.json({
      success: true,
      compliciStatus: statusRes.rows
    });
  } catch(e) { 
    console.error("Error loading complici statuses:", e);
    res.status(500).json({success:false, error: "Eroare la √ÆncƒÉrcarea statutelor complicilor."}); 
  }
});


// --- LIST COMPLICI (GET) ---
router.get("/detinut/:idnp/complici", async (req, res) => {
    const uid = getUid(req);
    // Check Read Permission
    if (!await checkPermission(uid, COMPLICI_MODULE_ID, 'R')) {
        return res.status(403).json({ success: false, error: "Acces interzis (Permisiune R lipsƒÉ)." });
    }
    
    // Check Write Permission separately to enable/disable UI buttons
    const canWrite = await checkPermission(uid, COMPLICI_MODULE_ID, 'W');
    
    try {
        const sql = `
            SELECT C.ID, C.IDNP, C.NUME, C.PRENUME, C.PATRONIMIC, C.DOSAR, 
                   C.ID_STATUS,
                   TO_CHAR(C.BIRTHDAY, 'DD.MM.YYYY') as BIRTHDAY_STR,
                   TO_CHAR(C.HDATE, 'DD.MM.YYYY') as HDATE_STR,
                   SCS.NAME as STATUS_NAME
            FROM PRISON.COMPLICI C
            INNER JOIN PRISON.SPR_COMPLICI_STATUS SCS ON SCS.ID = C.ID_STATUS
            WHERE C.IDNP_DET = :idnp
            ORDER BY C.HDATE DESC
        `;
        const result = await db.execute(sql, { idnp: req.params.idnp });
        res.json({ success: true, rows: result.rows, canWrite });
    } catch (e) {
        console.error("Error listing complici:", e);
        res.status(500).json({ success: false, error: e.message });
    }
});

// --- ADD COMPLICE (POST) ---
router.post("/detinut/:idnp/complici", async (req, res) => {
    // Check Write Permission
    if (!await checkPermission(getUid(req), COMPLICI_MODULE_ID, 'W')) {
        return res.status(403).json({ success: false, error: "Permisiuni insuficiente pentru adƒÉugare (Permisiune W lipsƒÉ)." });
    }
    
    const { nume, prenume, patronimic, birthday, idnpComplice, dosar, hDate, idStatus } = req.body;
    
    // Basic validation
    if (!nume || !prenume || !idStatus) {
        return res.status(400).json({ success: false, error: "Nume, Prenume »ôi Statusul sunt obligatorii." });
    }

    try {
        // ID is populated by the trigger COMPLICI_TRG (using COMPLICI_SEQ.nextval)
        const sql = `
            INSERT INTO PRISON.COMPLICI (
                IDNP_DET, NUME, PRENUME, PATRONIMIC, IDNP, BIRTHDAY, HDATE, DOSAR, ID_STATUS
            ) VALUES (
                :idnp_det, :nume, :prenume, :patronimic, :idnpComplice, 
                ${birthday ? `TO_DATE(:birthday,'DD.MM.YYYY')` : `NULL`}, 
                ${hDate ? `TO_DATE(:hDate,'DD.MM.YYYY')` : `NULL`}, 
                :dosar, :idStatus
            )
        `;
        
        await db.execute(
            sql, 
            {
                idnp_det: req.params.idnp,
                nume: nume.toUpperCase(),
                prenume: prenume.toUpperCase(),
                patronimic: safe(patronimic),
                idnpComplice: safe(idnpComplice),
                birthday: safe(birthday),
                hDate: safe(hDate),
                dosar: safe(dosar),
                idStatus: Number(idStatus),
            }, 
            { autoCommit: true }
        ); 
        res.json({ success: true }); 
    } catch(e) { 
        console.error("Add Complice Error:", e);
        res.status(500).json({ success: false, error: e.message || "Eroare la adƒÉugarea complicelui." }); 
    }
});

// --- DELETE COMPLICE (DELETE) ---
router.delete("/detinut/complici/:id", async (req, res) => {
    // Check Write Permission
    if (!await checkPermission(getUid(req), COMPLICI_MODULE_ID, 'W')) {
        return res.status(403).json({ success: false, error: "Permisiuni insuficiente pentru »ôtergere (Permisiune W lipsƒÉ)." });
    }
    
    try { 
        const id = Number(req.params.id);
        const result = await db.execute("DELETE FROM PRISON.COMPLICI WHERE ID = :id", { id }, { autoCommit: true }); 
        
        if (result.rowsAffected === 0) {
            return res.status(404).json({ success: false, error: "√énregistrarea nu a fost gƒÉsitƒÉ." });
        }
        
        res.json({ success: true }); 
    } catch(e) { 
        console.error("Delete Complice Error:", e);
        res.status(500).json({ success: false, error: e.message || "Eroare la »ôtergerea complicelui." }); 
    }
});

module.exports = router;
</file>

<file path="src/modules/inmate/education/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    window.DetinutTabs['educatie'] = {
        render: (container, detinutId) => {
            // Placeholder content since this module is not yet fully implemented
            container.innerHTML = `<div class="admin-panel text-center"><p class="text-muted">Modulul Educa»õie este √ÆncƒÉ √Æn lucru. VƒÉ rugƒÉm reveni»õi mai t√¢rziu.</p></div>`;
        }
    };
})();
</file>

<file path="src/modules/inmate/education/router.js">
const express = require("express");
const db = require("../../../db"); // <-- CRITICAL FIX
const router = express.Router();

function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}
const safe = (val) => (val === undefined ? null : val);

// --- AUTH HELPER (Shared with other modules) ---
async function checkPermission(userId, moduleId, requiredRight = 'R') {
  if (!userId) return false;
  try {
    const sql = `SELECT DREPT FROM PRISON.SPR_ACCESS WHERE ID_USER = :u AND ID_MODUL = :m`;
    const res = await db.execute(sql, { u: userId, m: moduleId });
    const right = res.rows.length ? res.rows[0].DREPT : null;
    if (!right) return false;
    if (requiredRight === 'R') return (right === 'R' || right === 'W');
    if (requiredRight === 'W') return (right === 'W');
    return false;
  } catch (e) { return false; }
}

// =============================================================================
// EDUCATION ROUTES (ID 13-18)
// =============================================================================

// ID 13: INSTRUIRE (General, Prof, Alte)
router.get("/detinut/:idnp/educatie/instr_gen", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 13, 'R')) return res.status(403).json({ success: false, error: "Acces interzis." });
    const canWrite = await checkPermission(uid, 13, 'W');
    const resQ = await db.execute(`SELECT NAME_CLASA, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_PENITENCIAR FROM PRISON.V_INSTRUIRE_GENERALA WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});
router.get("/detinut/:idnp/educatie/instr_prof", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 13, 'R')) return res.status(403).json({ success: false, error: "Acces interzis." });
    const canWrite = await checkPermission(uid, 13, 'W');
    const resQ = await db.execute(`SELECT NAME_PROFESSION, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_PENITENCIAR FROM PRISON.V_INSTRUIRE_PROF WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});
router.get("/detinut/:idnp/educatie/instr_alte", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 13, 'R')) return res.status(403).json({ success: false, error: "Acces interzis." });
    const canWrite = await checkPermission(uid, 13, 'W');
    const resQ = await db.execute(`SELECT NAME_PROGRAM, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_PENITENCIAR, NAME_CALIFICATIV, NAME FROM PRISON.V_INSTRUIRE_ALTE WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

// ID 14: CULTURAL / SPORT
router.get("/detinut/:idnp/educatie/cultural", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 14, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 14, 'W');
    const resQ = await db.execute(`SELECT NAME, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_PENITENCIAR FROM PRISON.V_ACTIVITATE_CULTURAL WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});
router.get("/detinut/:idnp/educatie/sport", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 14, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 14, 'W');
    const resQ = await db.execute(`SELECT NAME, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_PENITENCIAR FROM PRISON.V_ACTIVITATE_CULTURAL WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

// ID 15: MUNCA (REM/NEREM)
router.get("/detinut/:idnp/educatie/munca_rem", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 15, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 15, 'W');
    const resQ = await db.execute(`SELECT NAME_REMUNERAT, WORK_PLACE, TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NRZILE, NAME_KOEFICIENT_NOCIV FROM PRISON.V_REMUNERAT WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

router.get("/detinut/:idnp/educatie/munca_nerem", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 15, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 15, 'W');
    const resQ = await db.execute(`SELECT ID, WORK_PLACE, TO_CHAR(ADATE, 'DD.MM.YYYY') as ADATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, HOURS FROM PRISON.NEREMUNERAT WHERE IDNP=:idnp ORDER BY ADATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});
router.post("/detinut/:idnp/educatie/munca_nerem", async (req, res) => {
    if (!await checkPermission(getUid(req), 15, 'W')) return res.status(403).json({ success: false });
    const { work_place, adate, edate, hours } = req.body;
    try { await db.execute("INSERT INTO PRISON.NEREMUNERAT (ID, IDNP, WORK_PLACE, ADATE, EDATE, HOURS) VALUES (PRISON.NEREMUNERAT_SEQ.NEXTVAL, :idnp, :wp, TO_DATE(:a,'DD.MM.YYYY'), TO_DATE(:e,'DD.MM.YYYY'), :h)", {idnp:req.params.idnp, wp:safe(work_place), a:safe(adate), e:safe(edate), h:safe(hours)}, {autoCommit:true}); res.json({success:true}); } catch(e){ res.status(500).json({success:false, error:e.message}); }
});
router.delete("/detinut/educatie/munca_nerem/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 15, 'W')) return res.status(403).json({ success: false });
    try { await db.execute("DELETE FROM PRISON.NEREMUNERAT WHERE ID=:id", {id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e){ res.status(500).json({success:false, error:e.message}); }
});

// ID 16: SANCTIUNI
router.get("/detinut/:idnp/educatie/sanctiuni", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 16, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 16, 'W');
    const resQ = await db.execute(`SELECT TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(EDATE, 'DD.MM.YYYY') as EDATE, NAME_SANCTIUNE, FACTS FROM PRISON.V_SANCTIUNI WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

// ID 17: STIMULARI
router.get("/detinut/:idnp/educatie/stimulari", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 17, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 17, 'W');
    const resQ = await db.execute(`SELECT TO_CHAR(ADATE, 'DD.MM.YYYY') as ADATE, NAME_STIMULARE, FACTS FROM PRISON.V_STIMULARI WHERE IDNP=:idnp ORDER BY ADATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

// ID 18: CARACTERISTICA
router.get("/detinut/:idnp/educatie/caracteristica", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 18, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 18, 'W');
    const resQ = await db.execute(`SELECT TO_CHAR(BDATE, 'DD.MM.YYYY') as BDATE, PENITENCIAR, STATUS, EXECUTPROGRAM, COMPORTAMENT FROM PRISON.V_CARACTERISTICA WHERE IDNP=:idnp ORDER BY BDATE DESC`, {idnp:req.params.idnp});
    res.json({success:true, rows:resQ.rows, canWrite});
});

module.exports = router;
</file>

<file path="src/modules/inmate/garantii/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};

    let currentIdnp = null;
    let currentDetId = null;
    let selectedFile = null; // Store file selected via drag or input

    // --- RENDER FUNCTION ---
    window.DetinutTabs['garantii'] = {
        render: async (container, detinutId) => {
            currentDetId = detinutId;
            if (window.currentDetinutData) {
                currentIdnp = window.currentDetinutData.IDNP;
            } else {
                try {
                    const r = await window.prisonApi.get(`/detinut/${detinutId}/general`);
                    if(r.success) currentIdnp = r.data.IDNP;
                } catch(e) {}
            }

            if (!currentIdnp) {
                container.innerHTML = `<div class="error-box">Eroare: IDNP lipsƒÉ pentru acest de»õinut.</div>`;
                return;
            }

            // Inject Modal HTML
            injectGarantModal();

            // Build UI layout
            container.innerHTML = `
                <div class="admin-panel">
                    <div class="flex-between" style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:20px;">
                        <div>
                            <h2 style="margin:0; color:#dc2626;">Garan»õii de Stat (PDF)</h2>
                            <p class="text-muted" style="margin:4px 0 0 0; font-size:0.9rem;">
                                √éncƒÉrca»õi documentele scanate privind garan»õiile de stat.
                            </p>
                        </div>
                        <button class="btn-primary" onclick="window.garantOps.openModal()">
                            ‚¨ÜÔ∏è AdaugƒÉ Document
                        </button>
                    </div>

                    <div id="garantListArea">
                        <div class="loader-box">Se √ÆncarcƒÉ lista...</div>
                    </div>
                </div>
            `;

            // Initial Load
            await loadFiles();
        }
    };

    // --- MODAL INJECTION ---
    function injectGarantModal() {
        if(document.getElementById('garantModal')) return;

        const html = `
        <div class="modal-overlay" id="garantModal">
            <div class="modal-card">
                <div class="modal-header">
                    <h3 class="modal-title">√éncƒÉrcare Garan»õie de Stat</h3>
                    <button class="btn-close" onclick="window.garantOps.closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="garantUploadForm" class="admin-form" onsubmit="return false;">
                        
                        <div class="upload-area" id="garantDropArea">
                            <div class="upload-icon">üìÑ</div>
                            <div class="upload-text" id="garantDropText">Trage fi»ôierul PDF aici sau click pentru a selecta</div>
                            <input type="file" id="garantFileInput" accept="application/pdf" hidden>
                        </div>
                        
                        <div class="f mt-4">
                            <label>Descriere Document</label>
                            <input type="text" name="descriere" id="garantDesc" class="full-width" placeholder="ex: HotƒÉr√¢re judecƒÉtoreascƒÉ nr..." autocomplete="off">
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-ghost" onclick="window.garantOps.closeModal()">AnuleazƒÉ</button>
                    <button class="btn-primary" id="btnGarantSave" onclick="window.garantOps.submitUpload()">√éncarcƒÉ</button>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);

        // Setup Drag & Drop Events
        setTimeout(() => {
            const area = document.getElementById('garantDropArea');
            const input = document.getElementById('garantFileInput');
            
            if(!area || !input) return;

            area.onclick = () => input.click();
            
            input.onchange = (e) => {
                handleFileSelect(e.target.files[0]);
            };

            area.ondragover = (e) => { e.preventDefault(); area.classList.add('dragover'); };
            area.ondragleave = () => area.classList.remove('dragover');
            area.ondrop = (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files[0]);
            };
        }, 500);
    }

    function handleFileSelect(file) {
        const textEl = document.getElementById('garantDropText');
        const descEl = document.getElementById('garantDesc');

        if (!file) return;
        if (file.type !== 'application/pdf') {
            alert("Doar fi»ôiere PDF sunt acceptate!");
            return;
        }
        
        selectedFile = file;
        textEl.textContent = `‚úÖ Selectat: ${file.name}`;
        textEl.style.color = '#15803d';
        textEl.style.fontWeight = 'bold';

        // Auto-fill description if empty
        if (!descEl.value) {
            descEl.value = file.name.replace('.pdf', '');
        }
    }

    // --- LOGIC HELPER ---
    async function loadFiles() {
        const listArea = document.getElementById('garantListArea');
        if (!listArea) return;

        try {
            const res = await window.prisonApi.get(`/detinut/${currentIdnp}/garantii`);
            const rows = res.rows || [];

            if (rows.length === 0) {
                listArea.innerHTML = `<div class="table-empty">Nu existƒÉ documente √ÆncƒÉrcate.</div>`;
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Descriere Document</th>
                                <th style="width:180px;">Data √éncƒÉrcƒÉrii</th>
                                <th style="width:150px; text-align:center;">Ac»õiuni</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            html += rows.map(r => `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:1.2rem; color:#dc2626;">üìÑ</span>
                            <span style="font-weight:600; color:#1e293b;">${r.DESCRIERE}</span>
                        </div>
                    </td>
                    <td>${r.DATA_UPLOAD}</td>
                    <td class="text-center">
                        <a href="/api/detinut/${currentIdnp}/garantii/download/${r.ID}" target="_blank" class="btn-ghost btn-tiny" style="text-decoration:none;">‚¨áÔ∏è PDF</a>
                        <button class="btn-danger btn-tiny" onclick="window.garantOps.delete(${r.ID})">»òterge</button>
                    </td>
                </tr>
            `).join('');

            html += `</tbody></table></div>`;
            listArea.innerHTML = html;

        } catch (e) {
            listArea.innerHTML = `<div class="error-box">Eroare: ${e.message}</div>`;
        }
    }

    // --- GLOBAL OPERATIONS ---
    window.garantOps = {
        openModal: () => {
            selectedFile = null;
            const modal = document.getElementById('garantModal');
            const form = document.getElementById('garantUploadForm');
            const textEl = document.getElementById('garantDropText');
            
            if(form) form.reset();
            if(textEl) {
                textEl.textContent = "Trage fi»ôierul PDF aici sau click pentru a selecta";
                textEl.style.color = "";
                textEl.style.fontWeight = "";
            }
            if(modal) modal.classList.add('open');
        },

        closeModal: () => {
            const modal = document.getElementById('garantModal');
            if(modal) modal.classList.remove('open');
        },

        submitUpload: async () => {
            if (!selectedFile) {
                alert("VƒÉ rugƒÉm selecta»õi un fi»ôier PDF.");
                return;
            }

            const descInput = document.getElementById('garantDesc');
            const desc = descInput.value.trim() || selectedFile.name;
            const btn = document.getElementById('btnGarantSave');

            const formData = new FormData();
            formData.append('pdf', selectedFile);
            formData.append('descriere', desc);

            btn.disabled = true;
            btn.textContent = "Se √ÆncarcƒÉ...";

            try {
                const userId = sessionStorage.getItem("prison.userId");
                const res = await fetch(`/api/detinut/${currentIdnp}/garantii`, {
                    method: 'POST',
                    headers: { "x-user-id": userId },
                    body: formData
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);

                window.garantOps.closeModal();
                await loadFiles();
                
                // Refresh Badge Logic (Optional: force reload module/header)
                if(document.getElementById('detinutHeader')) {
                     const nameEl = document.querySelector('.header-name');
                     if(nameEl && !nameEl.querySelector('.badge-guarantee')) {
                         nameEl.insertAdjacentHTML('beforeend', '<div style="font-size:0.5em; line-height:1; vertical-align:middle; display:inline-block;"><div class="badge-guarantee">‚ö†Ô∏è GARAN»öII DE STAT!</div></div>');
                     }
                }

            } catch (e) {
                alert("Eroare la √ÆncƒÉrcare: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "√éncarcƒÉ";
            }
        },

        delete: async (id) => {
            if (!confirm("Sigur »ôterge»õi acest document?")) return;
            try {
                await window.prisonApi.del(`/detinut/garantii/${id}`);
                await loadFiles();
                
                // Remove badge if list empty (lazy check)
                // Ideally backend tells us status, but we can guess or refresh header
                const listArea = document.getElementById('garantListArea');
                if(listArea && listArea.innerText.includes("Nu existƒÉ documente")) {
                     const badge = document.querySelector('.badge-guarantee');
                     if(badge) badge.parentElement.remove();
                }

            } catch (e) {
                alert("Eroare la »ôtergere: " + e.message);
            }
        }
    };
})();
</file>

<file path="src/modules/inmate/garantii/router.js">
const express = require("express");
const db = require("../../../db");
const router = express.Router();
const multer = require("multer");
const fs = require("fs");
const path = require("path");
const oracledb = require("oracledb");

// --- CONFIGURATION ---
const PHOTOS_BASE_DIR = path.join(process.cwd(), "public/resources/photos");
const TEMP_DIR = path.join(process.cwd(), "public/resources/temp_uploads");

if (!fs.existsSync(TEMP_DIR)) {
  try { fs.mkdirSync(TEMP_DIR, { recursive: true }); } catch (e) {}
}

const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, TEMP_DIR),
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + '.pdf');
  }
});

const upload = multer({ 
    storage: storage,
    fileFilter: (req, file, cb) => {
        if (file.mimetype === 'application/pdf') {
            cb(null, true);
        } else {
            cb(new Error('Doar fi»ôiere PDF sunt acceptate!'));
        }
    },
    limits: { fileSize: 10 * 1024 * 1024 } // 10MB limit
});

function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}

// --- FIX IP FUNCTION ---
function getIp(req) {
  let ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress || '127.0.0.1';
  
  // 1. DacƒÉ sunt mai multe IP-uri (prin proxy), luƒÉm primul
  if (ip.indexOf(',') > -1) {
      ip = ip.split(',')[0].trim();
  }

  // 2. CurƒÉ»õƒÉm prefixul IPv6 specific Node.js (::ffff:) pentru a rƒÉm√¢ne cu IPv4 curat
  // Ex: ::ffff:192.168.1.5 (16 chars) devine 192.168.1.5 (11 chars)
  if (ip.startsWith('::ffff:')) {
      ip = ip.substring(7);
  }

  // 3. For»õƒÉm limita de 15 caractere a bazei de date
  return ip.substring(0, 15);
}

async function syncFolderPending(idnp) {
    const countRes = await db.execute(
        "SELECT COUNT(*) AS CNT FROM PRISON.PENDINGFOLDER WHERE IDNP = :p_idnp", 
        { p_idnp: idnp }
    );
    const count = countRes.rows[0].CNT;
    const flag = count > 0 ? 'Y' : 'N';

    await db.execute(
        "UPDATE PRISON.DETINUTI SET FOLDERPENDING = :p_flag WHERE IDNP = :p_idnp",
        { p_flag: flag, p_idnp: idnp },
        { autoCommit: true }
    );
}

// --- ROUTES ---

// 1. LIST
router.get("/detinut/:idnp/garantii", async (req, res) => {
    try {
        const sql = `
            SELECT ID, DESCRIERE, TO_CHAR(INSERTEDDATE, 'DD.MM.YYYY HH24:MI') as DATA_UPLOAD 
            FROM PRISON.PENDINGFOLDER 
            WHERE IDNP = :p_idnp 
            ORDER BY INSERTEDDATE DESC
        `;
        const result = await db.execute(sql, { p_idnp: req.params.idnp });
        res.json({ success: true, rows: result.rows });
    } catch (e) {
        res.status(500).json({ success: false, error: e.message });
    }
});

// 2. UPLOAD
router.post("/detinut/:idnp/garantii", upload.single('pdf'), async (req, res) => {
    const userId = getUid(req);
    const idnp = req.params.idnp;
    
    if (!req.file) return res.status(400).json({ success: false, error: "LipsƒÉ fi»ôier PDF." });

    try {
        const dir1 = idnp.charAt(0);
        const targetDir = path.join(PHOTOS_BASE_DIR, dir1, idnp, "garant");
        
        if (!fs.existsSync(targetDir)) {
            fs.mkdirSync(targetDir, { recursive: true });
        }

        const desc = req.body.descriere || req.file.originalname;
        const userIp = getIp(req); // Folosim func»õia fixatƒÉ

        const insertSql = `
            INSERT INTO PRISON.PENDINGFOLDER (
                IDNP, DESCRIERE, USERID, IPUSER, INSERTEDDATE, DOCUMENTDATE
            ) VALUES (
                :p_idnp, :p_desc, :p_uid, :p_ip, SYSDATE, SYSDATE
            ) RETURNING ID INTO :p_rid
        `;
        
        const dbRes = await db.execute(insertSql, {
            p_idnp: idnp,
            p_desc: desc,
            p_uid: userId,
            p_ip: userIp,
            p_rid: { dir: oracledb.BIND_OUT, type: oracledb.NUMBER }
        }, { autoCommit: true });

        const newId = dbRes.outBinds.p_rid[0];
        const finalPath = path.join(targetDir, `${newId}.pdf`);
        fs.renameSync(req.file.path, finalPath);

        await syncFolderPending(idnp);

        res.json({ success: true, id: newId });

    } catch (e) {
        if (req.file && fs.existsSync(req.file.path)) fs.unlinkSync(req.file.path);
        console.error("Upload error:", e);
        res.status(500).json({ success: false, error: e.message });
    }
});

// 3. DELETE
router.delete("/detinut/garantii/:id", async (req, res) => {
    const fileId = req.params.id;
    try {
        const infoRes = await db.execute("SELECT IDNP FROM PRISON.PENDINGFOLDER WHERE ID = :p_id", { p_id: fileId });
        if (!infoRes.rows.length) throw new Error("Fi»ôierul nu existƒÉ.");
        
        const idnp = infoRes.rows[0].IDNP;
        
        await db.execute("DELETE FROM PRISON.PENDINGFOLDER WHERE ID = :p_id", { p_id: fileId }, { autoCommit: true });

        const dir1 = idnp.charAt(0);
        const filePath = path.join(PHOTOS_BASE_DIR, dir1, idnp, "garant", `${fileId}.pdf`);
        if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
        }

        await syncFolderPending(idnp);
        res.json({ success: true });
    } catch (e) {
        res.status(500).json({ success: false, error: e.message });
    }
});

// 4. DOWNLOAD
router.get("/detinut/:idnp/garantii/download/:id", async (req, res) => {
    try {
        const idnp = req.params.idnp;
        const id = req.params.id;
        
        const dbRes = await db.execute("SELECT DESCRIERE FROM PRISON.PENDINGFOLDER WHERE ID = :p_id AND IDNP = :p_idnp", { p_id: id, p_idnp: idnp });
        if (!dbRes.rows.length) return res.status(404).send("File record not found.");
        
        const originalName = dbRes.rows[0].DESCRIERE;
        const dir1 = idnp.charAt(0);
        const filePath = path.join(PHOTOS_BASE_DIR, dir1, idnp, "garant", `${id}.pdf`);

        if (fs.existsSync(filePath)) {
            let downloadName = originalName.endsWith('.pdf') ? originalName : originalName + '.pdf';
            downloadName = downloadName.replace(/[^a-z0-9\.]/gi, '_');
            res.download(filePath, downloadName);
        } else {
            res.status(404).send("Physical file missing.");
        }
    } catch (e) {
        res.status(500).send(e.message);
    }
});

module.exports = router;
</file>

<file path="src/modules/inmate/hotariri/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    
    // State
    let meta = null;
    let _idnp = null;
    let _canWrite = false;

    // --- HELPERS ---

    // DB returns "2023-11-20T10:00:00.000Z" OR "20.11.2023"
    // We want PURE "20.11.2023" with no time.
    function formatDisplayDate(val) {
        if (!val) return '';
        let str = String(val);
        
        // If it contains "T", chop it off immediately to avoid timezone shifts
        if (str.includes('T')) {
            str = str.split('T')[0]; // "2023-11-20"
        }

        // If it matches YYYY-MM-DD
        if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const parts = str.split('-');
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }

        // If it matches DD.MM.YYYY, return as is
        if (str.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
            return str;
        }

        return str; // Fallback
    }

    // Convert API/DB format to Input format (YYYY-MM-DD)
    function toInputDate(val) {
        if (!val) return "";
        let str = String(val);

        if (str.includes('T')) {
            str = str.split('T')[0];
            return str;
        }
        
        // Handle DD.MM.YYYY -> YYYY-MM-DD
        if (str.includes('.')) {
            const parts = str.split(".");
            if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        return str;
    }

    // Convert Input format (YYYY-MM-DD) to API/DB format (DD.MM.YYYY)
    function toDbDate(str) {
        if (!str) return "";
        const parts = str.split("-");
        if (parts.length !== 3) return str;
        return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }

    async function fetchMeta() {
        if (meta) return;
        const res = await window.prisonApi.get('/detinut/meta/hotariri');
        if (res.success) meta = res;
    }

    function opts(items, selectedId) {
        return '<option value="">- Selecta»õi -</option>' + 
               (items || []).map(i => `<option value="${i.ID}" ${String(i.ID) === String(selectedId) ? 'selected' : ''}>${i.NAME}</option>`).join('');
    }

    // --- RENDER MAIN ---
    async function render(container, detinutId) {
        _idnp = window.currentDetinutData ? window.currentDetinutData.IDNP : null;
        if (!_idnp) {
            container.innerHTML = '<div class="error-box">LipsƒÉ IDNP.</div>';
            return;
        }

        container.innerHTML = `<div class="loader-box">Se √ÆncarcƒÉ hotƒÉr√¢rile...</div>`;

        try {
            await fetchMeta();
            const data = await window.prisonApi.get(`/detinut/${_idnp}/hotariri`);
            
            _canWrite = data.canWrite;

            // Polished CSS injection
            const style = `
            <style>
                /* Modal Polish */
                .modal-overlay {
                    backdrop-filter: blur(2px);
                    background: rgba(0,0,0,0.5);
                }
                .modal-hotariri {
                    display: flex;
                    flex-direction: column;
                    max-height: 85vh; /* Fit within viewport */
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    border: 1px solid #cbd5e1;
                    border-radius: 8px;
                }
                .modal-hotariri .modal-body {
                    overflow-y: auto;
                    padding: 20px;
                    background: #fff;
                }
                .modal-hotariri .modal-footer {
                    border-top: 1px solid #e2e8f0;
                    padding: 15px 20px;
                    background: #f8fafc;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                }

                /* Grid Layout */
                .hotarire-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                }
                .full-width { grid-column: 1 / -1; }
                
                /* Labels & Inputs */
                .form-group label {
                    display: block;
                    font-size: 0.75rem;
                    color: #475569;
                    font-weight: 600;
                    text-transform: uppercase;
                    margin-bottom: 5px;
                }
                .form-group input, .form-group select, .form-group textarea {
                    width: 100%;
                    padding: 8px 10px;
                    border: 1px solid #cbd5e1;
                    border-radius: 6px;
                    font-size: 0.9rem;
                    transition: border-color 0.2s;
                }
                .form-group input:focus, .form-group select:focus {
                    border-color: #3b82f6;
                    outline: none;
                }
                
                /* Read-Only Mode */
                .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
                    background-color: #f8fafc;
                    color: #334155;
                    border-color: #e2e8f0;
                    cursor: not-allowed;
                }

                /* Section Headers */
                .section-header {
                    grid-column: 1 / -1;
                    font-size: 1rem;
                    font-weight: 700;
                    color: #1e293b;
                    border-bottom: 2px solid #e2e8f0;
                    padding-bottom: 5px;
                    margin-top: 15px;
                    margin-bottom: 10px;
                }
                .section-header:first-child { margin-top: 0; }

                /* Term Inputs Group */
                .term-group {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    background: #f1f5f9;
                    padding: 5px;
                    border-radius: 6px;
                }
                .term-wrapper { display: flex; flex-direction: column; align-items: center; flex: 1; }
                .term-wrapper input { text-align: center; font-weight: bold; }
                .term-wrapper span { font-size: 0.65rem; color: #64748b; margin-top: 2px; }

                /* Data Table adjustments */
                .data-table th { background: #f8fafc; color: #475569; font-weight: 600; font-size: 0.8rem; }
                .data-table td { vertical-align: middle; font-size: 0.9rem; }
                
                /* Sub-modal Add Section */
                .sub-add-box {
                    margin-bottom:10px; 
                    padding:10px; 
                    background:#f1f5f9; 
                    border-radius:6px; 
                    border:1px solid #e2e8f0;
                }
            </style>`;

            let html = style + `
                <div class="admin-panel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>HotƒÉr√¢ri Active</h3>
                        ${_canWrite ? `<button class="btn-primary" onclick="window.hotaririOps.openAdd()">+ AdaugƒÉ HotƒÉr√¢re</button>` : ''}
                    </div>
                    ${renderTable(data.active, false)}
                    
                    <h3 style="margin-top:40px; color:#94a3b8; font-size:1rem; border-bottom:1px solid #e2e8f0; padding-bottom:5px;">Antecedente (ArhivƒÉ)</h3>
                    ${renderTable(data.antecedents, true)}
                </div>
                ${renderModals()}
            `;
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `<div class="error-box">${e.message}</div>`;
        }
    }

    function renderTable(rows, isAntecedent) {
        if (!rows || rows.length === 0) return `<div class="p-3 text-muted" style="background:#f8fafc; border-radius:6px; text-align:center;">Nu existƒÉ √ÆnregistrƒÉri.</div>`;
        
        return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="100">Data</th>
                        <th>Document / Dosar</th>
                        <th>Pedeapsa</th>
                        <th>Penitenciar</th>
                        <th>Perioada</th>
                        <th width="120" class="text-center">Ac»õiuni</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(r => `
                        <tr>
                            <td>${formatDisplayDate(r.D_DATE)}</td>
                            <td>
                                <div style="font-weight:600; color:#0f172a;">${r.DOCUMENTNAME || 'Nedefinit'}</div>
                                ${r.NRDOSARPENAL ? `<div style="font-size:0.8rem; color:#64748b;">Dosar: ${r.NRDOSARPENAL}</div>` : ''}
                            </td>
                            <td>
                                <span style="background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px; font-weight:600; font-size:0.85rem;">
                                    ${r.TERMENULANI}a ${r.TERMENULLUNI}l ${r.TERMENULZILE}z
                                </span>
                            </td>
                            <td>${r.NAMETIPPENITENCIAR || '-'}</td>
                            <td>
                                <div style="font-size:0.85rem; line-height:1.4;">
                                    <span style="color:#15803d">Start:</span> ${formatDisplayDate(r.B_DATE)}<br/>
                                    <span style="color:#b91c1c">Stop:</span> ${formatDisplayDate(r.E_DATE)}
                                </div>
                            </td>
                            <td class="text-center">
                                ${!isAntecedent ? `
                                    <div style="display:flex; justify-content:center; gap:5px;">
                                        <button class="btn-tiny" onclick="window.hotaririOps.openSubModules(${r.ID})" title="Sub-module">‚öôÔ∏è</button>
                                        
                                        <!-- Edit OR View Button -->
                                        <button class="btn-tiny ${_canWrite ? '' : 'btn-secondary'}" 
                                            onclick="window.hotaririOps.openEdit(${r.ID})" 
                                            title="${_canWrite ? 'EditeazƒÉ' : 'VizualizeazƒÉ Detalii'}">
                                            ${_canWrite ? '‚úèÔ∏è' : 'üëÅÔ∏è'}
                                        </button>

                                        ${_canWrite ? `
                                            <button class="btn-tiny btn-danger" onclick="window.hotaririOps.delete(${r.ID})" title="»òterge">üóëÔ∏è</button>
                                        ` : ''}
                                    </div>
                                ` : '<span class="text-muted" style="font-size:0.8rem">Arhivat</span>'}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;
    }

    function renderModals() {
        return `
        <!-- Main Modal -->
        <div id="hotarireModal" class="modal-overlay">
            <div class="modal-card modal-hotariri" style="max-width:900px; width:95%;">
                <div class="modal-header">
                    <h3 class="modal-title" id="hotarireModalTitle">Gestionare HotƒÉr√¢re</h3>
                    <button class="btn-close" onclick="window.closeModal('hotarireModal')">&times;</button>
                </div>
                
                <div class="modal-body">
                    <form id="hotarireForm" class="hotarire-grid">
                        
                        <div class="section-header">1. Informa»õii Generale</div>
                        
                        <div class="form-group">
                            <label>Data HotƒÉr√¢rii</label>
                            <input type="date" name="d_date">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Tip Document</label>
                            <select name="id_tip_hot_jud">${opts(meta.tipDoc)}</select>
                        </div>
                        <div class="form-group">
                            <label>Nr. Dosar Penal</label>
                            <input type="text" name="nrdosarpenal" placeholder="Ex: 1-25/2023">
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label>Instan»õa de JudecatƒÉ</label>
                            <select name="id_instante">${opts(meta.instante)}</select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Nume JudecƒÉtor</label>
                            <input type="text" name="judecator">
                        </div>

                         <div class="form-group full-width">
                            <label>Organ de UrmƒÉrire PenalƒÉ</label>
                            <select name="id_organup">${opts(meta.instanteUp)}</select>
                        </div>

                        <div class="section-header">2. Pedeapsa »ôi Termene</div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label>Termen de Executare</label>
                            <div class="term-group">
                                <div class="term-wrapper"><input type="number" name="termenulani" min="0" placeholder="0"><span>ANI</span></div>
                                <div class="term-wrapper"><input type="number" name="termenulluni" min="0" placeholder="0"><span>LUNI</span></div>
                                <div class="term-wrapper"><input type="number" name="termenulzile" min="0" placeholder="0"><span>ZILE</span></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>√énceput Termen</label>
                            <input type="date" name="b_date">
                        </div>
                        <div class="form-group">
                            <label>Data DefinitivƒÉ</label>
                            <input type="date" name="definitiv">
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label>Tip Penitenciar</label>
                            <select name="id_tip_penitenciar">${opts(meta.tipPen)}</select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Condi»õii Eliberare</label>
                            <select name="id_tip_elib_cond">${opts(meta.tipElib)}</select>
                        </div>

                        <div class="section-header">3. Sanc»õiuni Complementare</div>

                        <div class="form-group">
                            <label>AmendƒÉ (MDL)</label>
                            <input type="text" name="amenda" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Prejudiciu (MDL)</label>
                            <input type="text" name="prejudiciu" placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                             <label>MuncƒÉ Nerem.</label>
                             <div class="term-group">
                                <div class="term-wrapper"><input type="number" name="muncaneremunzile" placeholder="0"><span>ZILE</span></div>
                                <div class="term-wrapper"><input type="number" name="muncaneremunore" placeholder="0"><span>ORE</span></div>
                             </div>
                        </div>
                        <div class="form-group">
                             <label>Arest Domiciliu</label>
                             <div class="term-group">
                                <div class="term-wrapper"><input type="number" name="arestdomzile" placeholder="0"><span>ZILE</span></div>
                                <div class="term-wrapper"><input type="number" name="arestdomore" placeholder="0"><span>ORE</span></div>
                             </div>
                        </div>

                        <div class="form-group">
                             <label>Deten»õie pe via»õƒÉ?</label>
                             <select name="perlife">
                                <option value="N">NU</option>
                                <option value="Y">DA</option>
                             </select>
                        </div>

                        <div class="form-group full-width">
                            <label>Note »ôi Observa»õii</label>
                            <textarea name="note" rows="3" placeholder="Alte detalii..."></textarea>
                        </div>

                    </form>
                </div>
                
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="window.closeModal('hotarireModal')">√énchide</button>
                    <button class="btn-primary" id="btnSaveHotarire" onclick="window.hotaririOps.save()">SalveazƒÉ ModificƒÉrile</button>
                </div>
            </div>
        </div>

        <!-- Sub Modal -->
        <div id="subModal" class="modal-overlay">
            <div class="modal-card modal-hotariri" style="max-width:700px;">
                 <div class="modal-header">
                    <h3 class="modal-title">Detalii Avansate</h3>
                    <button class="btn-close" onclick="window.closeModal('subModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="admin-tabs" style="margin-bottom:15px; background:#f1f5f9; padding:5px; border-radius:6px; display:inline-flex;">
                        <button class="admin-tab-btn active" onclick="window.hotaririOps.switchSubTab('art', event)">Articole</button>
                        <button class="admin-tab-btn" onclick="window.hotaririOps.switchSubTab('int', event)">Intervale</button>
                        <button class="admin-tab-btn" onclick="window.hotaririOps.switchSubTab('red', event)">Reduceri</button>
                    </div>
                    <div id="subContent"></div>
                </div>
            </div>
        </div>`;
    }

    // --- LOGIC ---
    window.hotaririOps = {
        currentId: null,

        openAdd: () => {
            window.hotaririOps.currentId = null;
            document.getElementById('hotarireForm').reset();
            const title = document.getElementById('hotarireModalTitle');
            const saveBtn = document.getElementById('btnSaveHotarire');
            const inputs = document.getElementById('hotarireForm').querySelectorAll('input, select, textarea');

            // Reset permissions UI
            title.textContent = "AdaugƒÉ HotƒÉr√¢re";
            saveBtn.style.display = 'inline-block';
            inputs.forEach(i => i.disabled = false);

            document.getElementById('hotarireModal').classList.add('open');
        },

        openEdit: async (id) => {
            const res = await window.prisonApi.get(`/detinut/${_idnp}/hotariri`);
            const row = res.active.find(r => r.ID == id);
            if (!row) return;

            window.hotaririOps.currentId = id;
            const f = document.getElementById('hotarireForm');
            const title = document.getElementById('hotarireModalTitle');
            const saveBtn = document.getElementById('btnSaveHotarire');
            const inputs = f.querySelectorAll('input, select, textarea');
            
            f.d_date.value = toInputDate(row.D_DATE);
            f.id_tip_hot_jud.value = row.ID_TIP_HOT_JUD || '';
            f.nrdosarpenal.value = row.NRDOSARPENAL || '';
            f.id_instante.value = row.ID_INSTANTE || '';
            f.judecator.value = row.JUDECATOR || '';
            f.id_organup.value = row.ID_ORGANUP || '';

            f.termenulani.value = row.TERMENULANI || 0;
            f.termenulluni.value = row.TERMENULLUNI || 0;
            f.termenulzile.value = row.TERMENULZILE || 0;

            f.b_date.value = toInputDate(row.B_DATE);
            f.definitiv.value = toInputDate(row.DEFINITIV);
            f.id_tip_penitenciar.value = row.ID_TIP_PENITENCIAR || '';
            f.id_tip_elib_cond.value = row.ID_TIP_ELIB_COND || '';

            f.amenda.value = row.AMENDA || '';
            f.prejudiciu.value = row.PREJUDICIU || '';
            f.muncaneremunzile.value = row.MUNCANEREMUNZILE || 0;
            f.muncaneremunore.value = row.MUNCANEREMUNORE || 0; 
            f.arestdomzile.value = row.ARESTDOMZILE || 0;
            f.arestdomore.value = row.ARESTDOMORE || 0;
            f.perlife.value = row.PERLIFE || 'N';
            f.note.value = row.NOTE || '';

            // Handle Read-Only Mode
            if (_canWrite) {
                title.textContent = "Editare HotƒÉr√¢re";
                saveBtn.style.display = 'inline-block';
                inputs.forEach(i => i.disabled = false);
            } else {
                title.textContent = "Detalii HotƒÉr√¢re (Vizualizare)";
                saveBtn.style.display = 'none';
                inputs.forEach(i => i.disabled = true);
            }

            document.getElementById('hotarireModal').classList.add('open');
        },

        save: async () => {
            if (!_canWrite) return; // Guard
            const form = document.getElementById('hotarireForm');
            const fd = new FormData(form);
            const payload = Object.fromEntries(fd);
            
            ['d_date', 'definitiv', 'b_date'].forEach(k => {
                if(payload[k]) payload[k] = toDbDate(payload[k]);
            });

            const id = window.hotaririOps.currentId;
            const url = id ? `/detinut/hotariri/${id}` : `/detinut/${_idnp}/hotariri`;
            const method = id ? 'PUT' : 'POST';

            try {
                if (method === 'PUT') {
                   const headers = { "Content-Type": "application/json", "x-user-id": sessionStorage.getItem("prison.userId") };
                   const res = await fetch(`/api${url}`, { method: 'PUT', headers, body: JSON.stringify(payload) });
                   const json = await res.json();
                   if(!json.success) throw new Error(json.error || "Eroare salvare");
                } else {
                   await window.prisonApi.post(url, payload);
                }

                window.closeModal('hotarireModal');
                window.DetinutTabs['hotariri'].render(document.getElementById('profileContent'), _idnp);
            } catch (e) {
                alert("Eroare: " + e.message);
            }
        },

        delete: async (id) => {
            if (!confirm("Sigur »ôterge»õi?")) return;
            try {
                await window.prisonApi.del(`/detinut/hotariri/${id}`);
                window.DetinutTabs['hotariri'].render(document.getElementById('profileContent'), _idnp);
            } catch (e) {
                alert(e.message);
            }
        },

        openSubModules: (id) => {
            window.hotaririOps.currentId = id;
            document.getElementById('subModal').classList.add('open');
            window.hotaririOps.switchSubTab('art');
        },

        switchSubTab: async (tab, event) => {
            if(event) {
                document.querySelectorAll('#subModal .admin-tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            }
            const container = document.getElementById('subContent');
            const id = window.hotaririOps.currentId;
            container.innerHTML = '<div class="loader-box">...</div>';

            if (tab === 'art') {
                const res = await window.prisonApi.get(`/detinut/hotariri/${id}/articole`);
                container.innerHTML = `
                    ${_canWrite ? `
                    <div class="sub-add-box">
                        <h5 style="margin-bottom:8px; margin-top:0; font-size:0.9rem;">AdaugƒÉ Articol</h5>
                        <div style="display:flex; gap:8px;">
                            <input type="text" id="add_art" placeholder="Art" style="width:70px; padding:5px;">
                            <input type="text" id="add_alin" placeholder="Alin" style="width:70px; padding:5px;">
                            <input type="text" id="add_lit" placeholder="Lit" style="width:70px; padding:5px;">
                            <button class="btn-primary" style="padding:5px 15px;" onclick="window.hotaririOps.addSub('art')">AdaugƒÉ</button>
                        </div>
                    </div>` : ''}
                    <table class="compact-table" style="width:100%">
                        <thead><tr><th>Articol</th><th>Alineat</th><th>Litera</th><th></th></tr></thead>
                        <tbody>
                            ${(res.rows||[]).map(r => `
                                <tr>
                                    <td>${r.ID_ARTICOL}</td>
                                    <td>${r.ID_ALINEAT||'-'}</td>
                                    <td>${r.ID_LETTER||'-'}</td>
                                    <td class="text-right">${_canWrite ? `<span class="del-x" style="cursor:pointer; color:red; font-weight:bold;" onclick="window.hotaririOps.delSub('articole', ${r.ID}, 'art')">&times;</span>` : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } else if (tab === 'int') {
                const res = await window.prisonApi.get(`/detinut/hotariri/${id}/intervale`);
                 container.innerHTML = `
                    ${_canWrite ? `
                    <div class="sub-add-box">
                        <h5 style="margin-bottom:8px; margin-top:0; font-size:0.9rem;">AdaugƒÉ Interval Exclus</h5>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="date" id="add_bdate" style="padding:5px;">
                            <span>-></span>
                            <input type="date" id="add_edate" style="padding:5px;">
                            <button class="btn-primary" style="padding:5px 15px;" onclick="window.hotaririOps.addSub('int')">AdaugƒÉ</button>
                        </div>
                    </div>` : ''}
                    <table class="compact-table" style="width:100%">
                        <thead><tr><th>√énceput</th><th>Sf√¢r»ôit</th><th></th></tr></thead>
                        <tbody>
                            ${(res.rows||[]).map(r => `
                                <tr>
                                    <td>${r.B_DATE}</td>
                                    <td>${r.E_DATE}</td>
                                    <td class="text-right">${_canWrite ? `<span class="del-x" style="cursor:pointer; color:red; font-weight:bold;" onclick="window.hotaririOps.delSub('intervale', ${r.ID}, 'int')">&times;</span>` : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            } else if (tab === 'red') {
                const res = await window.prisonApi.get(`/detinut/hotariri/${id}/reduceri`);
                container.innerHTML = `
                    ${_canWrite ? `
                    <div class="sub-add-box">
                        <h5 style="margin-bottom:8px; margin-top:0; font-size:0.9rem;">AdaugƒÉ Reducere</h5>
                        <div style="display:flex; gap:8px;">
                            <input type="number" id="add_zile" placeholder="Zile" style="width:80px; padding:5px;">
                            <select id="add_mec" style="flex:1; padding:5px;">${opts(meta.mecReduc)}</select>
                            <button class="btn-primary" style="padding:5px 15px;" onclick="window.hotaririOps.addSub('red')">AdaugƒÉ</button>
                        </div>
                    </div>` : ''}
                    <table class="compact-table" style="width:100%">
                        <thead><tr><th>Zile</th><th>Mecanism</th><th></th></tr></thead>
                        <tbody>
                            ${(res.rows||[]).map(r => `
                                <tr>
                                    <td>${r.NRZILE}</td>
                                    <td>${r.MECANISM_NAME}</td>
                                    <td class="text-right">${_canWrite ? `<span class="del-x" style="cursor:pointer; color:red; font-weight:bold;" onclick="window.hotaririOps.delSub('reduceri', ${r.ID}, 'red')">&times;</span>` : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
            }
        },

        addSub: async (type) => {
            const id = window.hotaririOps.currentId;
            let payload = {};
            let url = "";

            if (type === 'art') {
                payload = {
                    articol: document.getElementById('add_art').value,
                    aliniat: document.getElementById('add_alin').value,
                    litera: document.getElementById('add_lit').value
                };
                url = `/detinut/hotariri/${id}/articole`;
            } else if (type === 'int') {
                payload = {
                    b_date: toDbDate(document.getElementById('add_bdate').value),
                    e_date: toDbDate(document.getElementById('add_edate').value)
                };
                url = `/detinut/hotariri/${id}/intervale`;
            } else if (type === 'red') {
                // ADDED PARSE INT to fix invalid number error
                const nrzile = parseInt(document.getElementById('add_zile').value, 10);
                if (isNaN(nrzile)) {
                    alert("NumƒÉrul de zile trebuie sƒÉ fie valid.");
                    return;
                }

                payload = {
                    idnp: _idnp,
                    nrzile: nrzile,
                    id_mecanism: document.getElementById('add_mec').value
                };
                url = `/detinut/hotariri/${id}/reduceri`;
            }

            try {
                await window.prisonApi.post(url, payload);
                window.hotaririOps.switchSubTab(type);
            } catch (e) {
                alert("Eroare: " + e.message);
            }
        },

        delSub: async (endpoint, subId, tabKey) => {
            if(!confirm("»òterge»õi?")) return;
            try {
                await window.prisonApi.del(`/detinut/${endpoint}/${subId}`);
                window.hotaririOps.switchSubTab(tabKey);
            } catch (e) { alert(e.message); }
        }
    };

    window.DetinutTabs['hotariri'] = { render };
})();
</file>

<file path="src/modules/inmate/hotariri/router.js">
const express = require("express");
const db = require("../../../db");
const router = express.Router();

// Module ID 4 = Hotariri
const MODULE_ID = 4;

// Helper: Get User ID from header
function getUid(req) {
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0;
}

// Helper: Safe value for binds (convert undefined/empty to null)
const safe = (val) => (val === undefined || val === '' || val === 'null') ? null : val;

// Helper: Check Permissions
async function checkPermission(userId, moduleId, requiredRight = 'R') {
  if (!userId) return false;
  try {
    const sql = `SELECT DREPT FROM PRISON.SPR_ACCESS WHERE ID_USER = :b_u AND ID_MODUL = :b_m`;
    const res = await db.execute(sql, { b_u: userId, b_m: moduleId });
    const right = res.rows.length ? res.rows[0].DREPT : null;
    if (!right) return false;
    if (requiredRight === 'R') return (right === 'R' || right === 'W');
    if (requiredRight === 'W') return (right === 'W');
    return false;
  } catch (e) {
    console.error("Permission check failed:", e);
    return false;
  }
}

// Helper: Get Username for audit/logging
async function getUsername(userId) {
  try {
    const res = await db.execute("SELECT USERNAME FROM USERS WHERE ID = :b_id", { b_id: userId });
    return res.rows.length ? res.rows[0].USERNAME : 'SYSTEM';
  } catch (e) { return 'UNKNOWN'; }
}

// ==========================================
// 1. METADATA ROUTES
// ==========================================
router.get("/detinut/meta/hotariri", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'R')) {
    return res.status(403).json({ success: false, error: "Acces interzis." });
  }

  try {
    const [tipDoc, tipPen, instante, instanteUp, tipElib, mecReduc] = await Promise.all([
      db.execute("SELECT ID, NAME FROM SPR_TIPDOCJURIDIC ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM SPR_TIP_PENITENCIAR ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM SPR_INSTANTE WHERE ACTIV = 1 ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM SPR_INSTANTEUP ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM SPR_TIP_ELIB_COND ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM SPR_MECANISMREDUCERETERMEN ORDER BY NAME")
    ]);

    res.json({
      success: true,
      tipDoc: tipDoc.rows,
      tipPen: tipPen.rows,
      instante: instante.rows,
      instanteUp: instanteUp.rows,
      tipElib: tipElib.rows,
      mecReduc: mecReduc.rows
    });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// ==========================================
// 2. LIST ROUTES
// ==========================================
router.get("/detinut/:idnp/hotariri", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'R')) {
    return res.status(403).json({ success: false, error: "Acces interzis." });
  }
  const canWrite = await checkPermission(uid, MODULE_ID, 'W');

  try {
    // We select * to ensure all columns are available. 
    // Date formatting (stripping T00:00:00) is handled in the client.
    const activeRes = await db.execute(
      `SELECT * FROM V_OPEN_HOTARIRI WHERE IDNP = :b_idnp ORDER BY D_DATE ASC`, 
      { b_idnp: req.params.idnp }
    );
    
    const antRes = await db.execute(
      `SELECT * FROM V_ANTECEDENTE WHERE IDNP = :b_idnp ORDER BY D_DATE ASC`, 
      { b_idnp: req.params.idnp }
    );

    res.json({ 
      success: true, 
      active: activeRes.rows || [], 
      antecedents: antRes.rows || [],
      canWrite 
    });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// ==========================================
// 3. MAIN CRUD ROUTES (HOTARIRI_JUD)
// ==========================================

// INSERT
router.post("/detinut/:idnp/hotariri", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'W')) return res.status(403).json({ success: false });

  const body = req.body;
  
  // Using b_ prefix to ensure NO reserved words conflict (like USER, DATE, TYPE)
  const sql = `
    INSERT INTO HOTARIRI_JUD (
      IDNP, D_DATE, ID_TIP_HOT_JUD, TERMENULANI, TERMENULLUNI, TERMENULZILE,
      ID_TIP_PENITENCIAR, DEFINITIV, AMENDA, PREJUDICIU,
      MUNCANEREMUNZILE, MUNCANEREMUNORE, ARESTDOMZILE, ARESTDOMORE,
      PERLIFE, ID_INSTANTE, JUDECATOR, NRDOSARPENAL, ID_ORGANUP,
      B_DATE, ID_TIP_ELIB_COND, NOTE
    ) VALUES (
      :b_idnp, TO_DATE(:b_d_date, 'DD.MM.YYYY'), :b_id_tip, :b_ani, :b_luni, :b_zile,
      :b_id_pen, TO_DATE(:b_definitiv, 'DD.MM.YYYY'), :b_amenda, :b_prejudiciu,
      :b_mn_zile, :b_mn_ore, :b_ad_zile, :b_ad_ore,
      :b_perlife, :b_id_inst, :b_judecator, :b_dosar, :b_id_org_up,
      TO_DATE(:b_b_date, 'DD.MM.YYYY'), :b_id_elib, :b_note
    )
  `;

  try {
    await db.execute(sql, {
      b_idnp: req.params.idnp,
      b_d_date: safe(body.d_date),
      b_id_tip: safe(body.id_tip_hot_jud),
      b_ani: safe(body.termenulani),
      b_luni: safe(body.termenulluni),
      b_zile: safe(body.termenulzile),
      b_id_pen: safe(body.id_tip_penitenciar),
      b_definitiv: safe(body.definitiv),
      b_amenda: safe(body.amenda),
      b_prejudiciu: safe(body.prejudiciu),
      b_mn_zile: safe(body.muncaneremunzile),
      b_mn_ore: safe(body.muncaneremunore),
      b_ad_zile: safe(body.arestdomzile),
      b_ad_ore: safe(body.arestdomore),
      b_perlife: safe(body.perlife),
      b_id_inst: safe(body.id_instante),
      b_judecator: safe(body.judecator),
      b_dosar: safe(body.nrdosarpenal),
      b_id_org_up: safe(body.id_organup),
      b_b_date: safe(body.b_date),
      b_id_elib: safe(body.id_tip_elib_cond),
      b_note: safe(body.note)
    }, { autoCommit: true });

    res.json({ success: true });
  } catch (e) {
    console.error("Add Hotarire Error:", e);
    res.status(500).json({ success: false, error: e.message });
  }
});

// UPDATE
router.put("/detinut/hotariri/:id", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'W')) return res.status(403).json({ success: false });

  const body = req.body;

  const sql = `
    UPDATE HOTARIRI_JUD SET 
      D_DATE = TO_DATE(:b_d_date, 'DD.MM.YYYY'),
      ID_TIP_HOT_JUD = :b_id_tip,
      TERMENULANI = :b_ani,
      TERMENULLUNI = :b_luni,
      TERMENULZILE = :b_zile,
      ID_TIP_PENITENCIAR = :b_id_pen,
      DEFINITIV = TO_DATE(:b_definitiv, 'DD.MM.YYYY'),
      AMENDA = :b_amenda,
      PREJUDICIU = :b_prejudiciu,
      MUNCANEREMUNZILE = :b_mn_zile,
      MUNCANEREMUNORE = :b_mn_ore,
      ARESTDOMZILE = :b_ad_zile,
      ARESTDOMORE = :b_ad_ore,
      PERLIFE = :b_perlife,
      ID_INSTANTE = :b_id_inst,
      JUDECATOR = :b_judecator,
      NRDOSARPENAL = :b_dosar,
      ID_ORGANUP = :b_id_org_up,
      B_DATE = TO_DATE(:b_b_date, 'DD.MM.YYYY'),
      ID_TIP_ELIB_COND = :b_id_elib,
      NOTE = :b_note
    WHERE ID = :b_id
  `;

  try {
    await db.execute(sql, {
      b_id: req.params.id,
      b_d_date: safe(body.d_date),
      b_id_tip: safe(body.id_tip_hot_jud),
      b_ani: safe(body.termenulani),
      b_luni: safe(body.termenulluni),
      b_zile: safe(body.termenulzile),
      b_id_pen: safe(body.id_tip_penitenciar),
      b_definitiv: safe(body.definitiv),
      b_amenda: safe(body.amenda),
      b_prejudiciu: safe(body.prejudiciu),
      b_mn_zile: safe(body.muncaneremunzile),
      b_mn_ore: safe(body.muncaneremunore),
      b_ad_zile: safe(body.arestdomzile),
      b_ad_ore: safe(body.arestdomore),
      b_perlife: safe(body.perlife),
      b_id_inst: safe(body.id_instante),
      b_judecator: safe(body.judecator),
      b_dosar: safe(body.nrdosarpenal),
      b_id_org_up: safe(body.id_organup),
      b_b_date: safe(body.b_date),
      b_id_elib: safe(body.id_tip_elib_cond),
      b_note: safe(body.note)
    }, { autoCommit: true });

    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// DELETE
router.delete("/detinut/hotariri/:id", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'W')) return res.status(403).json({ success: false });

  try {
    await db.execute("DELETE FROM HOTARIRI_JUD WHERE ID = :b_id", { b_id: req.params.id }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// ==========================================
// 4. SUB-MODULE: ARTICOLE
// ==========================================

router.get("/detinut/hotariri/:id/articole", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'R')) return res.status(403).json({ success: false });

  try {
    const sql = `SELECT * FROM ARTICOLES WHERE ID_DOCUMENT = :b_id AND TYPE_DOCUMENT = '2' ORDER BY ID ASC`;
    const result = await db.execute(sql, { b_id: req.params.id });
    res.json({ success: true, rows: result.rows });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.post("/detinut/hotariri/:id/articole", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'W')) return res.status(403).json({ success: false });

  const { articol, aliniat, litera } = req.body;

  try {
    const sql = `
      INSERT INTO ARTICOLES (ID_DOCUMENT, TYPE_DOCUMENT, ID_ARTICOL, ID_ALINEAT, ID_LETTER) 
      VALUES (:b_id, '2', :b_art, :b_alin, :b_lit)
    `;
    await db.execute(sql, {
      b_id: req.params.id,
      b_art: safe(articol),
      b_alin: safe(aliniat),
      b_lit: safe(litera)
    }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.delete("/detinut/articole/:id", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'W')) return res.status(403).json({ success: false });
  try {
    await db.execute("DELETE FROM ARTICOLES WHERE ID = :b_id", { b_id: req.params.id }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// ==========================================
// 5. SUB-MODULE: INTERVALE
// ==========================================

router.get("/detinut/hotariri/:id/intervale", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'R')) return res.status(403).json({ success: false });
  try {
    // Format dates directly in SQL for cleaner consumption
    const sql = `
      SELECT ID, TO_CHAR(B_DATE, 'DD.MM.YYYY') as B_DATE, TO_CHAR(E_DATE, 'DD.MM.YYYY') as E_DATE 
      FROM INTERVALEXCLUS 
      WHERE ID_HOTARIRE = :b_id
    `;
    const result = await db.execute(sql, { b_id: req.params.id });
    res.json({ success: true, rows: result.rows });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.post("/detinut/hotariri/:id/intervale", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'W')) return res.status(403).json({ success: false });
  const { b_date, e_date } = req.body;
  try {
    const sql = `
      INSERT INTO INTERVALEXCLUS (ID_HOTARIRE, B_DATE, E_DATE) 
      VALUES (:b_id, TO_DATE(:b_start,'DD.MM.YYYY'), TO_DATE(:b_end,'DD.MM.YYYY'))
    `;
    await db.execute(sql, { 
      b_id: req.params.id, 
      b_start: safe(b_date), 
      b_end: safe(e_date) 
    }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.delete("/detinut/intervale/:id", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'W')) return res.status(403).json({ success: false });
  try {
    await db.execute("DELETE FROM INTERVALEXCLUS WHERE ID = :b_id", { b_id: req.params.id }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

// ==========================================
// 6. SUB-MODULE: REDUCERI
// ==========================================

router.get("/detinut/hotariri/:id/reduceri", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'R')) return res.status(403).json({ success: false });
  try {
    const sql = `
      SELECT reduc.ID, reduc.NRZILE, spr_reduc.NAME AS MECANISM_NAME 
      FROM PRISON.REDUCERETERMEN reduc 
      INNER JOIN PRISON.SPR_MECANISMREDUCERETERMEN spr_reduc ON (reduc.IDMECANISMREDUCERE = spr_reduc.ID) 
      WHERE reduc.IDHOTARIRE = :b_id
    `;
    const result = await db.execute(sql, { b_id: req.params.id });
    res.json({ success: true, rows: result.rows });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.post("/detinut/hotariri/:id/reduceri", async (req, res) => {
  const uid = getUid(req);
  if (!await checkPermission(uid, MODULE_ID, 'W')) return res.status(403).json({ success: false });
  
  const { idnp, nrzile, id_mecanism } = req.body;
  const username = await getUsername(uid);
  const ip = req.ip || '0.0.0.0';

  try {
    const sql = `
      INSERT INTO REDUCERETERMEN (IDNP, IDHOTARIRE, NRZILE, IDMECANISMREDUCERE, CREATEDBY, CREATEDIPUSER, INSERTEDDATE) 
      VALUES (:b_idnp, :b_id, :b_zile, :b_mec, :b_user, :b_ip, SYSDATE)
    `;
    await db.execute(sql, { 
      b_idnp: safe(idnp), 
      b_id: req.params.id, 
      b_zile: safe(nrzile), 
      b_mec: safe(id_mecanism),
      b_user: username,
      b_ip: ip
    }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

router.delete("/detinut/reduceri/:id", async (req, res) => {
  if (!await checkPermission(getUid(req), MODULE_ID, 'W')) return res.status(403).json({ success: false });
  try {
    await db.execute("DELETE FROM REDUCERETERMEN WHERE ID = :b_id", { b_id: req.params.id }, { autoCommit: true });
    res.json({ success: true });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

module.exports = router;
</file>

<file path="src/modules/inmate/medical/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    let meta = null; // Caches dropdown data
    let currentIdnp = null;
    let permissions = {};

    // --- CONFIGURATION ---
    // IDs correspond to database module IDs: 7=Greva, 8=Diagnoza, 10=Radio, 11=Consult
    const SUB_MODULES = [
        { key: 'greva',       label: 'Greva Foamei',        moduleId: 7 },
        { key: 'diagnoza',    label: 'DiagnozƒÉ MedicalƒÉ',   moduleId: 8 },
        { key: 'radiografie', label: 'Radiografie',         moduleId: 10 },
        { key: 'consultare',  label: 'Consultare ExternƒÉ',  moduleId: 11 }
    ];

    // --- PERMISSION HELPER ---
    // Fetches permissions for the specific medical modules for current user
    async function loadPermissions(userId) {
        if (Object.keys(permissions).length > 0) return; // already loaded
        try {
            const res = await window.prisonApi.get(`/profile?userId=${userId}`);
            if(res.success && res.permissions) {
                res.permissions.forEach(p => {
                    permissions[p.moduleId] = p.drept; // 'R', 'W' or null
                });
            }
        } catch(e) { console.error("Perms load error", e); }
    }

    function getRight(moduleId) {
        return permissions[moduleId] || null; // 'R', 'W', or null
    }

    // --- METADATA LOADER ---
    async function fetchMeta() {
        if(meta) return;
        const res = await window.prisonApi.get('/detinut/meta/medical');
        if(res.success) meta = res;
        else throw new Error("Nu s-au putut √ÆncƒÉrca nomenclatoarele medicale.");
    }

    // --- HTML GENERATORS ---
    function renderLayout(container, allowedTabs) {
        injectMedModal();
        
        if (allowedTabs.length === 0) {
            container.innerHTML = `<div class="admin-panel text-center"><p class="text-muted">Nu ave»õi drepturi de vizualizare pentru niciun sub-modul medical.</p></div>`;
            return;
        }

        container.innerHTML = `
          <div class="module-container">
            <div class="module-sidebar">
               <h4>Dosar Medical</h4>
               <nav id="medNav">
                 ${allowedTabs.map(t => `<button class="side-nav-btn" data-key="${t.key}">${t.label}</button>`).join('')}
               </nav>
            </div>
            <div class="module-content" id="medContent">
               <div class="loader-box">Selecta»õi o categorie.</div>
            </div>
          </div>
        `;

        // Bind clicks
        const navBtns = container.querySelectorAll('.side-nav-btn');
        const content = container.querySelector('#medContent');

        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadSubModule(btn.dataset.key, content);
            });
        });

        // Click first
        if (navBtns.length > 0) navBtns[0].click();
    }

    async function loadSubModule(key, container) {
        container.innerHTML = '<div class="loader-box">Se √ÆncarcƒÉ...</div>';
        
        try {
            // Fetch data
            const res = await window.prisonApi.get(`/detinut/${currentIdnp}/medical/${key}`);
            if(!res.success) throw new Error(res.error);

            // Re-verify Write permission from server response to be safe
            const serverCanWrite = res.canWrite; 
            
            renderTable(container, key, res.rows, serverCanWrite);
        } catch(e) {
            container.innerHTML = `<div class="error-box">Eroare: ${e.message}</div>`;
        }
    }

    function renderTable(container, key, rows, canWrite) {
        let cols = [];
        let rowMapper = null;
        let title = "";

        // Define Table Structure
        if (key === 'greva') {
            title = "Greva Foamei";
            cols = ["Data Start", "Data Stop", "Motiv"];
            rowMapper = r => `<td>${r.BDATE}</td><td>${r.EDATE||'‚Äî'}</td><td>${r.MOTIV||'‚Äî'}</td>`;
        } else if (key === 'diagnoza') {
            title = "Diagnoze Medicale";
            cols = ["Data", "Cod", "Diagnostic", "Note"];
            rowMapper = r => `<td>${r.ADATE}</td><td><span class="badge badge-none">${r.DIAGNOZ_COD||'?'}</span></td><td>${r.DIAGNOZ_NAME}</td><td>${r.NOTE||''}</td>`;
        } else if (key === 'radiografie') {
            title = "Radiografii";
            cols = ["Data", "Rezultat", "Penitenciar", "Comentarii"];
            rowMapper = r => `<td>${r.ADATE}</td><td><span class="badge ${r.REZULTAT==='Patologic'?'badge-write':'badge-read'}">${r.REZULTAT||'-'}</span></td><td>${r.PENITENCIAR||'-'}</td><td>${r.COMMENTS||''}</td>`;
        } else if (key === 'consultare') {
            title = "ConsultƒÉri Externe";
            cols = ["Data", "Doctor", "Institu»õie", "Investiga»õie"];
            rowMapper = r => `<td>${r.ADATE}</td><td>${r.NPP_DOCTOR||'-'}</td><td>${r.HOSPITAL||'-'}</td><td>${r.INVESTIGATIE||'-'}</td>`;
        }

        const btnAdd = canWrite ? `<button class="btn-primary btn-small" onclick="window.medOps.openAdd('${key}')">+ AdaugƒÉ</button>` : '';

        let html = `
            <div class="flex-between" style="border-bottom:1px solid #e2e8f0; padding-bottom:12px; margin-bottom:16px;">
                <h3 style="margin:0; font-size:1.1rem; color:#1e293b;">${title}</h3>
                ${btnAdd}
            </div>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>${cols.map(c => `<th>${c}</th>`).join('')}${canWrite ? '<th style="width:100px; text-align:center;">Ac»õiuni</th>' : ''}</tr>
                    </thead>
                    <tbody>
        `;

        if (rows.length === 0) {
            html += `<tr><td colspan="${cols.length + (canWrite?1:0)}" class="table-empty">Nu existƒÉ √ÆnregistrƒÉri.</td></tr>`;
        } else {
            html += rows.map(r => {
                // Escape JSON for onclick safety
                const safeJson = JSON.stringify(r).replace(/"/g, '&quot;');
                let act = '';
                if(canWrite) {
                    act = `<td class="text-center">
                        <button class="btn-ghost btn-tiny" onclick="window.medOps.openEdit('${key}', ${safeJson})">‚úèÔ∏è</button>
                        <button class="btn-danger btn-tiny" onclick="window.medOps.del('${key}', ${r.ID})">√ó</button>
                    </td>`;
                }
                return `<tr>${rowMapper(r)}${act}</tr>`;
            }).join('');
        }

        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    // --- MODAL & FORMS ---
    function injectMedModal() {
        if(document.getElementById('medModal')) return;
        const html = `
        <div class="modal-overlay" id="medModal">
            <div class="modal-card">
                <div class="modal-header">
                    <h3 class="modal-title" id="medTitle">√énregistrare</h3>
                    <button class="btn-close" onclick="window.medOps.close()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="medForm" class="admin-form"></form>
                </div>
                <div class="modal-footer">
                    <button class="btn-ghost" onclick="window.medOps.close()">AnuleazƒÉ</button>
                    <button class="btn-primary" onclick="window.medOps.submit()">SalveazƒÉ</button>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // Builds form fields dynamically based on type
    function getFormFields(key, d = {}) {
        const today = new Date().toLocaleDateString('ro-RO');
        const opts = (arr, selId) => (arr||[]).map(i => `<option value="${i.ID}" ${String(i.ID) === String(selId) ? 'selected' : ''}>${i.NAME}</option>`).join('');

        if (key === 'greva') {
            return `
                <div class="admin-grid-2">
                    <div class="f"><label>Data Start</label><input type="text" name="bdate" class="datepicker" value="${d.BDATE || today}" placeholder="DD.MM.YYYY"></div>
                    <div class="f"><label>Data Stop</label><input type="text" name="edate" class="datepicker" value="${d.EDATE || ''}" placeholder="DD.MM.YYYY"></div>
                </div>
                <div class="f mt-4"><label>Motivul Grevei</label><select name="id_motiv" class="full-width"><option value="">- SelecteazƒÉ -</option>${opts(meta.motives, d.ID_MOTIV)}</select></div>
            `;
        }
        if (key === 'diagnoza') {
            return `
                <div class="f"><label>Data Diagnosticului</label><input type="text" name="adate" class="datepicker" value="${d.ADATE || today}" placeholder="DD.MM.YYYY"></div>
                <div class="f"><label>Diagnostic (ICD)</label><select name="id_diagnoz" class="full-width search-select"><option value="">- CautƒÉ Diagnostic -</option>${opts(meta.diagnoz, d.ID_DIAGNOZ)}</select></div>
                <div class="f"><label>Note / Detalii</label><textarea name="note" rows="3" class="full-width">${d.NOTE || ''}</textarea></div>
            `;
        }
        if (key === 'radiografie') {
            return `
                <div class="f"><label>Data EfectuƒÉrii</label><input type="text" name="adate" class="datepicker" value="${d.ADATE || today}" placeholder="DD.MM.YYYY"></div>
                <div class="admin-grid-2">
                    <div class="f"><label>Rezultat</label><select name="id_resultat" class="full-width">${opts(meta.results, d.ID_RESULTAT)}</select></div>
                    <div class="f"><label>Penitenciar</label><select name="id_penitenciar" class="full-width">${opts(meta.penitenciars, d.ID_PENETENTIAR)}</select></div>
                </div>
                <div class="f"><label>Comentarii</label><textarea name="comments" rows="2" class="full-width">${d.COMMENTS || ''}</textarea></div>
            `;
        }
        if (key === 'consultare') {
            return `
                <div class="admin-grid-2">
                    <div class="f"><label>Data Consult</label><input type="text" name="adate" class="datepicker" value="${d.ADATE || today}" placeholder="DD.MM.YYYY"></div>
                    <div class="f"><label>Nume Doctor</label><input type="text" name="npp_doctor" value="${d.NPP_DOCTOR || ''}"></div>
                </div>
                <div class="f"><label>Institu»õie MedicalƒÉ</label><select name="id_hospital" class="full-width">${opts(meta.hospitals, d.ID_HOSPITAL)}</select></div>
                <div class="f"><label>Tip Investiga»õie</label><select name="id_investigatii" class="full-width">${opts(meta.investigations, d.ID_INVESTIGATII)}</select></div>
            `;
        }
        return '';
    }

    // --- GLOBAL OPERATIONS WRAPPER ---
    // Exposed to allow inline onclick handlers in generated HTML
    window.medOps = {
        currentKey: null,
        currentId: null,

        openAdd: (key) => {
            window.medOps.currentKey = key;
            window.medOps.currentId = null;
            const form = document.getElementById('medForm');
            form.innerHTML = getFormFields(key, {});
            document.getElementById('medTitle').textContent = `AdƒÉugare ${key.toUpperCase()}`;
            document.getElementById('medModal').classList.add('open');
        },

        openEdit: (key, data) => {
            window.medOps.currentKey = key;
            window.medOps.currentId = data.ID;
            const form = document.getElementById('medForm');
            form.innerHTML = getFormFields(key, data);
            document.getElementById('medTitle').textContent = `Editare ${key.toUpperCase()}`;
            document.getElementById('medModal').classList.add('open');
        },

        close: () => {
            document.getElementById('medModal').classList.remove('open');
        },

        submit: async () => {
            const key = window.medOps.currentKey;
            const id = window.medOps.currentId;
            const form = document.getElementById('medForm');
            const fd = new FormData(form);
            const payload = Object.fromEntries(fd);

            try {
                let url, method;
                if (id) {
                    url = `/detinut/medical/${key}/${id}`;
                    method = 'PUT';
                } else {
                    url = `/detinut/${currentIdnp}/medical/${key}`;
                    method = 'POST';
                }

                // Manually calling fetch to support PUT/POST correctly
                const headers = { "Content-Type": "application/json" };
                const userId = sessionStorage.getItem("prison.userId");
                if (userId) headers["X-User-Id"] = userId;

                const res = await fetch(`/api${url}`, {
                    method: method,
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if(!data.success) throw new Error(data.error);
                
                window.medOps.close();
                // Reload Module
                const content = document.getElementById('medContent');
                loadSubModule(key, content);

            } catch (e) {
                alert("Eroare: " + e.message);
            }
        },

        del: async (key, id) => {
            if(!confirm("Sigur »ôterge»õi √Ænregistrarea?")) return;
            try {
                await window.prisonApi.del(`/detinut/medical/${key}/${id}`);
                const content = document.getElementById('medContent');
                loadSubModule(key, content);
            } catch(e) { alert(e.message); }
        }
    };

    // --- MAIN RENDER ---
    window.DetinutTabs['medicina'] = {
        render: async (container, detinutId) => {
             // 1. Get IDNP from global context
             const idnp = window.currentDetinutData ? window.currentDetinutData.IDNP : null;
             if (!idnp) { container.innerHTML = '<div class="error-box">LipsƒÉ IDNP.</div>'; return; }
             currentIdnp = idnp;

             // 2. Fetch Meta & Permissions
             try {
                 const userId = sessionStorage.getItem("prison.userId");
                 await Promise.all([fetchMeta(), loadPermissions(userId)]);
             } catch(e) {
                 container.innerHTML = `<div class="error-box">${e.message}</div>`;
                 return;
             }

             // 3. Filter Allowed Sub-Tabs
             const allowedTabs = SUB_MODULES.filter(m => {
                 const right = getRight(m.moduleId);
                 // Allow if right is R or W
                 return right === 'R' || right === 'W';
             });

             // 4. Render Sidebar
             renderLayout(container, allowedTabs);
        }
    };
})();
</file>

<file path="src/modules/inmate/medical/router.js">
const express = require("express");
const db = require("../../../db");
const router = express.Router();

function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}
const safe = (val) => (val === undefined ? null : val);

// --- AUTH HELPER (Shared with other modules) ---
async function checkPermission(userId, moduleId, requiredRight = 'R') {
  if (!userId) return false;
  try {
    const sql = `SELECT DREPT FROM PRISON.SPR_ACCESS WHERE ID_USER = :u AND ID_MODUL = :m`;
    const res = await db.execute(sql, { u: userId, m: moduleId });
    const right = res.rows.length ? res.rows[0].DREPT : null;
    if (!right) return false;
    if (requiredRight === 'R') return (right === 'R' || right === 'W');
    if (requiredRight === 'W') return (right === 'W');
    return false;
  } catch (e) { return false; }
}

// --- METADATA ROUTES ---
router.get("/detinut/meta/medical", async (req, res) => {
  try {
    const [motives, diagnoz, results, penitenciars, hospitals, inv] = await Promise.all([
      db.execute("SELECT ID, NAME FROM PRISON.SPR_MOTIV_GREVA_FOAMEI ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_DIAGNOZ ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_RADIOGRAFIE_RESULTAT ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_PENITENCIAR ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_HOSPITALS ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_INVESTIGATII ORDER BY NAME")
    ]);
    res.json({
      success: true,
      motives: motives.rows,
      diagnoz: diagnoz.rows,
      results: results.rows,
      penitenciars: penitenciars.rows,
      hospitals: hospitals.rows,
      investigations: inv.rows
    });
  } catch(e) { 
    res.status(500).json({success:false, error: e.message}); 
  }
});

// --- GREVA FOAMEI (ID 7) ---
router.get("/detinut/:idnp/medical/greva", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 7, 'R')) return res.status(403).json({ success: false, error: "Acces interzis." });
    const canWrite = await checkPermission(uid, 7, 'W');
    const result = await db.execute(`SELECT G.ID, TO_CHAR(G.BDATE, 'DD.MM.YYYY') as BDATE, TO_CHAR(G.EDATE, 'DD.MM.YYYY') as EDATE, G.ID_MOTIV, S.NAME as MOTIV FROM PRISON.GREVA_FOAMEI G LEFT JOIN PRISON.SPR_MOTIV_GREVA_FOAMEI S ON S.ID = G.ID_MOTIV WHERE G.IDNP = :idnp ORDER BY G.BDATE DESC`, { idnp: req.params.idnp });
    res.json({ success: true, rows: result.rows, canWrite });
});
router.post("/detinut/:idnp/medical/greva", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 7, 'W')) return res.status(403).json({ success: false });
    const { bdate, edate, id_motiv } = req.body;
    try { await db.execute("INSERT INTO PRISON.GREVA_FOAMEI (ID, IDNP, BDATE, EDATE, ID_MOTIV) VALUES (PRISON.GREVA_FOAMEI_SEQ.NEXTVAL, :idnp, TO_DATE(:b,'DD.MM.YYYY'), TO_DATE(:e,'DD.MM.YYYY'), :m)", { idnp: req.params.idnp, b: safe(bdate), e: safe(edate), m: safe(id_motiv) }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});
router.put("/detinut/medical/greva/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 7, 'W')) return res.status(403).json({ success: false });
    const { bdate, edate, id_motiv } = req.body;
    try { await db.execute("UPDATE PRISON.GREVA_FOAMEI SET BDATE = TO_DATE(:b,'DD.MM.YYYY'), EDATE = TO_DATE(:e,'DD.MM.YYYY'), ID_MOTIV = :m WHERE ID = :id", { b: safe(bdate), e: safe(edate), m: safe(id_motiv), id: req.params.id }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});
router.delete("/detinut/medical/greva/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 7, 'W')) return res.status(403).json({ success: false });
    try { await db.execute("DELETE FROM PRISON.GREVA_FOAMEI WHERE ID = :id", { id: req.params.id }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});

// --- DIAGNOZA (ID 8) ---
router.get("/detinut/:idnp/medical/diagnoza", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 8, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 8, 'W');
    const result = await db.execute(`SELECT D.ID, TO_CHAR(D.ADATE, 'DD.MM.YYYY') as ADATE, D.NOTE, D.ID_DIAGNOZ, S.NAME as DIAGNOZ_NAME, S.ID as DIAGNOZ_COD FROM PRISON.DIAGNOZ D LEFT JOIN PRISON.SPR_DIAGNOZ S ON S.ID = D.ID_DIAGNOZ WHERE D.IDNP = :idnp ORDER BY D.ADATE DESC`, { idnp: req.params.idnp });
    res.json({ success: true, rows: result.rows, canWrite });
});
router.post("/detinut/:idnp/medical/diagnoza", async (req, res) => {
    if (!await checkPermission(getUid(req), 8, 'W')) return res.status(403).json({ success: false });
    const { adate, id_diagnoz, note } = req.body;
    try { await db.execute("INSERT INTO PRISON.DIAGNOZ (ID, IDNP, ADATE, ID_DIAGNOZ, NOTE) VALUES (PRISON.DIAGNOZ_SEQ.NEXTVAL, :idnp, TO_DATE(:d,'DD.MM.YYYY'), :diag, :note)", { idnp: req.params.idnp, d: safe(adate), diag: safe(id_diagnoz), note: safe(note) }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});
router.put("/detinut/medical/diagnoza/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 8, 'W')) return res.status(403).json({ success: false });
    const { adate, id_diagnoz, note } = req.body;
    try { await db.execute("UPDATE PRISON.DIAGNOZ SET ADATE=TO_DATE(:d,'DD.MM.YYYY'), ID_DIAGNOZ=:diag, NOTE=:note WHERE ID=:id", { d: safe(adate), diag: safe(id_diagnoz), note: safe(note), id: req.params.id }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});
router.delete("/detinut/medical/diagnoza/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 8, 'W')) return res.status(403).json({ success: false });
    try { await db.execute("DELETE FROM PRISON.DIAGNOZ WHERE ID=:id", { id: req.params.id }, { autoCommit: true }); res.json({ success: true }); } catch(e) { res.status(500).json({ success: false, error: e.message }); }
});

// --- RADIOGRAFIE (ID 10) ---
router.get("/detinut/:idnp/medical/radiografie", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 10, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 10, 'W');
    const result = await db.execute(`SELECT R.ID, TO_CHAR(R.ADATE, 'DD.MM.YYYY') as ADATE, R.COMMENTS, R.ID_PENETENTIAR, R.ID_RESULTAT, P.NAME as PENITENCIAR, RES.NAME as REZULTAT FROM PRISON.RADIOGRAFIE R LEFT JOIN PRISON.SPR_PENITENCIAR P ON P.ID = R.ID_PENETENTIAR LEFT JOIN PRISON.SPR_RADIOGRAFIE_RESULTAT RES ON RES.ID = R.ID_RESULTAT WHERE R.IDNP = :idnp ORDER BY R.ADATE DESC`, { idnp: req.params.idnp });
    res.json({ success: true, rows: result.rows, canWrite });
});
router.post("/detinut/:idnp/medical/radiografie", async (req, res) => {
    if (!await checkPermission(getUid(req), 10, 'W')) return res.status(403).json({ success: false });
    const { adate, id_resultat, id_penitenciar, comments } = req.body;
    try { await db.execute("INSERT INTO PRISON.RADIOGRAFIE (ID, IDNP, ADATE, ID_RESULTAT, ID_PENETENTIAR, COMMENTS) VALUES (PRISON.RADIOGRAFIE_SEQ.NEXTVAL, :idnp, TO_DATE(:d,'DD.MM.YYYY'), :res, :pen, :comm)", { idnp: req.params.idnp, d:safe(adate), res:safe(id_resultat), pen:safe(id_penitenciar), comm:safe(comments) }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.put("/detinut/medical/radiografie/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 10, 'W')) return res.status(403).json({ success: false });
    const { adate, id_resultat, id_penitenciar, comments } = req.body;
    try { await db.execute("UPDATE PRISON.RADIOGRAFIE SET ADATE=TO_DATE(:d,'DD.MM.YYYY'), ID_RESULTAT=:res, ID_PENETENTIAR=:pen, COMMENTS=:comm WHERE ID=:id", {d:safe(adate), res:safe(id_resultat), pen:safe(id_penitenciar), comm:safe(comments), id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.delete("/detinut/medical/radiografie/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 10, 'W')) return res.status(403).json({ success: false });
    try { await db.execute("DELETE FROM PRISON.RADIOGRAFIE WHERE ID=:id", { id:req.params.id }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// --- CONSULTARE (ID 11) ---
router.get("/detinut/:idnp/medical/consultare", async (req, res) => {
    const uid = getUid(req);
    if (!await checkPermission(uid, 11, 'R')) return res.status(403).json({ success: false });
    const canWrite = await checkPermission(uid, 11, 'W');
    const result = await db.execute(`SELECT C.ID, TO_CHAR(C.ADATE, 'DD.MM.YYYY') as ADATE, C.NPP_DOCTOR, C.ID_HOSPITAL, C.ID_INVESTIGATII, H.NAME as HOSPITAL, I.NAME as INVESTIGATIE FROM PRISON.CONSULTARE_MIN C LEFT JOIN PRISON.SPR_HOSPITALS H ON H.ID = C.ID_HOSPITAL LEFT JOIN PRISON.SPR_INVESTIGATII I ON I.ID = C.ID_INVESTIGATII WHERE C.IDNP = :idnp ORDER BY C.ADATE DESC`, { idnp: req.params.idnp });
    res.json({ success: true, rows: result.rows, canWrite });
});
router.post("/detinut/:idnp/medical/consultare", async (req, res) => {
    if (!await checkPermission(getUid(req), 11, 'W')) return res.status(403).json({ success: false });
    const { adate, npp_doctor, id_hospital, id_investigatii } = req.body;
    try { await db.execute("INSERT INTO PRISON.CONSULTARE_MIN (ID, IDNP, ADATE, NPP_DOCTOR, ID_HOSPITAL, ID_INVESTIGATII) VALUES (PRISON.CONSULTARE_MIN_SEQ.NEXTVAL, :idnp, TO_DATE(:d,'DD.MM.YYYY'), :doc, :hosp, :inv)", { idnp:req.params.idnp, d:safe(adate), doc:safe(npp_doctor), hosp:safe(id_hospital), inv:safe(id_investigatii) }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.put("/detinut/medical/consultare/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 11, 'W')) return res.status(403).json({ success: false });
    const { adate, npp_doctor, id_hospital, id_investigatii } = req.body;
    try { await db.execute("UPDATE PRISON.CONSULTARE_MIN SET ADATE=TO_DATE(:d,'DD.MM.YYYY'), NPP_DOCTOR=:doc, ID_HOSPITAL=:hosp, ID_INVESTIGATII=:inv WHERE ID=:id", {d:safe(adate), doc:safe(npp_doctor), hosp:safe(id_hospital), inv:safe(id_investigatii), id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.delete("/detinut/medical/consultare/:id", async (req, res) => {
    if (!await checkPermission(getUid(req), 11, 'W')) return res.status(403).json({ success: false });
    try { await db.execute("DELETE FROM PRISON.CONSULTARE_MIN WHERE ID=:id", { id:req.params.id }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

module.exports = router;
</file>

<file path="src/modules/inmate/profile/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    let meta = null;
    let _detId = null;
    let _idnp = null;

    // --- UTILS ---
    async function fetchMeta() {
        if(meta) return;
        try {
            const res = await window.prisonApi.get('/detinut/meta/general');
            if(res.success) meta = res;
        } catch(e) { console.error("Failed to load meta", e); }
    }

    function safeVal(v) { return v || '‚Äî'; }

    // --- HTML GENERATORS ---
    function renderViewField(label, value) {
        return `<div class="detail-row"><span class="detail-label">${label}</span><span class="detail-value" style="font-weight:600; color:#334155;">${safeVal(value)}</span></div>`;
    }

    function renderEditField(label, name, value, type='text', options=[]) {
        if(type === 'select') {
            const opts = options.map(o => `<option value="${o.ID}" ${String(o.ID) === String(value) ? 'selected' : ''}>${o.NAME}</option>`).join('');
            return `<div class="f"><label>${label}</label><select name="${name}" class="full-width"><option value="">- Select -</option>${opts}</select></div>`;
        }
        return `<div class="f"><label>${label}</label><input type="${type}" name="${name}" value="${value||''}" class="full-width" autocomplete="off"></div>`;
    }

    // --- MODAL INJECTOR ---
    function injectModals() {
        if(document.getElementById('photoModal')) return;

        const html = `
        <div class="modal-overlay" id="photoModal"><div class="modal-card">
            <div class="modal-header"><h3>Gestionare Foto</h3><button class="btn-close" onclick="closeModal('photoModal')">√ó</button></div>
            <div class="modal-body">
                <div class="f mb-2"><label>Tip Fotografie</label><select id="photoType" class="full-width"><option value="1">1. Frontal</option><option value="2">2. Lateral</option><option value="3">3. Semne Particulare</option><option value="4">4. Tatuaje</option></select></div>
                <div class="upload-area" id="dropArea"><div class="upload-icon">‚òÅÔ∏è</div><div class="upload-text">Trage imagine aici sau click</div><input type="file" id="photoInput" accept="image/*" hidden><div class="upload-preview" id="photoPreview"></div></div>
            </div>
            <div class="modal-footer"><button class="btn-ghost" onclick="closeModal('photoModal')">AnuleazƒÉ</button><button class="btn-primary" id="btnSavePhoto" disabled>√éncarcƒÉ</button></div>
        </div></div>

        <div class="modal-overlay" id="actModal"><div class="modal-card">
            <div class="modal-header"><h3>AdaugƒÉ Act Identitate</h3><button class="btn-close" onclick="closeModal('actModal')">√ó</button></div>
            <div class="modal-body"><form id="formAct" class="admin-form">
                <div class="f"><label>Tip Document</label><select name="id_tip" id="actTip" class="full-width"></select></div>
                <div class="f"><label>NumƒÉr Document</label><input type="text" name="nr_doc" class="full-width"></div>
                <div class="f"><label>Eliberat de</label><input type="text" name="issued_by" class="full-width"></div>
                <div class="admin-grid-2">
                    <div class="f"><label>Data EliberƒÉrii</label><input type="text" name="date_issue" class="datepicker" placeholder="DD.MM.YYYY"></div>
                    <div class="f"><label>Valabil P√¢nƒÉ</label><input type="text" name="date_exp" class="datepicker" placeholder="DD.MM.YYYY"></div>
                </div>
            </form></div>
            <div class="modal-footer"><button class="btn-ghost" onclick="closeModal('actModal')">AnuleazƒÉ</button><button class="btn-primary" onclick="submitAct()">SalveazƒÉ</button></div>
        </div></div>

        <div class="modal-overlay" id="jobModal"><div class="modal-card">
            <div class="modal-header"><h3>AdaugƒÉ Loc de MuncƒÉ</h3><button class="btn-close" onclick="closeModal('jobModal')">√ó</button></div>
            <div class="modal-body"><form id="formJob" class="admin-form">
                <div class="f"><label>Locul de MuncƒÉ (Institu»õia)</label><input type="text" name="place" class="full-width"></div>
                <div class="f"><label>Profesia / Func»õia</label><select name="id_prof" id="jobProf" class="full-width"></select></div>
                <div class="f"><label>Data AngajƒÉrii</label><input type="text" name="date_start" class="datepicker" placeholder="DD.MM.YYYY"></div>
            </form></div>
            <div class="modal-footer"><button class="btn-ghost" onclick="closeModal('jobModal')">AnuleazƒÉ</button><button class="btn-primary" onclick="submitJob()">SalveazƒÉ</button></div>
        </div></div>

        <div class="modal-overlay" id="citModal"><div class="modal-card" style="max-width:400px;">
            <div class="modal-header"><h3>AdaugƒÉ CetƒÉ»õenie</h3><button class="btn-close" onclick="closeModal('citModal')">√ó</button></div>
            <div class="modal-body"><form id="formCit" class="admin-form">
                <div class="f"><label>»öara</label><select name="id_sitizen" id="citList" class="full-width"></select></div>
                <div class="f"><label>Data Dob√¢ndirii (Op»õional)</label><input type="text" name="bdate" class="datepicker" placeholder="DD.MM.YYYY"></div>
            </form></div>
            <div class="modal-footer"><button class="btn-ghost" onclick="closeModal('citModal')">AnuleazƒÉ</button><button class="btn-primary" onclick="submitCit()">AdaugƒÉ</button></div>
        </div></div>

        <div class="modal-overlay" id="addrModal"><div class="modal-card">
            <div class="modal-header"><h3>AdaugƒÉ Domiciliu</h3><button class="btn-close" onclick="closeModal('addrModal')">√ó</button></div>
            <div class="modal-body"><form id="formAddr" class="admin-form">
                <div class="f">
                    <label>Localitate</label>
                    <select name="locality_id" id="addrLoc" class="full-width search-select"></select>
                </div>
                <div class="f"><label>Adresa ExactƒÉ (Strada, Nr)</label><input type="text" name="address" class="full-width"></div>
                <div class="f"><label>Data √énregistrƒÉrii</label><input type="text" name="start_date" class="datepicker" placeholder="DD.MM.YYYY" value="${new Date().toLocaleDateString('ro-RO')}"></div>
            </form></div>
            <div class="modal-footer"><button class="btn-ghost" onclick="closeModal('addrModal')">AnuleazƒÉ</button><button class="btn-primary" onclick="submitAddr()">SalveazƒÉ</button></div>
        </div></div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // --- MAIN RENDER ---
    window.DetinutTabs['generale'] = {
        render: async (container, detinutId) => {
            _detId = detinutId;
            injectModals();
            
            try {
                await fetchMeta();
                const res = await window.prisonApi.get(`/detinut/${detinutId}/general_full`);
                if(!res.success) throw new Error(res.error);

                const { detinut, canEdit, images, citizenships, acts, employment, address } = res;
                _idnp = detinut.IDNP;

                // --- Setup Toggle Function for Edit Mode ---
                window.toggleEditMode = () => {
                     const view = document.getElementById('viewMode');
                     const edit = document.getElementById('editForm');
                     const btn = document.getElementById('portal-edit-btn');
                     
                     if(!view || !edit) return;

                     const isEditing = edit.classList.contains('hidden');
                     
                     if (isEditing) {
                        view.classList.add('hidden');
                        edit.classList.remove('hidden');
                        if(btn) {
                            btn.innerHTML = '‚ùå AnuleazƒÉ';
                            btn.classList.add('active');
                        }
                     } else {
                        view.classList.remove('hidden');
                        edit.classList.add('hidden');
                        if(btn) {
                            btn.innerHTML = '‚úèÔ∏è EditeazƒÉ Date';
                            btn.classList.remove('active');
                        }
                     }
                };

                // --- INJECT EDIT BUTTON INTO HEADER ---
                const actionContainer = document.getElementById('headerActions');
                if(actionContainer) actionContainer.innerHTML = '';
                
                if(canEdit && actionContainer) {
                    const editBtn = document.createElement('button');
                    editBtn.id = 'portal-edit-btn';
                    editBtn.className = 'btn-compact-edit';
                    editBtn.innerHTML = '‚úèÔ∏è EditeazƒÉ Date';
                    editBtn.onclick = window.toggleEditMode;
                    actionContainer.appendChild(editBtn);
                }

                // UI
                container.innerHTML = `
                <div class="profile-page-wrapper">
                    <div id="viewMode">
                        <div class="gen-grid-3">
                            <div class="admin-panel">
                                <div class="profile-section-title">üë§ Identitate</div>
                                <div class="detail-stack">
                                    ${renderViewField('Nume', detinut.SURNAME)}
                                    ${renderViewField('Prenume', detinut.NAME)}
                                    ${renderViewField('Patronimic', detinut.SEC_NAME)}
                                    ${renderViewField('IDNP', detinut.IDNP)}
                                    ${renderViewField('Data Na»ôterii', detinut.BIRDTH_STR)}
                                    ${renderViewField('Sex', detinut.SEX)}
                                </div>
                            </div>
                            <div class="admin-panel">
                                <div class="profile-section-title">‚öñÔ∏è Statut & Social</div>
                                <div class="detail-stack">
                                    ${renderViewField('Statut Juridic', detinut.STATUT_NAME)}
                                    ${renderViewField('Stare CivilƒÉ', detinut.MARITAL_NAME)}
                                    ${renderViewField('Religie', detinut.RELIGION_NAME)}
                                    ${renderViewField('Studii', detinut.EDU_NAME)}
                                    ${renderViewField('Na»õionalitate', detinut.NATIONALITY_NAME)}
                                </div>
                            </div>
                            <div class="admin-panel">
                                <div class="profile-section-title">üåç Origine & Domiciliu</div>
                                <div class="mb-2">
                                    <div class="flex-between">
                                        <span class="detail-label block">CetƒÉ»õenie</span>
                                        ${canEdit ? `<button class="btn-tiny" onclick="openCitModal()">+ AdaugƒÉ</button>` : ''}
                                    </div>
                                    <div class="badges mt-1">
                                        ${citizenships.map(c => `<span class="badge badge-read">${c.NAME} ${canEdit?`<b class="del-x" onclick="delCit(${c.ID})">√ó</b>`:''}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="flex-between">
                                        <span class="detail-label">Domiciliu</span>
                                        ${canEdit ? `<button class="btn-tiny" onclick="openAddrModal()">+ AdaugƒÉ</button>` : ''}
                                    </div>
                                    <ul class="addr-list mt-1">
                                       ${address.map(a => `<li><b>${a.START_DATE_STR}</b>: ${a.CITY}, ${a.ADDRESS} ${canEdit?`<span class="del-x" onclick="delAddr(${a.ID})">√ó</span>`:''}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="gen-grid-3 mt-4" style="grid-template-columns: 1fr 1fr;">
                            <div class="admin-panel">
                                <div class="flex-between mb-2">
                                    <div class="profile-section-title m-0 border-0">ü™™ Acte de Identitate</div>
                                    ${canEdit ? `<button class="btn-tiny" onclick="openActModal()">+ AdaugƒÉ</button>` : ''}
                                </div>
                                <table class="compact-table">
                                    <thead><tr><th>Tip</th><th>NumƒÉr</th><th>Eliberat</th><th>ExpirƒÉ</th><th></th></tr></thead>
                                    <tbody>
                                        ${acts.map(a => `<tr><td>${a.TIP_DOC}</td><td><b>${a.NRDOCUMENT}</b></td><td>${a.ELIBERAT_DE||'-'}</td><td>${a.EXP_STR}</td><td class="text-right">${canEdit?`<button class="btn-danger btn-small" onclick="delAct(${a.ID})">√ó</button>`:''}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="admin-panel">
                                <div class="flex-between mb-2">
                                    <div class="profile-section-title m-0 border-0">üíº Loc de MuncƒÉ</div>
                                    ${canEdit ? `<button class="btn-tiny" onclick="openJobModal()">+ AdaugƒÉ</button>` : ''}
                                </div>
                                <table class="compact-table">
                                    <thead><tr><th>Loc MuncƒÉ</th><th>Profesie</th><th>Data</th><th></th></tr></thead>
                                    <tbody>
                                        ${employment.map(e => `<tr><td>${e.PLACE}</td><td>${e.PROFESSION || '-'}</td><td>${e.START_DATE}</td><td class="text-right">${canEdit?`<button class="btn-danger btn-small" onclick="delJob(${e.ID})">√ó</button>`:''}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="admin-panel mt-4">
                            <div class="flex-between">
                                <div class="profile-section-title">Galerie Foto</div>
                                ${canEdit ? `<button class="btn-tiny" onclick="openPhotoModal()">Gestionare Foto</button>`:''}
                            </div>
                            <div class="gallery-row">
                                ${images.map(img => `<div class="gallery-item"><a href="${img.url}" target="_blank"><img src="${img.url}"></a></div>`).join('')}
                                ${images.length === 0 ? '<span class="text-muted p-2">FƒÉrƒÉ fotografii.</span>' : ''}
                            </div>
                        </div>
                    </div>

                    <form id="editForm" class="admin-panel hidden">
                        <div class="profile-section-title mb-4">Editare Date Principale</div>
                        <div class="gen-grid-3">
                            ${renderEditField('Nume', 'surname', detinut.SURNAME)}
                            ${renderEditField('Prenume', 'name', detinut.NAME)}
                            ${renderEditField('Patronimic', 'sec_name', detinut.SEC_NAME)}
                            ${renderEditField('Data Na»ôterii', 'birth', detinut.BIRDTH_STR)}
                            ${renderEditField('Sex', 'sex', detinut.SEX, 'select', [{ID:'M',NAME:'M'},{ID:'F',NAME:'F'}])}
                            ${renderEditField('Colaborator?', 'wpolice', detinut.WPOLICE, 'select', [{ID:'N',NAME:'NU'},{ID:'Y',NAME:'DA'}])}
                            ${renderEditField('Na»õionalitate', 'id_nat', detinut.ID_SPR_NATIONALITY, 'select', meta.nationality)}
                            ${renderEditField('Religie', 'id_rel', detinut.ID_SPR_RELIGION, 'select', meta.religion)}
                            ${renderEditField('Stare CivilƒÉ', 'id_mar', detinut.ID_MAR_STATUS, 'select', meta.marital)}
                            ${renderEditField('Studii', 'id_edu', detinut.ID_SPR_EDU_LEVEL, 'select', meta.edu)}
                            ${renderEditField('Categ. SocialƒÉ', 'id_categ', detinut.ID_SPR_CATEG_SOCIAL, 'select', meta.social)}
                            ${renderEditField('SƒÉnƒÉtate', 'id_health', detinut.ID_HEALTH_STAT, 'select', meta.health)}
                        </div>
                        <div class="form-buttons right mt-4">
                            <button type="button" class="btn-ghost" onclick="toggleEditMode()">AnuleazƒÉ</button>
                            <button type="submit" class="btn-primary">SalveazƒÉ</button>
                        </div>
                    </form>
                </div>`;

                if(canEdit) {
                    document.getElementById('editForm').onsubmit = async (e) => {
                        e.preventDefault();
                        try { await window.prisonApi.post(`/detinut/${detinutId}/update_main`, Object.fromEntries(new FormData(e.target))); reload(); } catch(err) { alert(err.message); }
                    };
                    
                    window.openActModal = () => { fillSelect('actTip', meta.docTypes); openM('actModal'); };
                    window.openJobModal = () => { fillSelect('jobProf', meta.professions); openM('jobModal'); };
                    window.openCitModal = () => { fillSelect('citList', meta.citizen); openM('citModal'); };
                    window.openAddrModal = () => { fillSelect('addrLoc', meta.locality); openM('addrModal'); };
                    window.openPhotoModal = () => { setupDragDrop(); openM('photoModal'); };
                }

            } catch(e) {
                container.innerHTML = `<div class="error-box">Eroare √ÆncƒÉrcare profil: ${e.message}</div>`;
            }
        }
    };

    // --- LOGIC ---
    function reload() { window.DetinutTabs['generale'].render(document.getElementById('profileContent'), _detId); }
    function openM(id) { document.getElementById(id).classList.add('open'); }
    window.closeModal = (id) => document.getElementById(id).classList.remove('open');
    function fillSelect(id, items) { 
        const el = document.getElementById(id); 
        el.innerHTML = '<option value="">- SelecteazƒÉ -</option>' + items.map(i => `<option value="${i.ID}">${i.NAME}</option>`).join(''); 
    }

    // Submit Handlers
    window.submitAct = async () => { await postForm('formAct', `/detinut/${_idnp}/acte`, 'actModal'); };
    window.submitJob = async () => { await postForm('formJob', `/detinut/${_idnp}/employment`, 'jobModal'); };
    window.submitCit = async () => { await postForm('formCit', `/detinut/${_idnp}/citizenship`, 'citModal'); };
    window.submitAddr = async () => { await postForm('formAddr', `/detinut/${_idnp}/address`, 'addrModal'); };

    async function postForm(formId, url, modalId) {
        const form = document.getElementById(formId);
        try { await window.prisonApi.post(url, Object.fromEntries(new FormData(form))); window.closeModal(modalId); reload(); } 
        catch(e){alert(e.message);}
    }

    // Deletes
    window.delCit = (id) => delC(`/detinut/citizenship/${id}`);
    window.delAct = (id) => delC(`/detinut/acte/${id}`);
    window.delJob = (id) => delC(`/detinut/employment/${id}`);
    window.delAddr = (id) => delC(`/detinut/address/${id}`);
    
    async function delC(url) { 
        if(confirm('Sigur »ôterge»õi?')) { 
            try { await window.prisonApi.del(url); reload(); }
            catch(e) { alert(e.message); }
        } 
    }

    // Drag Drop
    function setupDragDrop() {
        const da = document.getElementById('dropArea'), inp = document.getElementById('photoInput'), pre = document.getElementById('photoPreview'), btn = document.getElementById('btnSavePhoto');
        let file;
        da.onclick = () => inp.click();
        inp.onchange = () => { file=inp.files[0]; showP(file); };
        da.ondragover = (e) => { e.preventDefault(); da.classList.add('dragover'); };
        da.ondragleave = () => da.classList.remove('dragover');
        da.ondrop = (e) => { e.preventDefault(); da.classList.remove('dragover'); file=e.dataTransfer.files[0]; showP(file); };
        function showP(f) { if(f && f.type.startsWith('image/')) { const r = new FileReader(); r.onload=e=>{ pre.innerHTML=`<img src="${e.target.result}" class="preview-img">`; btn.disabled=false; }; r.readAsDataURL(f); } }
        btn.onclick = async () => {
            if(!file) return;
            const fd = new FormData(); fd.append('image', file); fd.append('type', document.getElementById('photoType').value);
            btn.innerText = 'Se √ÆncarcƒÉ...';
            btn.disabled = true;
            
            // Raw fetch because api wrapper usually handles JSON, and this is Multipart
            try {
                const res = await fetch(`/api/detinut/${_detId}/photos`, { 
                    method:'POST', 
                    headers:{"x-user-id":sessionStorage.getItem("prison.userId")}, 
                    body:fd 
                });
                const d = await res.json();
                if(!d.success) throw new Error(d.error);
                window.closeModal('photoModal'); 
                reload();
            } catch(e) {
                alert("Eroare upload: " + e.message);
                btn.innerText = '√éncarcƒÉ';
                btn.disabled = false;
            }
        };
    }
})();
</file>

<file path="src/modules/inmate/profile/router.js">
const express = require("express");
const db = require("../../../db"); 
const router = express.Router();
const multer = require("multer");
const sharp = require("sharp");
const fs = require("fs");
const path = require("path");

// FIX: Use process.cwd() to target project root correctly
const PHOTOS_BASE_DIR = path.join(process.cwd(), "public/resources/photos");
const TEMP_DIR = path.join(process.cwd(), "public/resources/temp_uploads");

// Ensure temp dir exists
if (!fs.existsSync(TEMP_DIR)) {
  try { fs.mkdirSync(TEMP_DIR, { recursive: true }); } catch (e) {}
}

const upload = multer({ dest: TEMP_DIR });

function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}
const safe = (val) => (val === undefined ? null : val);

// --- AUTH HELPER ---
async function canEditGeneral(userId) {
  if (!userId) return false;
  try {
    const res = await db.execute("SELECT ID_ROLE FROM USERS WHERE ID = :u", { u: userId });
    if (!res.rows.length) return false;
    const role = Number(res.rows[0].ID_ROLE);
    // Roles allowed to edit: 1, 7, 99
    return [1, 7, 99].includes(role); 
  } catch (e) { return false; }
}

// --- METADATA ROUTES ---
router.get("/detinut/meta/general", async (req, res) => {
  try {
    const [statut, categ, edu, mar, nat, rel, loc, cit, docTypes, profs, health] = await Promise.all([
      db.execute("SELECT ID, NAME FROM PRISON.SPR_STATUT ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_CATEG_SOCIAL ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_EDU_LEVEL ORDER BY ID"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_MAR_STATUS ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_NATIONALITY ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_RELIGION ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_LOCALITY ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_SITIZEN ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_TIP_DOCUMENT ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_PROFESSION ORDER BY NAME"),
      db.execute("SELECT ID, NAME FROM PRISON.SPR_HEALTH_STAT ORDER BY NAME")
    ]);
    res.json({
      success: true,
      statut: statut.rows, social: categ.rows, edu: edu.rows, marital: mar.rows,
      nationality: nat.rows, religion: rel.rows, locality: loc.rows, citizen: cit.rows,
      docTypes: docTypes.rows, professions: profs.rows, health: health.rows
    });
  } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// --- GENERAL PROFILE READ ---
router.get("/detinut/:id/general", async (req, res) => {
  try {
    const sql = `
      SELECT D.ID, D.IDNP, D.SURNAME, D.NAME, D.SEC_NAME, 
             TO_CHAR(D.BIRDTH, 'DD.MM.YYYY') as BIRDTH, 
             P.NAME as PENITENCIAR_NAME,
             D.FOLDERPENDING  -- <--- ADDED COLUMN
      FROM PRISON.DETINUTI D
      LEFT JOIN PRISON.MISCARI M ON M.IDNP = D.IDNP
      LEFT JOIN PRISON.SPR_PENITENCIAR P ON P.ID = M.ID_PENETENCIAR
      WHERE D.ID = :p_det_id ORDER BY M.ADATE DESC FETCH FIRST 1 ROWS ONLY
    `;
    const result = await db.execute(sql, { p_det_id: req.params.id });
    if (!result.rows.length) return res.json({ success: false, error: "De»õinut nu a fost gƒÉsit." });
    res.json({ success: true, data: result.rows[0] });
  } catch (e) { res.status(500).json({ success: false, error: e.message }); }
});

router.get("/detinut/:id/general_full", async (req, res) => {
  try {
    const uid = getUid(req);
    const canEdit = await canEditGeneral(uid);
    const id = req.params.id;

    const dRes = await db.execute(`SELECT D.ID, D.IDNP, D.NAME, D.SURNAME, D.SEC_NAME, D.SEX, D.WPOLICE, TO_CHAR(D.BIRDTH, 'DD.MM.YYYY') as BIRDTH_STR, D.ID_SPR_CATEG_SOCIAL, D.ID_SPR_EDU_LEVEL, D.ID_MAR_STATUS, D.ID_SPR_NATIONALITY, D.ID_SPR_RELIGION, D.ID_HEALTH_STAT, S.NAME as STATUT_NAME, REL.NAME as RELIGION_NAME, NAT.NAME as NATIONALITY_NAME, EDU.NAME as EDU_NAME, MAR.NAME as MARITAL_NAME FROM PRISON.DETINUTI D LEFT JOIN PRISON.STATUT_HISTORY SH ON (SH.IDNP = D.IDNP AND SH.B_DATE = (SELECT MAX(B_DATE) FROM PRISON.STATUT_HISTORY WHERE IDNP = D.IDNP)) LEFT JOIN PRISON.SPR_STATUT S ON S.ID = SH.ID_STATUT LEFT JOIN PRISON.SPR_RELIGION REL ON REL.ID = D.ID_SPR_RELIGION LEFT JOIN PRISON.SPR_NATIONALITY NAT ON NAT.ID = D.ID_SPR_NATIONALITY LEFT JOIN PRISON.SPR_EDU_LEVEL EDU ON EDU.ID = D.ID_SPR_EDU_LEVEL LEFT JOIN PRISON.SPR_MAR_STATUS MAR ON MAR.ID = D.ID_MAR_STATUS WHERE D.ID = :id`, { id });

    if (!dRes.rows.length) return res.status(404).json({success:false, error:"Not found"});
    const detinut = dRes.rows[0];
    const idnp = detinut.IDNP;

    const imgRes = await db.execute("SELECT IMAGE_TYPE FROM PRISON.IMAGES WHERE DETINUT_ID = :id ORDER BY IMAGE_TYPE ASC", { id });
    const images = (imgRes.rows || []).map(i => ({ id: i.IMAGE_TYPE, type: i.IMAGE_TYPE, url: `/resources/photos/${idnp.charAt(0)}/${idnp}/${i.IMAGE_TYPE}.webp?v=${Date.now()}` }));

    const citRes = await db.execute(`SELECT C.ID, S.NAME, TO_CHAR(C.BDATE, 'DD.MM.YYYY') as BDATE FROM PRISON.SITIZEN C JOIN PRISON.SPR_SITIZEN S ON S.ID = C.ID_SITIZEN WHERE C.IDNP = :idnp`, { idnp });
    const actRes = await db.execute(`SELECT A.ID, A.NRDOCUMENT, TO_CHAR(A.ELIBERAT_DATA, 'DD.MM.YYYY') as ELIB_STR, TO_CHAR(A.VALABIL_PINA, 'DD.MM.YYYY') as EXP_STR, T.NAME as TIP_DOC FROM PRISON.ACTE A JOIN PRISON.SPR_TIP_DOCUMENT T ON T.ID = A.ID_TIP_DOCUMENT WHERE A.IDNP = :idnp`, { idnp });
    const empRes = await db.execute(`SELECT E.ID, E.PLACE, P.NAME as PROFESSION, TO_CHAR(E.EDATE, 'DD.MM.YYYY') as START_DATE FROM PRISON.EMPLOYEMENT E LEFT JOIN PRISON.SPR_PROFESSION P ON P.ID = E.ID_PROFESSION WHERE E.IDNP = :idnp`, { idnp });
    const locRes = await db.execute(`SELECT L.ID, L.ADDRESS, TO_CHAR(L.START_DATE, 'DD.MM.YYYY') as START_DATE_STR, LOC.NAME as CITY FROM PRISON.L_LOCATION L LEFT JOIN PRISON.SPR_LOCALITY LOC ON LOC.ID = L.LOCALITY_ID WHERE L.IDNP = :idnp`, { idnp });

    res.json({ success: true, canEdit, detinut, images, citizenships: citRes.rows, acts: actRes.rows, employment: empRes.rows, address: locRes.rows });
  } catch(e) { res.status(500).json({success:false, error: e.message}); }
});

// --- UPDATE MAIN ---
router.post("/detinut/:id/update_main", async (req, res) => {
  const uid = getUid(req);
  if (!(await canEditGeneral(uid))) return res.status(403).json({success:false, error: "Acces interzis la editare."});
  
  const { name, surname, sec_name, birth, sex, wpolice, id_categ, id_edu, id_mar, id_nat, id_rel, id_health } = req.body;
  try {
    // FIX: Renamed :in to :nat and :s to :snm to avoid reserved keyword conflicts
    const sql = `
        UPDATE PRISON.DETINUTI 
        SET NAME=:n, 
            SURNAME=:snm, 
            SEC_NAME=:sec, 
            SEX=:sex, 
            BIRDTH=TO_DATE(:b, 'DD.MM.YYYY'), 
            WPOLICE=:w, 
            ID_SPR_CATEG_SOCIAL=:ic, 
            ID_SPR_EDU_LEVEL=:ie, 
            ID_MAR_STATUS=:im, 
            ID_SPR_NATIONALITY=:nat, 
            ID_SPR_RELIGION=:ir, 
            ID_HEALTH_STAT=:ih 
        WHERE ID = :id`;
    
    await db.execute(sql, { 
        n: safe(name), 
        snm: safe(surname), 
        sec: safe(sec_name), 
        sex: safe(sex), 
        b: safe(birth), 
        w: wpolice||'N', 
        ic: safe(id_categ), 
        ie: safe(id_edu), 
        im: safe(id_mar), 
        nat: safe(id_nat), // Renamed from :in
        ir: safe(id_rel), 
        ih: safe(id_health), 
        id: req.params.id 
    }, { autoCommit: true });
    
    res.json({success:true});
  } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// --- SUB-ENTITIES CRUD ---

// Acte
router.post("/detinut/:idnp/acte", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    
    // FIX: Removed 'ID' (trigger handles it) and renamed 'ELIBERAT_DE' -> 'ELIBERAT_CATRE'
    const { id_tip, nr_doc, issued_by, date_issue, date_exp } = req.body;
    try { 
        await db.execute(
            `INSERT INTO PRISON.ACTE (
                IDNP, 
                ID_TIP_DOCUMENT, 
                NRDOCUMENT, 
                ELIBERAT_CATRE, 
                ELIBERAT_DATA, 
                VALABIL_PINA
             ) VALUES (
                :idnp, 
                :tip, 
                :nr, 
                :iby, 
                TO_DATE(:di,'DD.MM.YYYY'), 
                TO_DATE(:de,'DD.MM.YYYY')
             )`, 
            { 
                idnp: req.params.idnp, 
                tip: safe(id_tip), 
                nr: safe(nr_doc), 
                iby: safe(issued_by), // Maps to ELIBERAT_CATRE
                di: safe(date_issue), 
                de: safe(date_exp) 
            }, 
            { autoCommit: true }
        ); 
        res.json({success:true}); 
    } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

router.delete("/detinut/acte/:id", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    try { await db.execute("DELETE FROM PRISON.ACTE WHERE ID=:id", {id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// Employment
router.post("/detinut/:idnp/employment", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    const { place, id_prof, date_start } = req.body;
    try { await db.execute("INSERT INTO PRISON.EMPLOYEMENT (ID, IDNP, PLACE, ID_PROFESSION, EDATE) VALUES (PRISON.EMPLOYEMENT_SEQ.NEXTVAL, :idnp, :pl, :prof, TO_DATE(:d,'DD.MM.YYYY'))", { idnp:req.params.idnp, pl:safe(place), prof:safe(id_prof), d:safe(date_start) }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.delete("/detinut/employment/:id", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    try { await db.execute("DELETE FROM PRISON.EMPLOYEMENT WHERE ID=:id", {id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// Citizenship
router.post("/detinut/:idnp/citizenship", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    const { id_sitizen, bdate } = req.body;
    try { await db.execute("INSERT INTO PRISON.SITIZEN (ID, IDNP, ID_SITIZEN, BDATE) VALUES (PRISON.SITIZEN_SEQ.NEXTVAL, :idnp, :s, TO_DATE(:d,'DD.MM.YYYY'))", { idnp:req.params.idnp, s:safe(id_sitizen), d:safe(bdate) }, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});
router.delete("/detinut/citizenship/:id", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    try { await db.execute("DELETE FROM PRISON.SITIZEN WHERE ID=:id", {id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// Address
router.post("/detinut/:idnp/address", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    
    // FIX: Removed 'ID' column and sequence. 
    // The DB trigger 'L_LOCATION_TRG' will handle ID generation using 'L_LOCATION2_SEQ'.
    const { locality_id, address, start_date } = req.body;
    try { 
        await db.execute(
            `INSERT INTO PRISON.L_LOCATION (
                IDNP, 
                LOCALITY_ID, 
                ADDRESS, 
                START_DATE
             ) VALUES (
                :idnp, 
                :lid, 
                :addr, 
                TO_DATE(:d,'DD.MM.YYYY')
             )`, 
            { 
                idnp: req.params.idnp, 
                lid: safe(locality_id), 
                addr: safe(address), 
                d: safe(start_date) 
            }, 
            { autoCommit: true }
        ); 
        res.json({success:true}); 
    } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

router.delete("/detinut/address/:id", async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    try { await db.execute("DELETE FROM PRISON.L_LOCATION WHERE ID=:id", {id:req.params.id}, {autoCommit:true}); res.json({success:true}); } catch(e) { res.status(500).json({success:false, error:e.message}); }
});

// --- PHOTOS ---
router.post("/detinut/:id/photos", upload.single('image'), async (req, res) => {
    if (!await canEditGeneral(getUid(req))) return res.status(403).json({success:false});
    
    if (!req.file) return res.status(400).json({success:false, error:"LipsƒÉ fi»ôier"});
    const type = req.body.type || "1";
    
    try {
        const dRes = await db.execute("SELECT IDNP FROM PRISON.DETINUTI WHERE ID=:id", {id:req.params.id});
        if(!dRes.rows.length) throw new Error("De»õinut invalid");
        const idnp = dRes.rows[0].IDNP;
        const dir1 = idnp.charAt(0);
        
        const targetDir = path.join(PHOTOS_BASE_DIR, dir1, idnp);
        if(!fs.existsSync(targetDir)) fs.mkdirSync(targetDir, {recursive:true});
        
        const targetPath = path.join(targetDir, `${type}.webp`);
        
        await sharp(req.file.path)
           .resize(600)
           .webp({ quality: 80 })
           .toFile(targetPath);
           
        fs.unlink(req.file.path, ()=>{});
        
        const check = await db.execute("SELECT 1 FROM PRISON.IMAGES WHERE DETINUT_ID=:id AND IMAGE_TYPE=:t", {id:req.params.id, t:type});
        if(check.rows.length === 0) {
             await db.execute("INSERT INTO PRISON.IMAGES (DETINUT_ID, IMAGE_TYPE) VALUES (:id, :t)", {id:req.params.id, t:type}, {autoCommit:true});
        }
        
        res.json({success:true});
    } catch(e) {
        if(req.file) fs.unlink(req.file.path, ()=>{});
        res.status(500).json({success:false, error:e.message});
    }
});

module.exports = router;
</file>

<file path="src/modules/inmate/profile/shell.js">
(function () {
  // 1. Global Registry & Config
  window.DetinutTabs = window.DetinutTabs || {};
  
  const loadedScripts = {};
  let currentUserRole = null;

  // Configuration for tabs including permission rules
  // role: required role ID to see the tab (optional)
  const TABS_CONFIG = [
    { key: 'generale', label: 'Date Generale' },
    { key: 'garantii', label: 'Garan»õii' },
    { key: 'hotariri', label: 'HotƒÉr√Æri' },
    { key: 'miscari', label: 'Mi»ôcƒÉri' },
    { key: 'incidente', label: 'Incidente' },
    { key: 'citatii', label: 'Cita»õii' },
    { key: 'rude', label: 'Rude' },
    { key: 'complici', label: 'Complici' },
    { key: 'medicina', label: 'MedicinƒÉ'},
    { key: 'educatie', label: 'Educa»õie'}, 
    { key: 'psihologie', label: 'Psihologie' },
    { key: 'social', label: 'Social' },
    { key: 'securitate', label: 'Securitate' },
    { key: 'regim', label: 'Regim' },
  ];

  // NEW: Map tab keys to their new modular paths
  const MODULE_SCRIPT_MAP = {
    'generale': '/modules/inmate/profile/client.js',
    'medicina': '/modules/inmate/medical/client.js',
    'garantii': '/modules/inmate/garantii/client.js',
    'rude': '/modules/inmate/rude/client.js',
    'complici': '/modules/inmate/complici/client.js',
    'hotariri': '/modules/inmate/hotariri/client.js'
  };

  let currentId = null;

  // 2. DYNAMIC SCRIPT LOADER
  function loadScript(src) {
    if (loadedScripts[src]) return Promise.resolve();
    return new Promise((resolve) => {
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => { loadedScripts[src] = true; resolve(); };
      s.onerror = () => { console.warn(`[Module Loader] Failed ${src}`); resolve(); };
      document.head.appendChild(s);
    });
  }

  // 3. FETCH USER CONTEXT
  async function fetchUserContext() {
     if (currentUserRole !== null) return;
     try {
       const userId = sessionStorage.getItem("prison.userId");
       if (!userId) return;
       const res = await window.prisonApi.get(`/nav?userId=${userId}`);
       if (res.success && res.user) {
         currentUserRole = res.user.id_role;
       }
     } catch (e) {
       console.error("Failed to fetch user role", e);
     }
  }

  // 4. RENDER SHELL
  async function renderSkeleton(container) {
    document.body.classList.add('profile-mode');
    
    await fetchUserContext();

    const visibleTabs = TABS_CONFIG.filter(t => {
        if (!t.roles) return true;
        return t.roles.includes(currentUserRole);
    });

    container.innerHTML = `
      <div id="detinutHeader" class="detinut-header">
         <div class="loader-box">Se √ÆncarcƒÉ datele...</div>
      </div>

      <nav class="profile-tabs-nav" id="mainTabs">
        ${visibleTabs.map(t => 
            `<button class="tab-btn" data-tab="${t.key}">${t.label}</button>`
        ).join('')}
      </nav>

      <div id="profileContent" class="profile-content-area">
         <div class="loader-box">Selecta»õi un modul.</div>
      </div>
    `;

    // Bind Clicks
    const contentArea = container.querySelector('#profileContent');
    const buttons = container.querySelectorAll('.tab-btn');

    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        await loadAndRenderModule(btn.dataset.tab, contentArea);
      });
    });
  }

  // 5. HEADER LOGIC
  async function loadHeader(id) {
    const el = document.getElementById('detinutHeader');
    if (!el) return;
    try {
      const res = await window.prisonApi.get(`/detinut/${id}/general`);
      if (!res.success) throw new Error(res.error);
      const d = res.data;
      
      window.currentDetinutData = d; 
      
      const dir1 = d.IDNP ? d.IDNP.charAt(0) : '0';
      const photoFront = `/resources/photos/${dir1}/${d.IDNP}/1.webp`;
      const photoProfile = `/resources/photos/${dir1}/${d.IDNP}/2.webp`;

      // --- NEW LOGIC START ---
      let guaranteeHtml = '';
      if (d.FOLDERPENDING === 'Y') {
          guaranteeHtml = `<div class="badge-guarantee">‚ö†Ô∏è GARAN»öII DE STAT!</div>`;
      }
      // --- NEW LOGIC END ---

      el.innerHTML = `
        <div class="header-photos">
           <img src="${photoFront}" class="header-photo" onerror="this.classList.add('empty'); this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NGEzYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjUiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0yMCAyMWE4IDggMCAwIDAtMTYgMCI+PC9wYXRoPjwvc3ZnPg==';">
           <img src="${photoProfile}" class="header-photo" onerror="this.style.display='none'">
        </div>
        <div class="header-info">
           <h1 class="header-name">
              ${d.SURNAME} ${d.NAME} ${d.SEC_NAME || ''}
              <div style="font-size:0.5em; line-height:1; vertical-align:middle;">${guaranteeHtml}</div>
           </h1>
           <div class="header-meta">
              <div class="meta-pill"><span class="meta-label">ID SISTEM:</span><span class="meta-val">${d.ID}</span></div>
              <div class="meta-pill"><span class="meta-label">IDNP:</span><span class="meta-val">${d.IDNP}</span></div>
              <div class="meta-pill"><span class="meta-label">DATA NA»òTERII:</span><span class="meta-val">${d.BIRDTH}</span></div>
              <div class="meta-pill"><span class="meta-label">PENITENCIAR:</span><span class="meta-val" style="color:#2563eb">${d.PENITENCIAR_NAME || 'Necunoscut'}</span></div>
           </div>
        </div>
        <div class="header-actions" id="headerActions"></div>
      `;
    } catch (e) { 
        el.innerHTML = `<div class="error-box">Eroare header: ${e.message}</div>`; 
        throw e;
    }
  }

  // 6. MODULE LOADING
  async function loadAndRenderModule(key, container) {
    const actionContainer = document.getElementById('headerActions');
    if(actionContainer) actionContainer.innerHTML = '';

    container.innerHTML = '<div class="loader-box">Se √ÆncarcƒÉ modulul...</div>';
    
    // NEW LOGIC: Use the map to find the correct path
    const scriptPath = MODULE_SCRIPT_MAP[key];

    if (scriptPath && !loadedScripts[scriptPath]) {
        await loadScript(scriptPath);
    } else if (!scriptPath) {
        // Fallback for modules not yet in the map (psihologie, securitate, etc.)
        container.innerHTML = `<div class="text-center p-4"><h3 style="color:#94a3b8">Modul √Æn lucru: ${key.toUpperCase()}</h3></div>`;
        return;
    }
    // END NEW LOGIC
    
    const module = window.DetinutTabs[key];
    if (module && typeof module.render === 'function') {
      try { await module.render(container, currentId); } 
      catch (err) { container.innerHTML = `<div class="error-box">Eroare modul: ${err.message}</div>`; }
    } else {
      container.innerHTML = `<div class="text-center p-4"><h3 style="color:#94a3b8">Modul √Æn lucru: ${key.toUpperCase()}</h3></div>`;
    }
  }

  // 7. INIT
  window.prisonModules = window.prisonModules || {};
  window.prisonModules.detinut = {
    async init({ userId, container }) {
      const urlParams = new URLSearchParams(window.location.search);
      currentId = urlParams.get('id');
      if (!currentId) { container.innerHTML = '<div class="error-box">LipsƒÉ ID De»õinut.</div>'; return; }
      
      try {
          await renderSkeleton(container);
          await loadHeader(currentId);
          
          const firstTab = container.querySelector('.tab-btn');
          if (firstTab) firstTab.click();
          
      } catch (e) {
          console.error("Init failed", e);
      }
    },
    destroy() { document.body.classList.remove('profile-mode'); }
  };
})();
</file>

<file path="src/modules/inmate/rude/client.js">
(function() {
    window.DetinutTabs = window.DetinutTabs || {};
    
    let currentIdnp = null;
    let meta = null; // Cache for dropdown data (SPR_RELATIVE_TYPE)

    // --- METADATA LOADER ---
    async function fetchMeta() {
        // If meta is already loaded, skip fetching
        if(meta) return;
        
        const res = await window.prisonApi.get('/detinut/meta/rude');
        if(res.success) meta = res;
        else throw new Error(res.error || "Nu s-au putut √ÆncƒÉrca nomenclatoarele pentru rude.");
    }

    // --- HTML & UI Helpers ---
    function injectRudeModal() {
        // Prevent duplicate injection
        if(document.getElementById('rudeModal')) return;

        // Modal for adding a new relative
        const html = `
        <div class="modal-overlay" id="rudeModal">
            <div class="modal-card" style="max-width:600px;">
                <div class="modal-header">
                    <h3 class="modal-title">AdaugƒÉ RudƒÉ</h3>
                    <button class="btn-close" onclick="window.rudeOps.closeModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="rudeForm" class="admin-form" onsubmit="return false;">
                        <div class="admin-grid-2">
                            <div class="f">
                                <label for="surname">Nume *</label>
                                <input type="text" id="surname" name="surname" class="full-width" required>
                            </div>
                            <div class="f">
                                <label for="name">Prenume *</label>
                                <input type="text" id="name" name="name" class="full-width" required>
                            </div>
                        </div>
                        <div class="admin-grid-2 mt-2">
                             <div class="f">
                                <label for="secName">Patronimic (Op»õional)</label>
                                <input type="text" id="secName" name="secName" class="full-width">
                             </div>
                             <div class="f">
                                <label for="relTypeSelect">Tipul Rela»õiei *</label>
                                <select name="idRelativeType" id="relTypeSelect" class="full-width" required></select>
                            </div>
                        </div>
                        <div class="admin-grid-2 mt-2">
                            <div class="f">
                                <label for="dBirdth">Data Na»ôterii (Op»õional)</label>
                                <input type="text" id="dBirdth" name="dBirdth" class="datepicker full-width" placeholder="DD.MM.YYYY">
                            </div>
                            <div class="f">
                                <label for="idnpRude">IDNP RudƒÉ (Op»õional)</label>
                                <input type="text" id="idnpRude" name="idnpRude" maxlength="13" class="full-width" placeholder="xxxxxxxxxxxxx">
                            </div>
                        </div>
                        <div class="f mt-2">
                            <label for="address">Adresa</label>
                            <input type="text" id="address" name="address" class="full-width">
                        </div>
                        <div class="f mt-2">
                            <label for="phone">Telefon</label>
                            <input type="text" id="phone" name="phone" class="full-width">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-ghost" onclick="window.rudeOps.closeModal()">AnuleazƒÉ</button>
                    <button class="btn-primary" id="btnRudeSave" onclick="window.rudeOps.submitForm()">SalveazƒÉ</button>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // Initialize date picker if available
        if (typeof window.flatpickr !== 'undefined') {
            flatpickr(document.getElementById('dBirdth'), { dateFormat: "d.m.Y" });
        }
    }
    
    function fillSelect(id, items) { 
        const el = document.getElementById(id); 
        if(!el) return;
        el.innerHTML = '<option value="">- SelecteazƒÉ -</option>' + 
                       items.map(i => `<option value="${i.ID}">${i.NAME}</option>`).join(''); 
    }

    // --- DATA & RENDERER ---
    async function loadRelatives(container) {
        container.innerHTML = `<div class="loader-box">Se √ÆncarcƒÉ lista de rude...</div>`;
        
        try {
            const res = await window.prisonApi.get(`/detinut/${currentIdnp}/rude`);
            const rows = res.rows || [];
            const canWrite = res.canWrite; // Determined by W permission check in router

            const btnAdd = canWrite ? 
                `<button class="btn-primary" onclick="window.rudeOps.openModal()">+ AdaugƒÉ RudƒÉ</button>` : '';

            let html = `
                <div class="flex-between" style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:20px;">
                    <h2 style="margin:0; font-size:1.1rem; color:#1e293b;">Lista de Rude</h2>
                    ${btnAdd}
                </div>
            `;

            if (rows.length === 0) {
                html += `<div class="table-empty">Nu existƒÉ rude √Ænregistrate.</div>`;
            } else {
                html += `
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nume & Prenume</th>
                                    <th>Rela»õie</th>
                                    <th>Data Na»ôterii / IDNP</th>
                                    <th>Contact & AdresƒÉ</th>
                                    <th style="width:100px; text-align:center;">Ac»õiuni</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                html += rows.map(r => `
                    <tr>
                        <td><b>${r.SURNAME} ${r.NAME}</b> ${r.SEC_NAME||''}</td>
                        <td>${r.RELATIVE_TYPE_NAME}</td>
                        <td>${r.D_BIRDTH_STR || r.Y_BIRDTH || '‚Äî'} ${r.IDNP ? `(${r.IDNP})` : ''}</td>
                        <td>${r.PHONE || '‚Äî'} / ${r.ADDRESS || '‚Äî'}</td>
                        <td class="text-center">
                            ${canWrite ? `<button class="btn-danger btn-tiny" onclick="window.rudeOps.delete(${r.ID})" title="»òterge RudƒÉ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                            </button>` : '‚Äî'}
                        </td>
                    </tr>
                `).join('');

                html += `</tbody></table></div>`;
            }
            container.innerHTML = html;

        } catch (e) {
            console.error("Error loading relatives:", e);
            container.innerHTML = `<div class="error-box">Eroare la √ÆncƒÉrcarea rudelor: ${e.message}</div>`;
        }
    }

    // --- GLOBAL OPERATIONS WRAPPER ---
    window.rudeOps = {
        openModal: () => {
            const modal = document.getElementById('rudeModal');
            const form = document.getElementById('rudeForm');
            if(form) form.reset();
            
            // Populate dropdown before opening
            if (meta && meta.relativeTypes) {
                fillSelect('relTypeSelect', meta.relativeTypes);
            }
            
            if(modal) modal.classList.add('open');
        },

        closeModal: () => {
            const modal = document.getElementById('rudeModal');
            if(modal) modal.classList.remove('open');
        },

        submitForm: async () => {
            const form = document.getElementById('rudeForm');
            const btn = document.getElementById('btnRudeSave');
            const fd = new FormData(form);
            // Convert FormData to plain object
            const payload = Object.fromEntries(fd);
            
            // Simple Client-side validation
            if(!payload.surname || !payload.name || !payload.idRelativeType) {
                // Use custom alert or visual feedback instead of browser alert
                console.error("Validation failed: Required fields missing.");
                return; 
            }

            btn.disabled = true;
            btn.textContent = "Se salveazƒÉ...";

            try {
                const url = `/detinut/${currentIdnp}/rude`;
                const res = await window.prisonApi.post(url, payload);
                
                if(!res.success) throw new Error(res.error);
                
                window.rudeOps.closeModal();
                await loadRelatives(document.getElementById('profileContent')); // Reload list
            } catch (e) {
                alert("Eroare la salvare: " + e.message); // Use alert as a fallback error notification
            } finally {
                btn.disabled = false;
                btn.textContent = "SalveazƒÉ";
            }
        },

        delete: async (id) => {
            if(!confirm("Sigur »ôterge»õi aceastƒÉ √Ænregistrare de rudƒÉ? AceastƒÉ ac»õiune nu poate fi anulatƒÉ.")) return;
            try {
                const res = await window.prisonApi.del(`/detinut/rude/${id}`);
                if (!res.success) throw new Error(res.error || "»òtergerea nu a reu»ôit.");
                await loadRelatives(document.getElementById('profileContent')); // Reload list
            } catch(e) { 
                alert("Eroare la »ôtergere: " + e.message); 
            }
        }
    };

    // --- TAB RENDER ENTRY POINT ---
    window.DetinutTabs['rude'] = {
        render: async (container, detinutId) => {
             // Get IDNP from global context
             const idnp = window.currentDetinutData ? window.currentDetinutData.IDNP : null;
             if (!idnp) { 
                 container.innerHTML = '<div class="error-box">LipsƒÉ IDNP al de»õinutului.</div>'; 
                 return; 
             }
             currentIdnp = idnp;

             // 1. Fetch Metadata (Dropdowns)
             try {
                 await fetchMeta();
             } catch(e) {
                 container.innerHTML = `<div class="error-box">${e.message}</div>`;
                 return;
             }

             // 2. Inject Modal UI
             injectRudeModal();
             
             // 3. Load & Render Data Table
             await loadRelatives(container);
        }
    };
})();
</file>

<file path="src/modules/inmate/rude/router.js">
const express = require("express");
const db = require("../../../db");
const router = express.Router();

// Modulul ID 3 pentru "Rude" (conform cererii)
const RUDE_MODULE_ID = 3; 

// --- Func»õii Helper ---

// Extrage ID-ul utilizatorului din header (pentru verificare permisiuni)
function getUid(req) { 
  return req.header("x-user-id") ? Number(req.header("x-user-id")) : 0; 
}

// AsigurƒÉ cƒÉ valoarea este null dacƒÉ este undefined, altfel returneazƒÉ valoarea
const safe = (val) => (val === undefined || val === '') ? null : val;

/**
 * VerificƒÉ permisiunile utilizatorului pe un modul specific.
 * @param {number} userId - ID-ul utilizatorului.
 * @param {number} moduleId - ID-ul modulului din SPR_MODULES (aici 3).
 * @param {'R'|'W'} requiredRight - Dreptul minim necesar ('R' sau 'W').
 * @returns {Promise<boolean>}
 */
async function checkPermission(userId, moduleId, requiredRight = 'R') {
  if (!userId) return false;
  try {
    const sql = `SELECT DREPT FROM PRISON.SPR_ACCESS WHERE ID_USER = :u AND ID_MODUL = :m`;
    const res = await db.execute(sql, { u: userId, m: moduleId });
    const right = res.rows.length ? res.rows[0].DREPT : null;
    
    if (!right) return false;
    
    // R (Read) allows R or W access
    if (requiredRight === 'R') return (right === 'R' || right === 'W');
    // W (Write) only allows W access
    if (requiredRight === 'W') return (right === 'W');
    
    return false;
  } catch (e) { 
    console.error("Permission check failed:", e);
    return false;
  }
}

// --- METADATA ROUTE (SPR_RELATIVE_TYPE) ---
router.get("/detinut/meta/rude", async (req, res) => {
  // Metadata is public/read-only info, R access is sufficient
  const uid = getUid(req);
  if (!await checkPermission(uid, RUDE_MODULE_ID, 'R')) {
      return res.status(403).json({ success: false, error: "Acces interzis la metadate." });
  }

  try {
    const typesRes = await db.execute("SELECT ID, NAME FROM PRISON.SPR_RELATIVE_TYPE ORDER BY NAME");
    res.json({
      success: true,
      relativeTypes: typesRes.rows
    });
  } catch(e) { 
    console.error("Error loading relative types:", e);
    res.status(500).json({success:false, error: "Eroare la √ÆncƒÉrcarea tipurilor de rude."}); 
  }
});


// --- LIST RELATIVES (GET) ---
router.get("/detinut/:idnp/rude", async (req, res) => {
    const uid = getUid(req);
    // Check Read Permission
    if (!await checkPermission(uid, RUDE_MODULE_ID, 'R')) {
        return res.status(403).json({ success: false, error: "Acces interzis (Permisiune R lipsƒÉ)." });
    }
    
    // Check Write Permission separately to enable/disable UI buttons
    const canWrite = await checkPermission(uid, RUDE_MODULE_ID, 'W');
    
    try {
        const sql = `
            SELECT R.ID, R.IDNP_DET, R.SURNAME, R.NAME, R.SEC_NAME, R.IDNP, R.PHONE, R.ADDRESS,
                   R.ID_RELATIVE_TYPE,
                   TO_CHAR(R.D_BIRDTH, 'DD.MM.YYYY') as D_BIRDTH_STR,
                   SRT.NAME as RELATIVE_TYPE_NAME
            FROM PRISON.RELATIVES R
            INNER JOIN PRISON.SPR_RELATIVE_TYPE SRT ON SRT.ID = R.ID_RELATIVE_TYPE
            WHERE R.IDNP_DET = :idnp
            ORDER BY R.SURNAME, R.NAME
        `;
        const result = await db.execute(sql, { idnp: req.params.idnp });
        res.json({ success: true, rows: result.rows, canWrite });
    } catch (e) {
        console.error("Error listing relatives:", e);
        res.status(500).json({ success: false, error: e.message });
    }
});

// --- ADD RELATIVE (POST) ---
router.post("/detinut/:idnp/rude", async (req, res) => {
    // Check Write Permission
    if (!await checkPermission(getUid(req), RUDE_MODULE_ID, 'W')) {
        return res.status(403).json({ success: false, error: "Permisiuni insuficiente pentru adƒÉugare (Permisiune W lipsƒÉ)." });
    }
    
    const { surname, name, secName, dBirdth, idRelativeType, idnpRude, phone, address } = req.body;
    
    // Basic validation
    if (!surname || !name || !idRelativeType) {
        return res.status(400).json({ success: false, error: "Nume, Prenume »ôi Tipul Rela»õiei sunt obligatorii." });
    }

    try {
        // ID is populated by the trigger RELATIVES_TRG1 (using RELATIVES_SEQ.nextval)
        const sql = `
            INSERT INTO PRISON.RELATIVES (
                IDNP_DET, SURNAME, NAME, SEC_NAME, D_BIRDTH, ID_RELATIVE_TYPE, IDNP, PHONE, ADDRESS
            ) VALUES (
                :idnp_det, :surname, :name, :secName, 
                ${dBirdth ? `TO_DATE(:dBirdth,'DD.MM.YYYY')` : `NULL`}, 
                :idType, :idnpRude, :phone, :address
            )
        `;
        
        await db.execute(
            sql, 
            {
                idnp_det: req.params.idnp,
                surname: surname.toUpperCase(),
                name: name.toUpperCase(),
                secName: safe(secName),
                dBirdth: safe(dBirdth),
                idType: Number(idRelativeType),
                idnpRude: safe(idnpRude),
                phone: safe(phone),
                address: safe(address)
            }, 
            { autoCommit: true }
        ); 
        res.json({ success: true }); 
    } catch(e) { 
        console.error("Add Relative Error:", e);
        res.status(500).json({ success: false, error: e.message || "Eroare la adƒÉugarea rudei." }); 
    }
});

// --- DELETE RELATIVE (DELETE) ---
router.delete("/detinut/rude/:id", async (req, res) => {
    // Check Write Permission
    if (!await checkPermission(getUid(req), RUDE_MODULE_ID, 'W')) {
        return res.status(403).json({ success: false, error: "Permisiuni insuficiente pentru »ôtergere (Permisiune W lipsƒÉ)." });
    }
    
    try { 
        const id = Number(req.params.id);
        const result = await db.execute("DELETE FROM PRISON.RELATIVES WHERE ID = :id", { id }, { autoCommit: true }); 
        
        if (result.rowsAffected === 0) {
            return res.status(404).json({ success: false, error: "√énregistrarea nu a fost gƒÉsitƒÉ." });
        }
        
        res.json({ success: true }); 
    } catch(e) { 
        console.error("Delete Relative Error:", e);
        res.status(500).json({ success: false, error: e.message || "Eroare la »ôtergerea rudei." }); 
    }
});

module.exports = router;
</file>

<file path="src/modules/reports/client.js">
// public/js/interogari.js
(function () {
  let currentUser = null;
  let institutions = [];

  async function loadInstitutions() {
    const d = await window.prisonApi.get("/interogari/institutions");
    if (d.success) institutions = d.items || [];
  }

  function renderTabs(container) {
    container.innerHTML = `
      <div class="admin-page">
         <header class="admin-header-main">
            <h1 class="admin-title">InterogƒÉri »ôi Rapoarte</h1>
            <p class="app-subtitle">Generare rapoarte opera»õionale.</p>
         </header>

         <div class="admin-tabs">
            <button class="admin-tab-btn active" data-tab="detinuti">üë§ De»õinu»õi</button>
            <button class="admin-tab-btn" data-tab="colete">üì¶ Colete & Vizite</button>
            <button class="admin-tab-btn" data-tab="transfer">üöê Transferuri</button>
            <button class="admin-tab-btn" data-tab="evidenta">üìã Eviden»õƒÉ & Acte</button>
            <button class="admin-tab-btn" data-tab="straini">üåç StrƒÉini</button>
         </div>

         <div class="admin-panel" data-panel="detinuti">
            <h2>Rapoarte De»õinu»õi</h2>
            <div class="admin-grid-2">
               <div class="card-action">
                  <h3>Lista GeneralƒÉ</h3>
                  <p>Afi»ôeazƒÉ to»õi de»õinu»õii din penitenciarul curent.</p>
                  <button class="btn-primary" onclick="runQuery('LISTA')">GenereazƒÉ Lista</button>
               </div>
               <div class="card-action">
                  <h3>Lista pe Institu»õie</h3>
                  <select id="sel_inst_listap" class="full-width mb-2">
                     <option value="">SelecteazƒÉ Penitenciar...</option>
                     ${institutions.map(i => `<option value="${i.ID}">${i.NAME}</option>`).join('')}
                  </select>
                  <button class="btn-primary" onclick="runQuery('LISTAP', {institution_id: getValue('sel_inst_listap')})">GenereazƒÉ</button>
               </div>
               <div class="card-action span-2">
                  <h3>CƒÉutare V√¢rstƒÉ</h3>
                  <div class="row-flex">
                     <input type="number" id="age_min" placeholder="Min Ani" class="sm-input">
                     <input type="number" id="age_max" placeholder="Max Ani" class="sm-input">
                     <select id="sel_inst_age">
                        ${institutions.map(i => `<option value="${i.ID}">${i.NAME}</option>`).join('')}
                     </select>
                     <button class="btn-primary" onclick="runQuery('SEARCH_BY_AGE', {min_age: getValue('age_min'), max_age: getValue('age_max'), institution_id: getValue('sel_inst_age')})">CautƒÉ</button>
                  </div>
               </div>
            </div>
         </div>

         <div class="admin-panel hidden" data-panel="colete">
            <h2>Colete »ôi Vizite</h2>
            <div class="admin-grid-2">
               <div class="card-action">
                  <h3>CautƒÉ Colet (SursƒÉ)</h3>
                  <input type="text" id="col_source" placeholder="Nume sursƒÉ..." class="mb-2 full-width">
                  <button class="btn-primary" onclick="runQuery('COLETE', {sursa: getValue('col_source')})">CautƒÉ</button>
               </div>
               <div class="card-action">
                  <h3>Colete dupƒÉ DatƒÉ</h3>
                  <div class="row-flex mb-2">
                     <input type="text" id="col_d1" placeholder="DD.MM.YYYY">
                     <input type="text" id="col_d2" placeholder="DD.MM.YYYY">
                  </div>
                  <button class="btn-primary" onclick="runQuery('SEARCH_COLETA_DATE', {start_date: getValue('col_d1'), end_date: getValue('col_d2')})">CautƒÉ</button>
               </div>
               <div class="card-action span-2">
                  <h3>CƒÉutare √éntrevedere</h3>
                  <input type="text" id="viz_name" placeholder="Nume vizitator..." class="mb-2 full-width">
                  <button class="btn-primary" onclick="runQuery('CAUTINTREVEDERE', {term: getValue('viz_name')})">CautƒÉ</button>
               </div>
            </div>
         </div>

         <div class="admin-panel hidden" data-panel="transfer">
             <h2>Transferuri »ôi EscortƒÉri</h2>
             <div class="admin-grid-2">
                <div class="card-action">
                   <h3>Tabel Escortare</h3>
                   <input type="text" id="esc_date" placeholder="DD.MM.YYYY" value="${new Date().toLocaleDateString('ro-RO')}" class="mb-2 full-width">
                   <button class="btn-primary" onclick="runQuery('TABELESCORTARE', {date: getValue('esc_date')})">GenereazƒÉ</button>
                </div>
                <div class="card-action">
                   <h3>Transfer Penitenciare</h3>
                   <input type="text" id="trans_date" placeholder="DD.MM.YYYY" value="${new Date().toLocaleDateString('ro-RO')}" class="mb-2 full-width">
                   <button class="btn-primary" onclick="runQuery('TABELTRANSFERPENITENCIARE', {date: getValue('trans_date')})">GenereazƒÉ</button>
                </div>
                <div class="card-action">
                   <h3>Mi»ôcare Celule</h3>
                   <div class="row-flex mb-2">
                     <input type="text" id="cell_d1" placeholder="Start (DD.MM.YYYY)">
                     <input type="text" id="cell_d2" placeholder="End">
                   </div>
                   <button class="btn-primary" onclick="runQuery('LISTADUPACELULE', {start_date: getValue('cell_d1'), end_date: getValue('cell_d2')})">CautƒÉ</button>
                </div>
                <div class="card-action">
                   <h3>Securitate PersonalƒÉ (206)</h3>
                   <p>De»õinu»õi cu regim special.</p>
                   <button class="btn-primary" onclick="runQuery('LISTA206')">GenereazƒÉ</button>
                </div>
                 <div class="card-action">
                   <h3>Ecusoane</h3>
                   <p>Generare listƒÉ pentru ecusoane.</p>
                   <button class="btn-primary" onclick="runQuery('ECUSON')">GenereazƒÉ</button>
                </div>
             </div>
         </div>

         <div class="admin-panel hidden" data-panel="evidenta">
             <h2>Eviden»õƒÉ »ôi Acte</h2>
             <div class="admin-grid-2">
                <div class="card-action">
                   <h3>Acte Expirate</h3>
                   <p>ListƒÉ completƒÉ de»õinu»õi cu acte expirate.</p>
                   <button class="btn-primary" onclick="runQuery('SEARCH_ACTE_EXPIRED')">CautƒÉ</button>
                </div>
                 <div class="card-action">
                   <h3>CƒÉutare dupƒÉ Articol</h3>
                   <input type="text" id="art_num" placeholder="NumƒÉr articol..." class="mb-2 full-width">
                   <button class="btn-primary" onclick="runQuery('CAUTARTICOL', {article: getValue('art_num')})">CautƒÉ</button>
                </div>
                <div class="card-action">
                   <h3>De»õinu»õi Elibera»õi</h3>
                    <div class="row-flex mb-2">
                     <input type="text" id="rel_d1" placeholder="Start">
                     <input type="text" id="rel_d2" placeholder="End">
                   </div>
                   <button class="btn-primary" onclick="runQuery('ELIBERATI', {start_date: getValue('rel_d1'), end_date: getValue('rel_d2')})">CautƒÉ</button>
                </div>
                 <div class="card-action">
                   <h3>Registru Leziuni</h3>
                    <div class="row-flex mb-2">
                     <input type="text" id="lez_d1" placeholder="Start">
                     <input type="text" id="lez_d2" placeholder="End">
                   </div>
                   <button class="btn-primary" onclick="runQuery('SEARCH_LEZIUNI', {start_date: getValue('lez_d1'), end_date: getValue('lez_d2')})">CautƒÉ</button>
                </div>
             </div>
         </div>
         
         <div class="admin-panel hidden" data-panel="straini">
            <h2>Eviden»õƒÉ StrƒÉini</h2>
             <div class="admin-grid-2">
                <div class="card-action">
                   <h3>CetƒÉ»õeni StrƒÉini</h3>
                   <p>ListƒÉ activƒÉ.</p>
                   <button class="btn-primary" onclick="runQuery('CETATENI')">GenereazƒÉ</button>
                </div>
                <div class="card-action">
                   <h3>StrƒÉini Elibera»õi (An Curent)</h3>
                   <p>Rapoarte pe anul √Æn curs.</p>
                   <button class="btn-primary" onclick="runQuery('STRAINI_ELIBERATI')">GenereazƒÉ</button>
                </div>
             </div>
         </div>

         <div id="queryResultsArea" class="mt-4 hidden">
            <div class="flex-between">
               <h2 id="resTitle">Rezultate</h2>
               <button class="btn-secondary" onclick="printCurrentResults()">üñ®Ô∏è PrinteazƒÉ PDF</button>
            </div>
            <div class="table-wrapper">
               <table class="data-table" id="resTable">
                  <thead></thead>
                  <tbody></tbody>
               </table>
            </div>
         </div>
      </div>
    `;

    container.querySelectorAll('.admin-tab-btn').forEach(btn => {
       btn.addEventListener('click', () => {
          container.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          container.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden'));
          container.querySelector(`[data-panel="${btn.dataset.tab}"]`).classList.remove('hidden');
       });
    });
  }

  window.getValue = (id) => {
     const el = document.getElementById(id);
     return el ? el.value.trim() : '';
  };

  let lastResult = null;

  window.runQuery = async (type, params = {}) => {
     const resArea = document.getElementById('queryResultsArea');
     const tHead = document.querySelector('#resTable thead');
     const tBody = document.querySelector('#resTable tbody');
     const titleEl = document.getElementById('resTitle');

     resArea.classList.remove('hidden');
     tBody.innerHTML = '<tr><td colspan="10" class="text-center">Se √ÆncarcƒÉ...</td></tr>';
     
     try {
        const data = await window.prisonApi.post('/interogari/exec', { type, params });
        if(!data.success) throw new Error(data.error);

        lastResult = data;
        titleEl.textContent = data.title;
        
        // Render Header
        tHead.innerHTML = `<tr>${data.headers.map(h => `<th>${h}</th>`).join('')}<th>Dosar</th></tr>`;
        
        // Render Rows
        if(data.rows.length === 0) {
           tBody.innerHTML = `<tr><td colspan="${data.headers.length + 1}" class="text-center p-4">Nu au fost gƒÉsite rezultate.</td></tr>`;
        } else {
           tBody.innerHTML = data.rows.map(r => {
              // Extract logic: All columns except REF_ID are rendered.
              // REF_ID is used solely for the button.
              // Note: The backend ensures REF_ID (or equivalent) is sent, usually as 'REF_ID'.
              
              const entries = Object.entries(r);
              // Find ID for the button (looking for common ID keys)
              const idKeys = ['REF_ID', 'DETINUT_ID', 'IDDETINUT'];
              const idEntry = entries.find(([k]) => idKeys.includes(k.toUpperCase()));
              const id = idEntry ? idEntry[1] : 0;

              // Generate Cells (Skip ID keys)
              const cells = entries.map(([k, v]) => {
                  if (idKeys.includes(k.toUpperCase())) return ''; // Don't render ID column
                  return `<td>${v === null ? '' : v}</td>`;
              }).join('');
              
              // Only show button if we found a valid ID
              const btn = id ? `<button class="btn-small" onclick="window.location.href='/app/index.html?module=detinut&id=${id}'">Dosar</button>` : '';
              
              return `<tr>${cells}<td>${btn}</td></tr>`;
           }).join('');
        }
     } catch(e) {
        tBody.innerHTML = `<tr><td colspan="10" class="error-text">Eroare: ${e.message}</td></tr>`;
     }
  };

  window.printCurrentResults = async () => {
     if(!lastResult) return;
     
     try {
       const resp = await fetch('/api/interogari/print', {
          method: 'POST',
          headers: {
             'Content-Type': 'application/json',
             'x-user-id': sessionStorage.getItem("prison.userId")
          },
          body: JSON.stringify(lastResult)
       });
       const text = await resp.text();
       // Open new window and write HTML
       const win = window.open('', '_blank');
       win.document.write(text);
       win.document.close();
     } catch(e) {
        alert("Eroare la generarea printului.");
     }
  };

  window.prisonModules = window.prisonModules || {};
  window.prisonModules.interogari = {
    async init({ userId, container }) {
      document.body.classList.add('wide-mode'); 
      await loadInstitutions();
      renderTabs(container);
    }
  };
})();
</file>

<file path="src/modules/reports/router.js">
const express = require("express");
const db = require("../../db");const router = express.Router();

/* HELPER: Get User Info for Print Headers */
async function getUserInfo(req) {
  const uid = Number(req.header("x-user-id") || 0);
  if (!uid) return { username: "Unknown", role: 0 };
  try {
    const r = await db.execute("SELECT USERNAME, ID_ROLE FROM USERS WHERE ID = :id", { id: uid });
    if (r.rows && r.rows.length) {
      return { username: r.rows[0].USERNAME, role: Number(r.rows[0].ID_ROLE) };
    }
  } catch (e) { console.error(e); }
  return { username: "Unknown", role: 0 };
}

router.post("/interogari/exec", async (req, res) => {
  const { type, params } = req.body;
  const uid = Number(req.header("x-user-id"));
  
  let sql = "";
  let binds = {};
  let headers = []; 
  let title = "";

  try {
    switch (type) {
      // ========================================================================
      // GROUP: DETINUTI
      // ========================================================================
      
      case 'LISTA': 
        const uRes = await db.execute("SELECT ID_PENITENTIAR FROM USERS WHERE ID = :id", { id: uid });
        const userPen = uRes.rows[0]?.ID_PENITENTIAR;
        
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, PM.ID_PENETENCIAR AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd 
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp) 
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
             ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE PM.ID_PENETENCIAR = :pid AND PM.ID_TYPE_MISCARI IN (1,3)
          GROUP BY PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, PM.ID_PENETENCIAR, PD.ID, PD.IDNP
          ORDER BY NUME, PRENUME
        `;
        binds = { pid: userPen || 0 };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar"];
        title = "Lista De»õinu»õi (Institu»õia CurentƒÉ)";
        break;

      case 'LISTAP': 
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, pen.NAME AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR pen ON (pm.ID_PENETENCIAR = pen.ID)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
             ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE PM.ID_PENETENCIAR = :pid AND (PM.ID_TYPE_MISCARI IN (1,3))
          GROUP BY PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, PM.ID_PENETENCIAR, PD.ID, PD.IDNP, pen.NAME
          ORDER BY NUME, PRENUME
        `;
        binds = { pid: params.institution_id };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar"];
        title = "Lista De»õinu»õi pe Institu»õie";
        break;

      case 'SEARCH_BY_AGE':
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, 
                 TRUNC(MONTHS_BETWEEN(SYSDATE, PD.BIRDTH)/12) AS VARSTA,
                 PEN.NAME AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI PD
          INNER JOIN PRISON.MISCARI PM ON PD.IDNP = PM.IDNP
          INNER JOIN PRISON.SPR_PENITENCIAR PEN ON PEN.ID = PM.ID_PENETENCIAR
          INNER JOIN (SELECT IDNP, MAX(ADATE) AS DT FROM PRISON.MISCARI GROUP BY IDNP) LAST
            ON LAST.IDNP = PD.IDNP AND LAST.DT = PM.ADATE
          WHERE PM.ID_TYPE_MISCARI IN (1,3)
            AND PM.ID_PENETENCIAR = :idpen
            AND TRUNC(MONTHS_BETWEEN(SYSDATE, PD.BIRDTH)/12) BETWEEN :minage AND :maxage
          ORDER BY NUME, PRENUME
        `;
        binds = { idpen: params.institution_id, minage: params.min_age, maxage: params.max_age };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "V√¢rsta", "Penitenciar"];
        title = `CƒÉutare V√¢rstƒÉ (${params.min_age}-${params.max_age} ani)`;
        break;

      // ========================================================================
      // GROUP: STRAINI
      // ========================================================================
      case 'CETATENI':
        const uRes2 = await db.execute("SELECT ID_PENITENTIAR FROM USERS WHERE ID = :id", { id: uid });
        const myPen = uRes2.rows[0]?.ID_PENITENTIAR;

        let whereClause = "";
        binds = {};
        if (myPen) {
          whereClause = "WHERE PENITENCIAR = :pid";
          binds.pid = myPen; 
        }

        // Explicitly select columns to avoid "ID" appearing first or mismatched columns
        sql = `
            SELECT IDNP, NUME, PRENUME, PATRONIMIC, 
                   TO_CHAR(DATANASTERII, 'DD.MM.YYYY') as DATANASTERII, 
                   PENITENCIAR, CETATENIE, ID AS REF_ID 
            FROM V_STRAINI ${whereClause} ORDER BY CETATENIE
        `;
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar", "CetƒÉ»õenie"];
        title = "CetƒÉ»õeni StrƒÉini";
        break;

      case 'STRAINI_ELIBERATI':
        const currentYear = new Date().getFullYear();
        sql = `
          SELECT 
            PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
            TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, PD.SEX, sprpen.name AS PENITENCIARUL,
            NVL((SELECT listagg(sprstz.name,',') WITHIN GROUP (ORDER BY sprstz.name)
                 FROM PRISON.SITIZEN stz 
                 INNER JOIN Prison.SPR_SITIZEN sprstz ON (stz.id_sitizen = sprstz.id)
                 WHERE stz.idnp = PD.IDNP GROUP BY stz.idnp), '-') AS CETATENIE,
            PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd 
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SITIZEN pst ON (pst.IDNP = pd.IDNP)
          INNER JOIN PRISON.SPR_PENITENCIAR sprpen ON (sprpen.id = pm.id_penetenciar)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
             ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE (pst.ID_SITIZEN NOT IN (498)) 
            AND (PM.ID_TYPE_MISCARI = 4) 
            AND pm.ADATE BETWEEN TO_DATE('01.01.${currentYear}','DD.MM.YYYY') AND TO_DATE('31.12.${currentYear}','DD.MM.YYYY')
          ORDER BY PENITENCIARUL
        `;
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Sex", "Penitenciar", "CetƒÉ»õenie"];
        title = `StrƒÉini Elibera»õi (${currentYear})`;
        break;

      // ========================================================================
      // GROUP: TRANSFERURI / ESCORTARE
      // ========================================================================
      case 'TABELESCORTARE':
        sql = `
          SELECT d.IDNP, d.SURNAME AS NUME, d.NAME AS PRENUME, d.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(vcitatie.ADATE, 'DD.MM.YYYY') AS DATASEDINTA, vcitatie.ORASEDINTA, vcitatie.NAME_INSTANTE, vcitatie.NPPJUDECATOR,
                 vcitatie.NRSALA, vcitatie.NAME_LOCJUDECATA, pen.NAME AS PENITENCIAR, vcitatie.EXECUTOR_TRANSFER,
                 d.ID AS REF_ID
          FROM PRISON.V_CITATIE vcitatie
          INNER JOIN PRISON.DETINUTI d ON (vcitatie.IDNP = d.IDNP)
          INNER JOIN PRISON.MISCARI pm ON (d.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR pen ON (PM.ID_PENETENCIAR = pen.ID)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2  GROUP BY pm2.idnp) md
            ON (md.idnp = d.idnp AND pm.adate = md.dt)
          WHERE (PM.ID_TYPE_MISCARI IN (1,3)) AND vcitatie.ADATE = TO_DATE(:d,'DD.MM.YYYY') AND vcitatie.ANULAT <> 'Y'
          GROUP BY d.ID, d.IDNP, d.NAME, d.SURNAME, d.SEC_NAME, vcitatie.ADATE, vcitatie.ORASEDINTA, vcitatie.NAME_INSTANTE,
                   vcitatie.NPPJUDECATOR, vcitatie.NRSALA, pen.NAME, vcitatie.EXECUTOR_TRANSFER, vcitatie.NAME_LOCJUDECATA
          ORDER BY pen.NAME, vcitatie.NAME_INSTANTE
        `;
        binds = { d: params.date };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data »òedin»õƒÉ", "Ora»ô", "Instan»õƒÉ", "JudecƒÉtor", "SalƒÉ", "Loc JudecatƒÉ", "Penitenciar", "Executor"];
        title = `Tabel Escortare (${params.date})`;
        break;

      case 'TABELTRANSFERPENITENCIARE':
        sql = `
          SELECT d.IDNP, d.SURNAME AS NUME, d.NAME AS PRENUME, d.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(vcitatie.ADATE, 'DD.MM.YYYY') AS DATASEDINTA, vcitatie.ORASEDINTA, vcitatie.NAME_INSTANTE, vcitatie.NPPJUDECATOR,
                 vcitatie.NRSALA, pen.NAME AS PENITENCIAR,
                 d.ID AS REF_ID
          FROM PRISON.V_CITATIE vcitatie
          INNER JOIN PRISON.DETINUTI d ON (vcitatie.IDNP = d.IDNP)
          INNER JOIN PRISON.MISCARI pm ON (d.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR pen ON (PM.ID_PENETENCIAR = pen.ID)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
            ON (md.idnp = d.idnp AND pm.adate = md.dt)
          WHERE (PM.ID_TYPE_MISCARI IN (1,3)) AND vcitatie.ADATE = TO_DATE(:d,'DD.MM.YYYY') AND vcitatie.ANULAT <> 'Y'
          GROUP BY d.ID, d.IDNP, d.NAME, d.SURNAME, d.SEC_NAME, vcitatie.ADATE, vcitatie.ORASEDINTA, vcitatie.NAME_INSTANTE,
                   vcitatie.NPPJUDECATOR, vcitatie.NRSALA, pen.NAME, vcitatie.EXECUTOR_TRANSFER
          ORDER BY pen.NAME, vcitatie.NAME_INSTANTE
        `;
        binds = { d: params.date };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Transfer", "Ora»ô", "Instan»õƒÉ", "JudecƒÉtor", "SalƒÉ", "Penitenciar"];
        title = `Transfer Penitenciare (${params.date})`;
        break;

      case 'LISTADUPACELULE':
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, PMC.ROOM AS CELULA, 
                 TO_CHAR(PMC.ADATE, 'DD.MM.YYYY HH24:MI') AS DATAMISCARECELULA, pen.NAME AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR pen ON (PM.ID_PENETENCIAR = pen.ID)
          INNER JOIN PRISON.MISCARI_CELULE pmc ON (pmc.ID_MISCARI = pm.ID)
          WHERE (PM.ID_TYPE_MISCARI IN (1,3))
            AND (pmc.ADATE BETWEEN TO_DATE(:b,'DD.MM.YYYY') AND TO_DATE(:e,'DD.MM.YYYY'))
          ORDER BY pen.NAME, PMC.ADATE
        `;
        binds = { b: params.start_date, e: params.end_date };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Na»ôtere", "CelulƒÉ", "Data Mi»ôcare", "Penitenciar"];
        title = `Mi»ôcare Celule (${params.start_date} - ${params.end_date})`;
        break;

      case 'LISTA206': // Securitate Personala
        const uRes3 = await db.execute("SELECT ID_PENITENTIAR FROM USERS WHERE ID = :id", { id: uid });
        const pen206 = uRes3.rows[0]?.ID_PENITENTIAR || 0;
        
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, penit.NAME AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR penit ON (penit.ID = PM.ID_PENETENCIAR)
          INNER JOIN PRISON.SECURITATE_PERSONALA secpers ON (secpers.idnp = pd.idnp)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
            ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE PM.ID_PENETENCIAR = :pid AND secpers.EDATE IS NULL AND PM.ID_TYPE_MISCARI IN (1,3)
          GROUP BY PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, penit.NAME, PD.ID, PD.IDNP
          ORDER BY penit.NAME, PD.SURNAME, PD.NAME
        `;
        binds = { pid: pen206 };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar"];
        title = "Securitate PersonalƒÉ (Art. 206)";
        break;

      case 'ECUSON':
         const uRes4 = await db.execute("SELECT ID_PENITENTIAR FROM USERS WHERE ID = :id", { id: uid });
         const penBadge = uRes4.rows[0]?.ID_PENITENTIAR || 0;
         sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, PM.ID_PENETENCIAR AS PENITENCIAR,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd 
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp )
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
            ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE PM.ID_PENETENCIAR = :pid AND PM.ID_TYPE_MISCARI IN (1,3)
          GROUP BY PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, PM.ID_PENETENCIAR, PD.ID, PD.IDNP
          ORDER BY NUME, PRENUME
         `;
         binds = { pid: penBadge };
         headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar"];
         title = "Generare Ecusoane";
         break;

      // ========================================================================
      // GROUP: COLETE / VIZITE
      // ========================================================================
      case 'COLETE': // by Source
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC, 
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, penit.NAME AS PENITENCIAR,
                 c.SURSA_PROV, TO_CHAR(c.DATE_IN, 'DD.MM.YYYY') AS DATA_INTRARE,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR penit ON (penit.ID = PM.ID_PENETENCIAR)
          INNER JOIN PRISON.COLETA c ON (c.idnp = pd.idnp)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
             ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE UPPER(c.SURSA_PROV) LIKE :s 
          GROUP BY PD.ID, PD.IDNP, PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, penit.NAME, c.SURSA_PROV, c.DATE_IN
          ORDER BY NUME, PRENUME
        `;
        binds = { s: `%${(params.sursa || '').toUpperCase()}%` };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar", "Sursa", "Data Intrare"];
        title = `Colete (Sursa: ${params.sursa})`;
        break;

      case 'SEARCH_COLETA_DATE':
        // Removed c.ID (Package ID) from selection to avoid confusion
        sql = `
          SELECT c.IDNP, d.SURNAME || ' ' || d.NAME as NUME_DETINUT, c.PERSON, 
                 TO_CHAR(c.DATE_IN, 'DD.MM.YYYY') AS DATE_IN, c.CONTINUT, c.SURSA_PROV,
                 d.ID AS REF_ID
          FROM PRISON.COLETA c
          LEFT JOIN PRISON.DETINUTI d ON d.IDNP = c.IDNP
          WHERE c.DATE_IN BETWEEN TO_DATE(:b,'DD.MM.YYYY') AND TO_DATE(:e,'DD.MM.YYYY')
          ORDER BY c.DATE_IN DESC
        `;
        binds = { b: params.start_date, e: params.end_date };
        headers = ["IDNP", "De»õinut", "PersoanƒÉ Predare", "Data", "Con»õinut", "SursƒÉ"];
        title = `Colete (${params.start_date} - ${params.end_date})`;
        break;
        
      case 'CAUTINTREVEDERE':
         const qTerm = (params.term || '').toUpperCase();
         sql = `
            SELECT I.IDNP, I.SURNAME, I.NAME, I.SEC_NAME, I.NRDOCUMENT, 
                   TO_CHAR(I.BDATE, 'DD.MM.YYYY') AS DATA_VIZITA,
                   D.ID AS REF_ID
            FROM PRISON.INTREVEDERI I
            LEFT JOIN PRISON.DETINUTI D ON I.IDNP = D.IDNP
            WHERE UPPER(I.SURNAME) LIKE '%' || :q || '%'
               OR UPPER(I.SEC_NAME) LIKE '%' || :q || '%'
               OR UPPER(I.NAME)    LIKE '%' || :q || '%'
               OR UPPER(I.NRDOCUMENT) LIKE '%' || :q || '%'
            ORDER BY I.SURNAME, I.NAME
         `;
         binds = { q: qTerm };
         headers = ["IDNP", "Nume Vizitator", "Prenume", "Patronimic", "Nr. Doc", "Data"];
         title = `√éntrevederi (${params.term})`;
         break;

      // ========================================================================
      // GROUP: EVIDENTA
      // ========================================================================
      case 'ELIBERATI':
        sql = `
          SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, pen.NAME AS PENITENCIAR, 
                 TO_CHAR(PM.ADATE, 'DD.MM.YYYY') AS DATAELIBERARE,
                 PD.ID AS REF_ID
          FROM PRISON.DETINUTI pd
          INNER JOIN PRISON.MISCARI pm ON (pd.idnp = pm.idnp)
          INNER JOIN PRISON.SPR_PENITENCIAR pen ON (PM.ID_PENETENCIAR = pen.ID)
          INNER JOIN (SELECT pm2.idnp AS idnp, MAX(pm2.adate) AS dt FROM PRISON.MISCARI pm2 GROUP BY pm2.idnp) md
            ON (md.idnp = pd.idnp AND pm.adate = md.dt)
          WHERE (PM.ID_TYPE_MISCARI = 4)
            AND (PM.ADATE BETWEEN TO_DATE(:b,'DD.MM.YYYY') AND TO_DATE(:e,'DD.MM.YYYY'))
          ORDER BY NUME, PRENUME
        `;
        binds = { b: params.start_date, e: params.end_date };
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Na»ôtere", "Penitenciar", "Data Eliberare"];
        title = `Elibera»õi (${params.start_date} - ${params.end_date})`;
        break;

      case 'SEARCH_ACTE_EXPIRED':
        sql = `
          SELECT DISTINCT d.IDNP, d.SURNAME AS NUME, d.NAME AS PRENUME, d.SEC_NAME AS PATRONIMIC,
                 TO_CHAR(d.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, pen.NAME AS PENITENCIARUL,
                 d.ID AS REF_ID
          FROM PRISON.DETINUTI d
          JOIN PRISON.MISCARI m ON m.IDNP = d.IDNP
          JOIN (
              SELECT IDNP FROM PRISON.ACTE GROUP BY IDNP HAVING MAX(VALABIL_PINA) < TRUNC(SYSDATE)
          ) a ON a.IDNP = d.IDNP
          JOIN PRISON.SPR_PENITENCIAR pen ON pen.ID = m.ID_PENETENCIAR
          JOIN (SELECT IDNP, MAX(ADATE) AS ADATE FROM PRISON.MISCARI GROUP BY IDNP) md
            ON md.IDNP = m.IDNP AND md.ADATE = m.ADATE
          WHERE m.ID_TYPE_MISCARI IN (1, 3)
          ORDER BY pen.NAME, d.SURNAME
        `;
        headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Na»ôtere", "Penitenciar"];
        title = "Acte Expirate (Toate)";
        break;
        
      case 'SEARCH_LEZIUNI':
         sql = `
          SELECT i.IDNP, d.SURNAME || ' ' || d.NAME as NUME,
                 TO_CHAR(i.INSERTEDDATE, 'DD.MM.YYYY') AS INSERTEDDATE, s.NAME AS INCIDENT_TYPE,
                 i.CIRCUMSTANTE, i.MEDICAL_CONCLUSION, p.NAME AS PENITENCIAR, 
                 d.ID AS REF_ID
          FROM PRISON.INCIDENTS i
          JOIN PRISON.SPR_TYPE_INCIDENT s ON i.ID_TYPE_INCIDENT = s.ID
          JOIN PRISON.SPR_PENITENCIAR p ON i.ID_PENITENCIAR = p.ID
          LEFT JOIN PRISON.DETINUTI d ON d.IDNP = i.IDNP
          WHERE i.INSERTEDDATE BETWEEN TO_DATE(:b,'DD.MM.YYYY') AND TO_DATE(:e,'DD.MM.YYYY')
          ORDER BY i.INSERTEDDATE DESC
         `;
         binds = { b: params.start_date, e: params.end_date };
         headers = ["IDNP", "Nume", "Data", "Tip", "Circumstan»õe", "Concluzie", "Penitenciar"];
         title = `Leziuni (${params.start_date} - ${params.end_date})`;
         break;
         
      case 'CAUTARTICOL':
         const aRes = await db.execute("SELECT ID FROM PRISON.SPR_ARTICOL WHERE ANUMBER = :anum", { anum: params.article });
         if (!aRes.rows.length) {
             return res.json({ success: true, rows: [], headers: [], title: "CƒÉutare Articol: " + params.article });
         }
         const artId = aRes.rows[0].ID;
         sql = `
           SELECT PD.IDNP, PD.SURNAME AS NUME, PD.NAME AS PRENUME, PD.SEC_NAME AS PATRONIMIC,
                  TO_CHAR(PD.BIRDTH, 'DD.MM.YYYY') AS DATANASTERII, PEN.NAME AS PENITENCIARUL,
                  PD.ID AS REF_ID
           FROM PRISON.DETINUTI PD
           INNER JOIN PRISON.MISCARI PM ON (PD.IDNP = PM.IDNP)
           INNER JOIN PRISON.HOTARIRI_JUD PHOT ON (PD.IDNP = PHOT.IDNP)
           INNER JOIN PRISON.SPR_PENITENCIAR PEN ON (PM.ID_PENETENCIAR = PEN.ID)
           INNER JOIN PRISON.ARTICOLES PART ON (PHOT.ID = PART.ID_DOCUMENT AND PART.TYPE_DOCUMENT = 2 AND PART.ID_ARTICOL = :id)
           INNER JOIN (SELECT PM2.IDNP, MAX(PM2.ADATE) AS DT FROM PRISON.MISCARI PM2 GROUP BY PM2.IDNP) MD
              ON (MD.IDNP = PD.IDNP AND PM.ADATE = MD.DT)
           WHERE PM.ID_TYPE_MISCARI IN (1,3)
           GROUP BY PD.ID, PD.IDNP, PD.SURNAME, PD.NAME, PD.SEC_NAME, PD.BIRDTH, PEN.NAME
           ORDER BY PD.SURNAME
         `;
         binds = { id: artId };
         headers = ["IDNP", "Nume", "Prenume", "Patronimic", "Data Na»ôterii", "Penitenciar"];
         title = `CƒÉutare dupƒÉ Articol: ${params.article}`;
         break;

      default:
        return res.status(400).json({ success: false, error: "Tip interogare necunoscut." });
    }

    const result = await db.execute(sql, binds);
    res.json({
      success: true,
      rows: result.rows || [],
      headers: headers,
      title: title
    });

  } catch (err) {
    console.error("Interogari Error:", err);
    res.status(500).json({ success: false, error: err.message });
  }
});

router.post("/interogari/print", async (req, res) => {
  const { headers, rows, title } = req.body;
  const userInfo = await getUserInfo(req);
  const dateStr = new Date().toLocaleString('ro-RO');

  // Filter out REF_ID from rows for printing
  const printRows = rows.map(r => {
    // We assume backend logic: REF_ID is the last key, or named specifically.
    // However, headers logic matches visual logic. 
    // We will iterate based on headers length to ensure we don't print hidden ID.
    const values = Object.values(r);
    return values.slice(0, headers.length); // simple approach: take first N values matching N headers
  });

  const html = `
  <!DOCTYPE html>
  <html lang="ro">
  <head>
    <meta charset="UTF-8">
    <title>Raport: ${title}</title>
    <style>
      body { font-family: "Courier New", Courier, monospace; font-size: 12px; padding: 20px; }
      h1 { font-size: 16px; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
      .meta { margin-bottom: 20px; font-size: 11px; color: #333; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #000; padding: 4px 6px; text-align: left; font-size: 11px; }
      th { background-color: #f0f0f0; font-weight: bold; }
      @media print {
        .no-print { display: none; }
        th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
      }
    </style>
  </head>
  <body>
    <div class="no-print" style="margin-bottom: 20px;">
      <button onclick="window.print()" style="padding: 8px 16px; cursor:pointer;">üñ®Ô∏è PrinteazƒÉ acum</button>
      <button onclick="window.close()" style="padding: 8px 16px; cursor:pointer;">√énchide</button>
    </div>
    <h1>RAPORT: ${title}</h1>
    <div class="meta">
      <strong>Generat de:</strong> ${userInfo.username} (Rol: ${userInfo.role})<br/>
      <strong>Data generƒÉrii:</strong> ${dateStr}<br/>
      <strong>Total √ÆnregistrƒÉri:</strong> ${rows.length}
    </div>
    <table>
      <thead>
        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
      </thead>
      <tbody>
        ${printRows.map(vals => `<tr>${vals.map(v => `<td>${v || ''}</td>`).join('')}</tr>`).join('')}
      </tbody>
    </table>
  </body>
  </html>
  `;
  res.send(html);
});

router.get("/interogari/institutions", async (req, res) => {
  try {
    const r = await db.execute("SELECT ID, NAME FROM PRISON.SPR_PENITENCIAR ORDER BY NAME");
    res.json({ success: true, items: r.rows });
  } catch (e) {
    res.status(500).json({ success: false, error: e.message });
  }
});

module.exports = router;
</file>

<file path="src/modules/search/client.js">
// public/js/cautare.js
(function () {
  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function buildLayout(container) {
    container.innerHTML = `
      <h1 class="app-title">Modul: CƒÉutare</h1>
      <p class="app-subtitle">
        CƒÉutare de»õinu»õi dupƒÉ nume, IDNP, datƒÉ na»ôtere sau numƒÉr de dosar.
        Introduce»õi cel pu»õin un criteriu.
      </p>

      <section class="search-card">
        <h2 class="section-title">Criterii de cƒÉutare</h2>
        <form class="search-form" data-role="search">
          <div class="fields-grid">
            <div class="f">
              <label for="searchSurname">Nume</label>
              <input id="searchSurname" name="surname" type="text" autocomplete="off" placeholder="EX: POPESCU" />
            </div>
            <div class="f">
              <label for="searchName">Prenume</label>
              <input id="searchName" name="name" type="text" autocomplete="off" placeholder="EX: ION" />
            </div>
            <div class="f">
              <label for="searchSecName">Patronimic</label>
              <input id="searchSecName" name="secName" type="text" autocomplete="off" placeholder="EX: VASILE" />
            </div>
            <div class="f">
              <label for="searchIdnp">IDNP</label>
              <input id="searchIdnp" name="idnp" type="text" autocomplete="off" placeholder="EX: 1234567890123" />
            </div>
            <div class="f">
              <label for="searchBirth">Data na»ôterii</label>
              <input id="searchBirth" name="birth" type="text" autocomplete="off" placeholder="ZZ.LL.AAAA" />
            </div>
            <div class="f">
              <label for="searchId">Nr. Dosar</label>
              <input id="searchId" name="id" type="text" autocomplete="off" placeholder="EX: 12345" />
            </div>
          </div>

          <div class="search-actions">
            <button type="submit" class="btn-primary" data-role="submit">CautƒÉ</button>
          </div>
          <p class="form-message" id="searchMessage"></p>
        </form>
      </section>

      <section class="search-results" id="searchResultsSection" style="display:none;">
        <h2 class="section-title">Rezultate</h2>
        <p class="search-results-info" id="searchResultsInfo"></p>
        <div class="search-grid" id="searchGrid"></div>
      </section>
    `;
  }

  function setMessage(msgEl, text, type) {
    if (!msgEl) return;
    msgEl.textContent = text || "";
    msgEl.className = "form-message" + (type ? " " + type : "");
  }

  function renderResults(sectionEl, infoEl, gridEl, data) {
    const results = Array.isArray(data.results) ? data.results : [];
    if (!results.length) {
      sectionEl.style.display = "block";
      infoEl.textContent = "Nu a fost gƒÉsitƒÉ nicio coinciden»õƒÉ.";
      gridEl.innerHTML = "";
      return;
    }

    const maxRows = data.maxRows || results.length;
    const count = data.count || results.length;

    infoEl.textContent =
      count >= maxRows
        ? `Primele ${count} rezultate (limitat la ${maxRows}).`
        : `Rezultate gƒÉsite: ${count}.`;

    const cardsHtml = results
      .map((item) => {
        // Updated URL construction for photo (No Photo ID, just Type 1)
        let imgHtml = `<div style="width:70px; height:85px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; border-radius:4px; border:1px solid #e2e8f0; color:#cbd5e1; font-weight:bold; font-size:1.5rem;">?</div>`;
        
        if (item.hasPhoto && item.idnp) {
            const dir1 = item.idnp.charAt(0);
            // Default to type 1 (frontal) for search result thumbnails
            const url = `/resources/photos/${dir1}/${item.idnp}/1.webp`;
            imgHtml = `<img src="${url}" onerror="this.style.display='none'" style="width:70px; height:85px; object-fit:cover; border-radius:4px; border:1px solid #cbd5e1;">`;
        }

        return `
          <article class="search-result-card">
            <div style="display:flex; gap:12px;">
                <div style="flex-shrink:0;">
                   ${imgHtml}
                </div>
                
                <div style="flex:1;">
                    <div class="result-header">
                      <span class="badge badge-status">${escapeHtml((item.statut || "").toUpperCase())}</span>
                    </div>
                    <div class="result-body">
                      <div class="row"><span class="k">IDNP</span><span class="v">${escapeHtml(item.idnp)}</span></div>
                      <div class="row"><span class="k">Nume</span><span class="v" style="font-weight:700">${escapeHtml(item.surname)}</span></div>
                      <div class="row"><span class="k">Prenume</span><span class="v">${escapeHtml(item.name)}</span></div>
                      <div class="row"><span class="k">Na»ôtere</span><span class="v">${escapeHtml(item.birth)}</span></div>
                    </div>
                </div>
            </div>
            <div class="result-footer">
              <span style="font-size:0.75rem; color:#64748b; margin-right:auto; align-self:center;">${escapeHtml(item.miscareText)}</span>
              <button type="button" class="btn-ghost btn-small" onclick="window.location.href='/app/index.html?module=detinut&id=${item.id}'">
                Detalii
              </button>
            </div>
          </article>
        `;
      })
      .join("");

    gridEl.innerHTML = cardsHtml;
    sectionEl.style.display = "block";
  }

  async function handleSubmit(ev, container) {
    ev.preventDefault();
    const form = ev.currentTarget;
    const msgEl = form.querySelector("#searchMessage");
    const submitBtn = form.querySelector('[data-role="submit"]');
    const sectionEl = container.querySelector("#searchResultsSection");
    const infoEl = container.querySelector("#searchResultsInfo");
    const gridEl = container.querySelector("#searchGrid");

    setMessage(msgEl, "", "");
    if (sectionEl) sectionEl.style.display = "none";
    if (gridEl) gridEl.innerHTML = "";

    const formData = new FormData(form);
    const payload = {
      surname: (formData.get("surname") || "").toString(),
      name: (formData.get("name") || "").toString(),
      secName: (formData.get("secName") || "").toString(),
      idnp: (formData.get("idnp") || "").toString(),
      birth: (formData.get("birth") || "").toString(),
      id: (formData.get("id") || "").toString()
    };

    const hasAny =
      payload.surname.trim() ||
      payload.name.trim() ||
      payload.secName.trim() ||
      payload.idnp.trim() ||
      payload.birth.trim() ||
      payload.id.trim();

    if (!hasAny) {
      setMessage(
        msgEl,
        "Introduce»õi cel pu»õin un criteriu de cƒÉutare.",
        "error"
      );
      return;
    }

    submitBtn.disabled = true;
    setMessage(msgEl, "Se cautƒÉ, vƒÉ rugƒÉm a»ôtepta»õi...", "");

    try {
      const data = await window.prisonApi.post(
        "/search/detinuti",
        payload
      );

      if (!data.success) {
        throw new Error(data.error || "CƒÉutarea a e»ôuat.");
      }

      renderResults(sectionEl, infoEl, gridEl, data);
      setMessage(msgEl, "", "");
    } catch (err) {
      console.error("Eroare la cƒÉutare:", err);
      setMessage(
        msgEl,
        err.message || "Eroare la comunicarea cu serverul.",
        "error"
      );
    } finally {
      submitBtn.disabled = false;
    }
  }

  window.prisonModules = window.prisonModules || {};
  window.prisonModules.cautare = {
    init({ userId, container }) {
      buildLayout(container);

      const form = container.querySelector('form[data-role="search"]');
      if (form) {
        form.addEventListener("submit", (ev) => handleSubmit(ev, container));
      }
    }
  };
})();
</file>

<file path="src/modules/search/router.js">
// src/routes/search.js
const express = require("express");
const db = require("../../db");
const router = express.Router();

router.post("/search/detinuti", async (req, res) => {
  const { surname, name, secName, idnp, birth, id } = req.body;
  const maxRows = 20;

  // Updated SQL: Check for existence of Type 1 (Frontal) photo only
  const sql = `
    SELECT *
    FROM (
      SELECT
        v.ID,
        v.IDNP,
        v.SURNAME,
        v.NAME,
        v.SEC_NAME,
        TO_CHAR(v.BIRDTH, 'DD.MM.YYYY') AS BIRDTH_STR,
        v.STATUT,
        lm.id_penetenciar AS LAST_PEN,
        lm.id_type_miscari AS LAST_TYPE,
        img.IMAGE_TYPE AS HAS_PHOTO, 
        ROW_NUMBER() OVER (ORDER BY v.SURNAME, v.NAME, v.IDNP) AS RN
      FROM PRISON.V_DETINUTI_STATUT v
      LEFT JOIN (
        SELECT idnp, id_penetenciar, id_type_miscari
        FROM (
          SELECT idnp, id_penetenciar, id_type_miscari, adate, id,
                 ROW_NUMBER() OVER (PARTITION BY idnp ORDER BY adate DESC, id DESC) AS rn
          FROM PRISON.MISCARI
        )
        WHERE rn = 1
      ) lm ON lm.idnp = v.idnp
      LEFT JOIN (
          SELECT DETINUT_ID, IMAGE_TYPE FROM PRISON.IMAGES WHERE IMAGE_TYPE = 1
      ) img ON img.DETINUT_ID = v.ID
      WHERE 1=1
        AND (:surname IS NULL OR v.SURNAME  LIKE :surname)
        AND (:name    IS NULL OR v.NAME     LIKE :name)
        AND (:secName IS NULL OR v.SEC_NAME LIKE :secName)
        AND (:idnp    IS NULL OR v.IDNP     LIKE :idnp)
        AND (:id      IS NULL OR TO_CHAR(v.ID) LIKE :id)
        AND (:birth   IS NULL OR v.BIRDTH = TO_DATE(:birth, 'DD.MM.YYYY'))
    )
    WHERE RN <= :maxRows
  `;

  const binds = {
    surname: surname ? `%${surname.toUpperCase()}%` : null,
    name: name ? `%${name.toUpperCase()}%` : null,
    secName: secName ? `%${secName.toUpperCase()}%` : null,
    idnp: idnp ? `%${idnp}%` : null,
    id: id ? `%${id}%` : null,
    birth: birth || null,
    maxRows
  };

  try {
    const result = await db.execute(sql, binds);
    const rows = result.rows || [];

    // Helper maps
    let pens = {};
    if (rows.length) {
      const pRes = await db.execute("SELECT ID, NAME FROM PRISON.SPR_PENITENCIAR");
      (pRes.rows || []).forEach((r) => (pens[r.ID] = r.NAME));
    }

    const items = rows.map((row) => {
      const penName = pens[row.LAST_PEN] || "Necunoscut";
      let miscareText = `Ultima mi»ôcare: ${penName}`;
      if (row.LAST_TYPE === 1) miscareText += " (Intrare)";
      if (row.LAST_TYPE === 2) miscareText += " (Ie»ôire)";

      return {
        id: Number(row.ID),
        idnp: String(row.IDNP || ""),
        surname: String(row.SURNAME || ""),
        name: String(row.NAME || ""),
        secName: String(row.SEC_NAME || ""),
        birth: String(row.BIRDTH_STR || ""),
        statut: String(row.STATUT || ""),
        hasPhoto: !!row.HAS_PHOTO, // Boolean flag
        miscareText
      };
    });

    res.json({
      success: true,
      maxRows,
      count: items.length,
      results: items
    });
  } catch (err) {
    console.error("Error in /api/search/detinuti:", err);
    res.status(500).json({ success: false, error: "Eroare internƒÉ la cƒÉutare." });
  }
});

module.exports = router;
</file>

<file path="src/modules/user/client.js">
// public/js/profil.js
(function () {
  function formatDate(value) {
    if (!value) return "";
    const d = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(d.getTime())) {
      return String(value);
    }
    return d.toLocaleString("ro-RO");
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  async function loadProfile(userId) {
    const data = await window.prisonApi.get(
      `/profile?userId=${encodeURIComponent(userId)}`
    );
    if (!data.success) {
      throw new Error(data.error || "Nu s-a putut √ÆncƒÉrca profilul.");
    }
    return data;
  }

  function renderProfile(container, profileData) {
    const { user, logs, permissions } = profileData;

    const logsRows =
      (logs || [])
        .map(
          (log) => `
        <tr>
          <td>${escapeHtml(log.action)}</td>
          <td>${escapeHtml(formatDate(log.date))}</td>
          <td>${escapeHtml(log.detail)}</td>
        </tr>
      `
        )
        .join("") ||
      `<tr><td colspan="3" class="table-empty">Nu existƒÉ activitate √ÆnregistratƒÉ.</td></tr>`;

    const permRows =
      (permissions || [])
        .map((p) => {
          let badgeClass = "badge-none";
          if (p.drept === "W") badgeClass = "badge-write";
          else if (p.drept === "R") badgeClass = "badge-read";

          return `
        <tr>
          <td>${escapeHtml(p.moduleName)}</td>
          <td><span class="badge ${badgeClass}">${escapeHtml(
            p.permissionLabel
          )}</span></td>
        </tr>
      `;
        })
        .join("") ||
      `<tr><td colspan="2" class="table-empty">Nu existƒÉ module definite.</td></tr>`;

    container.innerHTML = `
      <h1 class="app-title">Profil utilizator</h1>
      <p class="app-subtitle">
        Informa»õii »ôi drepturi pentru utilizatorul <strong>${escapeHtml(
          user.username
        )}</strong>.
      </p>

      <div class="profile-sections">
        <section class="profile-card">
          <h2 class="section-title">Detalii utilizator</h2>
          <div class="profile-details">
            <div class="detail-row">
              <span class="detail-label">ID utilizator</span>
              <span class="detail-value">${user.id}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Rol (ID_ROLE)</span>
              <span class="detail-value">${
                user.id_role !== null && user.id_role !== undefined
                  ? user.id_role
                  : "‚Äî"
              }</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">ID penitenciar</span>
              <span class="detail-value">${
                user.id_penitentiary !== null &&
                user.id_penitentiary !== undefined
                  ? user.id_penitentiary
                  : "‚Äî"
              }</span>
            </div>
          </div>
        </section>

        <section class="profile-card">
          <h2 class="section-title">Drepturi pe module</h2>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Modul</th>
                  <th>Drept</th>
                </tr>
              </thead>
              <tbody>
                ${permRows}
              </tbody>
            </table>
          </div>
        </section>

        <section class="profile-card">
          <h2 class="section-title">Activitate recentƒÉ (ultimele 10 √ÆnregistrƒÉri)</h2>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ac»õiune</th>
                  <th>DatƒÉ</th>
                  <th>Detalii</th>
                </tr>
              </thead>
              <tbody>
                ${logsRows}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    `;
  }

  // Register module
  window.prisonModules = window.prisonModules || {};
  window.prisonModules.profil = {
    async init({ userId, container }) {
      try {
        const data = await loadProfile(userId);
        renderProfile(container, data);
      } catch (err) {
        console.error("Eroare la profil:", err);
        container.innerHTML = `
          <h1 class="app-title">Eroare</h1>
          <p class="app-subtitle">${escapeHtml(
            err.message || "Nu s-a putut √ÆncƒÉrca profilul utilizatorului."
          )}</p>
        `;
      }
    }
  };
})();
</file>

<file path="src/modules/user/nav.router.js">
// src/routes/nav.js
const express = require("express");
const db = require("../../db");
const modulesConfig = require("../../modulesConfig");

const router = express.Router();

router.get("/nav", async (req, res) => {
  const userId = Number(req.query.userId || 0);

  if (!userId) {
    return res.status(400).json({ success: false, error: "UserId lipsƒÉ." });
  }

  try {
    // 1) Load user role
    const userSql = "SELECT ID, USERNAME, ID_ROLE FROM USERS WHERE ID = :id";
    const userResult = await db.execute(userSql, { id: userId });
    
    if (!userResult.rows || !userResult.rows.length) {
      return res.status(401).json({ success: false, error: "Utilizator invalid." });
    }

    const userRow = userResult.rows[0];
    const roleId = userRow.ID_ROLE != null ? Number(userRow.ID_ROLE) : null;

    // 2) Load permissions
    const moduleIds = modulesConfig
      .map(m => m.oracleModuleId)
      .filter(id => id != null);

    let accessMap = {};

    if (moduleIds.length > 0) {
      // Build IN clause
      const bindParams = { userId };
      const placeholders = moduleIds.map((id, idx) => {
         bindParams[`m${idx}`] = id;
         return `:m${idx}`;
      }).join(",");

      const accessSql = `SELECT ID_MODUL, DREPT FROM SPR_ACCESS WHERE ID_USER = :userId AND ID_MODUL IN (${placeholders})`;
      const accessRes = await db.execute(accessSql, bindParams);
      
      (accessRes.rows || []).forEach(row => {
        accessMap[Number(row.ID_MODUL)] = (row.DREPT || "").toUpperCase();
      });
    }

    function hasMinPermission(min, actual) {
      if (!actual) return false;
      if (min === "W") return actual === "W";
      return actual === "R" || actual === "W";
    }

    // 3) Filter allowed modules
    const allowedModules = modulesConfig
      .filter((mod) => {
        // CHANGED: We DO NOT return false here for invisible modules.
        // We only filter if the User lacks the Role or Permission.

        // Role check
        if (Array.isArray(mod.requiredRoles) && mod.requiredRoles.length > 0) {
          if (roleId === null || !mod.requiredRoles.includes(roleId)) {
            return false;
          }
        }
        
        // Permission check
        if (mod.oracleModuleId === null) return true;
        const drept = accessMap[mod.oracleModuleId];
        return hasMinPermission(mod.minPermission || "R", drept);
      })
      .map((mod) => ({
        key: mod.key,
        label: mod.label,
        path: mod.path,
        visible: mod.visible !== false // Pass visibility to frontend
      }));

    return res.json({
      success: true,
      user: {
        id: Number(userRow.ID),
        username: String(userRow.USERNAME),
        id_role: roleId
      },
      modules: allowedModules
    });

  } catch (err) {
    console.error("Nav Error:", err);
    return res.status(500).json({ success: false, error: "Eroare meniu." });
  }
});

module.exports = router;
</file>

<file path="src/modules/user/profile.router.js">
// src/routes/profile.js
const express = require("express");
const db = require("../../db");
const router = express.Router();

/**
 * GET /api/profile?userId=123
 *
 * Returns:
 *  - user info (USERS)
 *  - last 40 USER_LOGS by USERNAME
 *  - permissions for all SPR_MODULES, based on SPR_ACCESS for this user
 */
router.get("/profile", async (req, res) => {
  const userId = Number(req.query.userId || 0);
  if (!userId) {
    return res.status(400).json({
      success: false,
      error: "Parametrul userId este obligatoriu."
    });
  }

  try {
    // --- 1) User info ---
    let userRow;

    try {
      const userSql =
        "SELECT ID, USERNAME, ID_ROLE, ID_PENITENTIAR " +
        "FROM USERS " +
        "WHERE ID = :id";

      const userResult = await db.execute(userSql, { id: userId }, {});
      const userRows = userResult.rows || [];

      if (!userRows.length) {
        return res.status(404).json({
          success: false,
          error: "Utilizatorul nu a fost gƒÉsit."
        });
      }

      userRow = userRows[0];
    } catch (err) {
      console.error("USERS query failed in /api/profile:", err);
      return res.status(500).json({
        success: false,
        error: "Eroare internƒÉ la √ÆncƒÉrcarea utilizatorului."
      });
    }

    const username = String(userRow.USERNAME);

    // --- 2) Logs (last 40) ---
    let logs = [];
    try {
      const logsSql =
        "SELECT * FROM (" +
        "  SELECT USERNAME, ACTION, E_DATE, DETINUT " +
        "  FROM PRISON.USER_LOGS " +
        "  WHERE USERNAME = :u " +
        "  ORDER BY E_DATE DESC" +
        ") WHERE ROWNUM <= 10";

      const logsResult = await db.execute(logsSql, { u: username }, {});
      logs = (logsResult.rows || []).map((row) => ({
        username: String(row.USERNAME || ""),
        action: String(row.ACTION || ""),
        date: row.E_DATE,
        detail: String(row.DETINUT || "")
      }));
    } catch (err) {
      console.error("USER_LOGS query failed in /api/profile:", err);
      // logs stays []
    }

    // --- 3) Permissions (modules + SPR_ACCESS) ---
    let permissions = [];
    try {
      const permSql =
        "SELECT m.ID AS MODULE_ID, m.NAME AS MODULE_NAME, a.DREPT " +
        "FROM PRISON.SPR_MODULES m " +
        "LEFT JOIN PRISON.SPR_ACCESS a " +
        "  ON a.ID_MODUL = m.ID " +
        " AND a.ID_USER = :p_user_id " + // <--- bind name changed here
        "ORDER BY m.NAME";

      const permResult = await db.execute(permSql, { p_user_id: userId }, {});
      permissions = (permResult.rows || []).map((row) => {
        const dreptRaw = row.DREPT ? String(row.DREPT).toUpperCase() : null;
        let label = "Niciun Drept";
        if (dreptRaw === "W") label = "SCRIERE";
        else if (dreptRaw === "R") label = "Citire";

        return {
          moduleId: Number(row.MODULE_ID),
          moduleName: String(row.MODULE_NAME || ""),
          drept: dreptRaw, // 'R', 'W', null
          permissionLabel: label
        };
      });
    } catch (err) {
      console.error("SPR_MODULES/SPR_ACCESS query failed in /api/profile:", err);
      // permissions stays []
    }

    // --- 4) Successful JSON payload ---
    return res.json({
      success: true,
      user: {
        id: Number(userRow.ID),
        username,
        id_role:
          userRow.ID_ROLE !== null && userRow.ID_ROLE !== undefined
            ? Number(userRow.ID_ROLE)
            : null,
        id_penitentiary:
          userRow.ID_PENITENTIAR !== null &&
          userRow.ID_PENITENTIAR !== undefined
            ? Number(userRow.ID_PENITENTIAR)
            : null
      },
      logs,
      permissions
    });
  } catch (err) {
    console.error("Unexpected error in /api/profile:", err);
    return res.status(500).json({
      success: false,
      error: "Eroare internƒÉ la √ÆncƒÉrcarea profilului."
    });
  }
});

module.exports = router;
</file>

<file path="src/modulesConfig.js">
// src/modulesConfig.js

const modules = [
  // --- VISIBLE IN NAV ---
  {
    key: "cautare",
    label: "CƒÉutare",
    path: "/app/index.html?module=cautare",
    visible: true,
    oracleModuleId: null
  },
  {
    key: "adaugaDetinut", // <--- NEW MODULE
    label: "AdaugƒÉ De»õinut",
    path: "/app/index.html?module=adaugaDetinut",
    visible: true,
    oracleModuleId: null, 
    requiredRoles: [1, 7, 99] // Only these roles will see it
  },
  {
    key: "interogari",
    label: "Rapoarte & InterogƒÉri",
    path: "/app/index.html?module=interogari",
    visible: true,
    oracleModuleId: null, 
    requiredRoles: [7] // Only Role 7 sees this top-level item
  },
  {
    key: "profil",
    label: "Profil utilizator",
    path: "/app/index.html?module=profil",
    visible: true,
    oracleModuleId: null
  },
  {
    key: "admin",
    label: "Pagina admin",
    path: "/app/index.html?module=admin",
    visible: true,
    oracleModuleId: null,
    requiredRoles: [7]
  },
  {
    key: "detinut",
    label: "Dosar De»õinut",
    path: null,
    visible: false, 
    oracleModuleId: null,
    requiredRoles: [] 
  },
  
  { 
    key: "garantii", 
    label: "Garan»õii de Stat", 
    visible: false, 
    // You can assign a specific Module ID from SPR_MODULES if you create one in DB later.
    // For now, no specific restriction beyond general access.
    oracleModuleId: 39, 
    minPermission: "R" 
  },
  { 
    key: "rude",
    label: "Rude",
    visible: true,
    oracleModuleId: 3, 
    minPermission: "R" 
  },
  { 
    key: "complici",
    label: "Complici",
    visible: true,
    oracleModuleId: 2, 
    minPermission: "R" 
  },
  // --- HIDDEN (PROFILE / SUB-MODULES) ---
  {
    key: "detinut",
    label: "Dosar De»õinut",
    path: null,
    visible: false, 
    // IMPORTANT: Ensure no specific role is required to VIEW the base module.
    // The specific 'Edit' permissions are handled inside the module routes.
    oracleModuleId: null,
    requiredRoles: [] 
  },
  // Medical Modules (Permission Check Only)
  { key: "med_greva",   label: "Greva Foamei", visible: false, oracleModuleId: 7,  minPermission: "R" },
  { key: "med_diag",    label: "Diagnoza",     visible: false, oracleModuleId: 8,  minPermission: "R" },
  { key: "med_radio",   label: "Radiografie",  visible: false, oracleModuleId: 10, minPermission: "R" },
  { key: "med_consult", label: "Consultare",   visible: false, oracleModuleId: 11, minPermission: "R" }
];

module.exports = modules;
</file>

<file path="src/server.js">
// src/server.js
const express = require("express");
const path = require("path");
const config = require("./config");
const db = require("./db");

const app = express();
app.use(express.json());

// 1. SERVE RESOURCES (CSS, Images, Core JS)
app.use("/resources", express.static(path.join(__dirname, "..", "resources")));

// 2. SERVE PUBLIC (HTML files)
const publicDir = path.join(__dirname, "..", "public");
app.use(express.static(publicDir));

// 3. SERVE MODULE SCRIPTS (Allows <script src="/modules/...">)
app.use("/modules", express.static(path.join(__dirname, "modules")));

// 4. REGISTER API ROUTES (Modularized)
app.use("/api", require("./modules/admin/router"));
app.use("/api", require("./modules/auth/router"));
app.use("/api", require("./modules/search/router"));
app.use("/api", require("./modules/user/nav.router"));
app.use("/api", require("./modules/user/profile.router"));
app.use("/api", require("./modules/reports/router"));
app.use("/api", require("./modules/health/router"));
app.use("/api", require("./modules/detinut-add/router"));

// Inmate Modules
app.use("/api", require("./modules/inmate/profile/router"));
app.use("/api", require("./modules/inmate/medical/router"));
app.use("/api", require("./modules/inmate/garantii/router"));
app.use("/api", require("./modules/inmate/rude/router"));
app.use("/api", require("./modules/inmate/complici/router"));
app.use("/api", require("./modules/inmate/hotariri/router"));


app.get("/", (req, res) => {
  res.sendFile(path.join(publicDir, "login.html"));
});

function start() {
  console.log("Initializing DB Pool...");
  db.initPool()
    .then(() => {
      console.log("‚úÖ DB Pool Initialized.");
      app.listen(config.port, () => {
        console.log(`Server listening on http://localhost:${config.port}`);
      });
    })
    .catch((err) => {
      console.error("‚ùå Failed to init DB:", err);
      app.listen(config.port, () => {
        console.log(`Server started (Offline Mode) on http://localhost:${config.port}`);
      });
    });
}

start();
</file>

</files>
